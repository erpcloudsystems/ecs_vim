{"version":3,"file":"point-of-sale.min.js","sources":["../../../apps/erpnext/node_modules/onscan.js/onscan.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_item_selector.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_item_cart.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_item_details.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_number_pad.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_payment.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_past_order_list.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_past_order_summary.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_controller.js","../../../apps/vim/vim/selling/page/point_of_sale/pos_combo_item_details.js"],"sourcesContent":["/*\n * onScan.js - scan-events for hardware barcodes scanners in javascript\n */\n;(function (global, factory) {\n    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :\n    typeof define === 'function' && define.amd ? define(factory()) :\n    global.onScan = factory()\n}(this, (function () {\n\tvar onScan = {\t\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @param Object oOptions\n\t\t * @return self\n\t\t */\n\t\tattachTo: function(oDomElement, oOptions) {\n\t\n\t\t\tif(oDomElement.scannerDetectionData !== undefined){\n\t\t\t\tthrow new Error(\"onScan.js is already initialized for DOM element \" + oDomElement);\n\t\t\t}\n\t\n\t\t\tvar oDefaults = {\n\t\t\t\tonScan: function(sScanned, iQty){}, // Callback after detection of a successfull scanning:  function(){sScancode, iCount)}()\n\t\t\t\tonScanError: function(oDebug){}, // Callback after detection of a unsuccessfull scanning (scanned string in parameter)\n\t\t\t\tonKeyProcess: function(sChar, oEvent){}, // Callback after receiving and processing a char (scanned char in parameter)\n\t\t\t\tonKeyDetect: function(iKeyCode, oEvent){}, // Callback after detecting a keyDown (key char in parameter) - in contrast to onKeyProcess, this fires for non-character keys like tab, arrows, etc. too!\n\t\t\t\tonPaste: function(sPasted, oEvent){}, // Callback after receiving a value on paste, no matter if it is a valid code or not\n\t\t\t\tkeyCodeMapper: function(oEvent) {return onScan.decodeKeyEvent(oEvent)}, // Custom function to decode a keydown event into a character. Must return decoded character or NULL if the given event should not be processed.\n\t\t\t\tonScanButtonLongPress: function(){}, // Callback after detection of a successfull scan while the scan button was pressed and held down\n\t\t\t\tscanButtonKeyCode:false, // Key code of the scanner hardware button (if the scanner button a acts as a key itself) \n\t\t\t\tscanButtonLongPressTime:500, // How long (ms) the hardware button should be pressed, until a callback gets executed\n\t\t\t\ttimeBeforeScanTest:100, // Wait duration (ms) after keypress event to check if scanning is finished\n\t\t\t\tavgTimeByChar:30, // Average time (ms) between 2 chars. Used to do difference between keyboard typing and scanning\n\t\t\t\tminLength:6, // Minimum length for a scanning\n\t\t\t\tsuffixKeyCodes:[9,13], // Chars to remove and means end of scanning\n\t\t\t\tprefixKeyCodes:[], // Chars to remove and means start of scanning\n\t\t\t\tignoreIfFocusOn:false, // do not handle scans if the currently focused element matches this selector or object\n\t\t\t\tstopPropagation:false, // Stop immediate propagation on keypress event\n\t\t\t\tpreventDefault:false, // Prevent default action on keypress event\n\t\t\t\tcaptureEvents:false, // Get the events before any listeners deeper in the DOM\n\t\t\t\treactToKeydown:true, // look for scan input in keyboard events\n\t\t\t\treactToPaste:false, // look for scan input in paste events\n\t\t\t\tsingleScanQty: 1, // Quantity of Items put out to onScan in a single scan\n\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\toOptions = this._mergeOptions(oDefaults, oOptions);\n\t\n\t\t\t// initializing options and variables on DomElement\n\t\t\toDomElement.scannerDetectionData = {\n\t\t\t\t\toptions: oOptions,\n\t\t\t\t\tvars:{\n\t\t\t\t\t\tfirstCharTime: 0,\n\t\t\t\t\t\tlastCharTime: 0,\n\t\t\t\t\t\taccumulatedString: '',\n\t\t\t\t\t\ttestTimer: false,\n\t\t\t\t\t\tlongPressTimeStart: 0,\n\t\t\t\t\t\tlongPressed: false\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t};\n\t\t\t\n\t\t\t// initializing handlers (based on settings)\n\t\t\tif (oOptions.reactToPaste === true){\n\t\t\t\toDomElement.addEventListener(\"paste\", this._handlePaste, oOptions.captureEvents);\n\t\t\t}\n\t\t\tif (oOptions.scanButtonKeyCode !== false){\n\t\t\t\toDomElement.addEventListener(\"keyup\", this._handleKeyUp, oOptions.captureEvents);\n\t\t\t}\n\t\t\tif (oOptions.reactToKeydown === true || oOptions.scanButtonKeyCode !== false){\t\n\t\t\t\toDomElement.addEventListener(\"keydown\", this._handleKeyDown, oOptions.captureEvents);\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @return void\n\t\t */\n\t\tdetachFrom: function(oDomElement) {\n\t\t\t// detaching all used events\n\t\t\tif (oDomElement.scannerDetectionData.options.reactToPaste){\n\t\t\t\toDomElement.removeEventListener(\"paste\", this._handlePaste);\n\t\t\t}\n\t\t\tif (oDomElement.scannerDetectionData.options.scanButtonKeyCode !== false){\n\t\t\t\toDomElement.removeEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t}\n\t\t\toDomElement.removeEventListener(\"keydown\", this._handleKeyDown);\n\t\t\t\n\t\t\t// clearing data off DomElement\n\t\t\toDomElement.scannerDetectionData = undefined; \n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @return Object\n\t\t */\n\t\tgetOptions: function(oDomElement){\n\t\t\treturn oDomElement.scannerDetectionData.options;\t\t\t\n\t\t},\n\t\n\t\t/**\n\t\t * \n\t\t * @param DomElement oDomElement\n\t\t * @param Object oOptions\n\t\t * @return self\n\t\t */\n\t\tsetOptions: function(oDomElement, oOptions){\n\t\t\t// check if some handlers need to be changed based on possible option changes\n\t\t\tswitch (oDomElement.scannerDetectionData.options.reactToPaste){\n\t\t\t\tcase true: \n\t\t\t\t\tif (oOptions.reactToPaste === false){\n\t\t\t\t\t\toDomElement.removeEventListener(\"paste\", this._handlePaste);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase false:\n\t\t\t\t\tif (oOptions.reactToPaste === true){\n\t\t\t\t\t\toDomElement.addEventListener(\"paste\", this._handlePaste);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tswitch (oDomElement.scannerDetectionData.options.scanButtonKeyCode){\n\t\t\t\tcase false:\n\t\t\t\t\tif (oOptions.scanButtonKeyCode !== false){\n\t\t\t\t\t\toDomElement.addEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault: \n\t\t\t\t\tif (oOptions.scanButtonKeyCode === false){\n\t\t\t\t\t\toDomElement.removeEventListener(\"keyup\", this._handleKeyUp);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\t// merge old and new options\n\t\t\toDomElement.scannerDetectionData.options = this._mergeOptions(oDomElement.scannerDetectionData.options, oOptions);\n\t\t\n\t\t\t// reinitiallize\n\t\t\tthis._reinitialize(oDomElement);\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Transforms key codes into characters.\n\t\t * \n\t\t * By default, only the follwing key codes are taken into account\n\t\t * - 48-90 (letters and regular numbers)\n\t\t * - 96-105 (numeric keypad numbers)\n\t\t * - 106-111 (numeric keypad operations)\n\t\t * \n\t\t * All other keys will yield empty strings!\n\t\t * \n\t\t * The above keycodes will be decoded using the KeyboardEvent.key property on modern\n\t\t * browsers. On older browsers the method will fall back to String.fromCharCode()\n\t\t * putting the result to upper/lower case depending on KeyboardEvent.shiftKey if\n\t\t * it is set.\n\t\t * \n\t\t * @param KeyboardEvent oEvent\n\t\t * @return string\n\t\t */\n\t\tdecodeKeyEvent : function (oEvent) {\n\t\t\tvar iCode = this._getNormalizedKeyNum(oEvent);\n\t\t\tswitch (true) {\n\t\t\t\tcase iCode >= 48 && iCode <= 90: // numbers and letters\n\t\t\t\tcase iCode >= 106 && iCode <= 111: // operations on numeric keypad (+, -, etc.)\n\t\t\t\t\tif (oEvent.key !== undefined && oEvent.key !== '') {\n\t\t\t\t\t\treturn oEvent.key;\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\tvar sDecoded = String.fromCharCode(iCode);\n\t\t\t\t\tswitch (oEvent.shiftKey) {\n\t\t\t\t\t\tcase false: sDecoded = sDecoded.toLowerCase(); break;\n\t\t\t\t\t\tcase true: sDecoded = sDecoded.toUpperCase(); break;\n\t\t\t\t\t}\n\t\t\t\t\treturn sDecoded;\n\t\t\t\tcase iCode >= 96 && iCode <= 105: // numbers on numeric keypad\n\t\t\t\t\treturn 0+(iCode-96);\n\t\t\t}\n\t\t\treturn '';\n\t\t},\n\t\t\n\t\t/**\n\t\t * Simulates a scan of the provided code.\n\t     *\n\t\t * The scan code can be defined as\n\t\t * - a string - in this case no keyCode decoding is done and the code is merely validated\n\t\t * against constraints like minLenght, etc.\n\t\t * - an array of keyCodes (e.g. `[70,71,80]`) - will produce `keydown` events with corresponding\n\t\t * `keyCode` properties. NOTE: these events will have empty `key` properties, so decoding may\n\t\t * yield different results than with native events.\n\t\t * - an array of objects (e.g. `[{keyCode: 70, key: \"F\", shiftKey: true}, {keyCode: 71, key: \"g\"}]`) -\n\t\t * this way almost any event can be simulated, but it's a lot of work to do.\n\t\t *\n\t\t * @param DomElement oDomElement\n\t\t * @param string|array mStringOrArray\n\t\t * @return self\n\t\t */\n\t\tsimulate: function(oDomElement, mStringOrArray){\n\t\t\tthis._reinitialize(oDomElement);\n\t\t\tif (Array.isArray(mStringOrArray)){\n\t\t\t\tmStringOrArray.forEach(function(mKey){\n\t\t\t\t\tvar oEventProps = {};\n\t\t\t\t\tif( (typeof mKey === \"object\" || typeof mKey === 'function') && (mKey !== null) ) {\n\t\t\t\t\t\toEventProps = mKey;\n\t\t\t\t\t} else {\n\t\t\t\t\t\toEventProps.keyCode = parseInt(mKey);\n\t\t\t\t\t}\n\t\t\t\t\tvar oEvent = new KeyboardEvent('keydown', oEventProps);\n\t\t\t\t\tdocument.dispatchEvent(oEvent);\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis._validateScanCode(oDomElement, mStringOrArray);\n\t\t\t}\n\t\t\treturn this;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param DomElement oDomElement\n\t\t * @return void\n\t\t */\n\t\t_reinitialize: function(oDomElement){\n\t\t\tvar oVars = oDomElement.scannerDetectionData.vars;\n\t\t\toVars.firstCharTime = 0;\n\t\t\toVars.lastCharTime = 0;\n\t\t\toVars.accumulatedString = '';\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param DomElement oDomElement\n\t     * @return boolean\n\t\t */\n\t\t_isFocusOnIgnoredElement: function(oDomElement){\n\t\t\t\n\t\t\tvar ignoreSelectors = oDomElement.scannerDetectionData.options.ignoreIfFocusOn;\n\t\n\t        if(!ignoreSelectors){\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\n\t\t\tvar oFocused = document.activeElement;\n\t\t\t\n\t\t\t// checks if ignored element is an array, and if so it checks if one of the elements of it is an active one\n\t\t\tif (Array.isArray(ignoreSelectors)){\n\t\t\t\tfor(var i=0; i<ignoreSelectors.length; i++){\n\t\t\t\t\tif(oFocused.matches(ignoreSelectors[i]) === true){\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t// if the option consists of an single element, it only checks this one\n\t\t\t} else if (oFocused.matches(ignoreSelectors)){\n\t\t\t\treturn true;\t\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t// if the active element is not listed in the ignoreIfFocusOn option, return false\n\t\t    return false;\n\t    },\n\t\t\n\t    /**\n\t     * Validates the scan code accumulated by the given DOM element and fires the respective events.\n\t     * \n\t     * @private\n\t     * @param DomElement oDomElement\n\t     * @return boolean\n\t     */\n\t\t_validateScanCode: function(oDomElement, sScanCode){\n\t\t\tvar oScannerData = oDomElement.scannerDetectionData;\t\t\t\n\t\t\tvar oOptions = oScannerData.options;\n\t\t\tvar iSingleScanQty = oScannerData.options.singleScanQty;\n\t\t\tvar iFirstCharTime = oScannerData.vars.firstCharTime;\n\t\t\tvar iLastCharTime = oScannerData.vars.lastCharTime;\n\t\t\tvar oScanError = {};\n\t        var oEvent;\n\t        \n\t\t\tswitch(true){\n\t\t\t\t\n\t\t\t\t// detect codes that are too short\n\t\t\t\tcase (sScanCode.length < oOptions.minLength):\n\t\t\t\t\toScanError = {\n\t\t\t\t\t\tmessage: \"Receieved code is shorter then minimal length\"\n\t\t\t\t\t};\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// detect codes that were entered too slow\t\n\t\t\t\tcase ((iLastCharTime - iFirstCharTime) > (sScanCode.length * oOptions.avgTimeByChar)):\n\t\t\t\t\toScanError = {\n\t\t\t\t\t\tmessage: \"Receieved code was not entered in time\"\n\t\t\t\t\t};\t\t\t\t\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// if a code was not filtered out earlier it is valid\t\n\t\t\t\tdefault:\n\t\t\t\t\toOptions.onScan.call(oDomElement, sScanCode, iSingleScanQty);\n\t\t\t\t\toEvent = new CustomEvent(\n\t\t\t\t\t\t'scan',\n\t\t\t\t\t\t{\t\n\t\t\t\t\t\t\tdetail: { \n\t\t\t\t\t\t\t\tscanCode: sScanCode,\n\t\t\t\t\t\t\t\tqty: iSingleScanQty\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t\toDomElement.dispatchEvent(oEvent);\n\t\t\t\t\tonScan._reinitialize(oDomElement);\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t\t\n\t\t\t// If an error occurred (otherwise the method would return earlier) create an object for errordetection\n\t\t\toScanError.scanCode = sScanCode;\n\t\t\toScanError.scanDuration = iLastCharTime - iFirstCharTime;\n\t\t\toScanError.avgTimeByChar = oOptions.avgTimeByChar;\n\t\t\toScanError.minLength = oOptions.minLength;\n\t\t\t\n\t\t\toOptions.onScanError.call(oDomElement, oScanError);\n\t\t\t\n\t\t\toEvent = new CustomEvent(\n\t\t\t\t'scanError', \n\t\t\t\t{detail: oScanError}\n\t\t\t);\n\t\t\toDomElement.dispatchEvent(oEvent);\n\t\t\t\n\t\t\tonScan._reinitialize(oDomElement);\n\t\t\treturn false;\n\t    },\n\t\n\t    /**\n\t     * @private\n\t     * @param Object oDefaults\n\t     * @param Object oOptions\n\t     * @return Object\n\t     */\n\t\t_mergeOptions: function(oDefaults, oOptions){\n\t\t\tvar oExtended = {};\n\t\t\tvar prop;\n\t\t\tfor (prop in oDefaults){\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(oDefaults, prop)){\n\t\t\t\t\toExtended[prop] = oDefaults[prop];\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t\tfor (prop in oOptions){\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(oOptions, prop)){\n\t\t\t\t\toExtended[prop] = oOptions[prop];\n\t\t\t\t}\n\t\t\t}\t\t\t\n\t\t\treturn oExtended;\n\t\t},\n\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return int\n\t\t * @see https://www.w3schools.com/jsref/event_key_keycode.asp\n\t\t */\n\t\t_getNormalizedKeyNum: function(e){\n\t\t\treturn e.which || e.keyCode;\n\t\t},\n\t\n\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return void\n\t\t */\n\t\t_handleKeyDown: function(e){\n\t\t\tvar iKeyCode = onScan._getNormalizedKeyNum(e);\n\t\t\tvar oOptions = this.scannerDetectionData.options;\n\t\t\tvar oVars = this.scannerDetectionData.vars;\n\t\t\tvar bScanFinished = false;\n\t\t\t\n\t\t\tif (oOptions.onKeyDetect.call(this, iKeyCode, e) === false) {\n\t\t\t\treturn;\n\t\t\t}\t\t\n\t\t\t\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\t\t\t\n\t        // If it's just the button of the scanner, ignore it and wait for the real input\n\t\t    if(oOptions.scanButtonKeyCode !== false && iKeyCode==oOptions.scanButtonKeyCode) {\n\t\t\t\t\n\t\t\t\t// if the button was first pressed, start a timeout for the callback, which gets interrupted if the scanbutton gets released\n\t\t\t\tif (!oVars.longPressed){\n\t\t\t\t\toVars.longPressTimer = setTimeout( oOptions.onScanButtonLongPress, oOptions.scanButtonLongPressTime, this);\n\t\t\t\t\toVars.longPressed = true;\n\t\t\t\t}\n\t\n\t\t\t\treturn;\n\t        }\n\t\t\t\n\t\t\tswitch(true){\n\t\t\t\t// If it's not the first character and we encounter a terminating character, trigger scan process\n\t\t\t\tcase (oVars.firstCharTime && oOptions.suffixKeyCodes.indexOf(iKeyCode)!==-1):\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\tbScanFinished=true;\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// If it's the first character and we encountered one of the starting characters, don't process the scan\t\n\t\t\t\tcase (!oVars.firstCharTime && oOptions.prefixKeyCodes.indexOf(iKeyCode)!==-1):\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\tbScanFinished=false;\n\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t// Otherwise, just add the character to the scan string we're building\t\n\t\t\t\tdefault:\n\t\t\t\t\tvar character = oOptions.keyCodeMapper.call(this, e);\n\t\t\t\t\tif (character === null){\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toVars.accumulatedString += character;\n\t\t\t\t\t\n\t\t\t\t\tif (oOptions.preventDefault) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t\tif (oOptions.stopPropagation) {\n\t\t\t\t\t\te.stopImmediatePropagation();\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tbScanFinished=false;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t        \n\t\t\tif(!oVars.firstCharTime){\n\t\t\t\toVars.firstCharTime=Date.now();\n\t\t\t}\n\t\t\t\n\t\t\toVars.lastCharTime=Date.now();\n\t\n\t\t\tif(oVars.testTimer){ \n\t\t\t\tclearTimeout(oVars.testTimer);\n\t\t\t}\n\t\t\t\n\t\t\tif(bScanFinished){\n\t\t\t\tonScan._validateScanCode(this, oVars.accumulatedString);\n\t\t\t\toVars.testTimer=false;\n\t\t\t} else {\n\t\t\t\toVars.testTimer=setTimeout(onScan._validateScanCode, oOptions.timeBeforeScanTest, this, oVars.accumulatedString);\n\t\t\t}\n\t\n\t\t\toOptions.onKeyProcess.call(this, character, e);\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param Event e\n\t\t * @return void\n\t\t */\n\t\t_handlePaste: function(e){\n\t\n\t\t\tvar oOptions = this.scannerDetectionData.options;\n\t\t\tvar oVars = this.scannerDetectionData.vars;\n\t\t\tvar sPasteString = (event.clipboardData || window.clipboardData).getData('text');\n\t\t\t\n\t\t\t// if the focus is on an ignored element, abort\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\te.preventDefault();\n\n\t\t\tif (oOptions.stopPropagation) {\n\t\t\t\te.stopImmediatePropagation();\n\t\t\t}\n\t\t\t\t\t\t\n\t\t\toOptions.onPaste.call(this, sPasteString, event);\n\t\t\t\n\t\t\toVars.firstCharTime = 0;\n\t\t\toVars.lastCharTime = 0;\n\t\t\t\n\t\t\t// validate the string\n\t\t\tonScan._validateScanCode(this, sPasteString);\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * @private\n\t\t * @param KeyboardEvent e\n\t\t * @return void\n\t\t */\n\t\t_handleKeyUp: function(e){\n\t\t\t// if the focus is on an ignored element, abort\n\t\t\tif (onScan._isFocusOnIgnoredElement(this)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tvar iKeyCode = onScan._getNormalizedKeyNum(e);\n\t\t\t\n\t\t\t// if hardware key is not being pressed anymore stop the timeout and reset\n\t\t\tif (iKeyCode == this.scannerDetectionData.options.scanButtonKeyCode){\n\t\t\t\tclearTimeout(this.scannerDetectionData.vars.longPressTimer);\n\t\t\t\tthis.scannerDetectionData.vars.longPressed = false;\n\t\t\t}\n\t\t\treturn;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Returns TRUE the scanner is currently in the middle of a scan sequence.\n\t\t * \n\t\t * @param DomElement\n\t\t * @return boolean\n\t\t */\n\t\tisScanInProgressFor: function(oDomElement) {\n\t\t\treturn oDomElement.scannerDetectionData.vars.firstCharTime > 0;\n\t\t},\n\t\t\n\t\t/**\n\t\t * Returns TRUE if onScan is attached to the given DOM element and FALSE otherwise.\n\t\t * \n\t\t * @param DomElement\n\t\t * @return boolean\n\t\t */\n\t\tisAttachedTo: function(oDomElement) {\n\t\t\treturn (oDomElement.scannerDetectionData !== undefined);\n\t\t}\n\t};\n\t\n\treturn onScan;\n})));","import onScan from 'onscan.js';\r\n\r\nerpnext.PointOfSale.ItemSelector = class {\r\n\t// eslint-disable-next-line no-unused-vars\r\n\tconstructor({ frm, wrapper, events, pos_profile, settings }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\r\n\t\tthis.pos_profile = pos_profile;\r\n\t\tthis.hide_images = settings.hide_images;\r\n\t\tthis.auto_add_item = settings.auto_add_item_to_cart;\r\n        this.minimum_sales_quantity=0;\r\n        this.maximum_sales_quantity=0;\r\n        this.bundle_item=undefined;\r\n\t\tthis.inti_component();\r\n\t}\r\n\r\n\tinti_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.make_search_bar();\r\n\t\tthis.load_items_data();\r\n\t\tthis.bind_events();\r\n\t\tthis.attach_shortcuts();\r\n        this.get_item_group();     \r\n\r\n\t\t\r\n\t}\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`  <section class=\"items-selector\">\r\n            <div class=\"pos-item-category search-item-group\" style=\"background:grey;height:100%;width:10%;position:absolute;\">\r\n\t\t\t\t\t\t\t<ul class=\"pos-item-cat dropdown-menu\" style=\" display: block;\r\n                            position: unset;\r\n                            min-width: unset;\r\n                            min-height: 100%;\r\n                            width: 100%;\r\n                            background-color: #485663;\r\n                            color: #e6e6e6;\r\n                            overflow: hidden;\r\n                            margin: 0px;\"></ul>\r\n\t\t\t\t\t\t\t<ul class=\"pos-item-sub-cat dropdown-sub-menu\" style=\" \r\n\t\t\t\t\t\t\tdisplay: none;\r\n                            position: unset;\r\n                            min-width: unset;\r\n                            min-height: 100%;\r\n                            width: 50%;\r\n                            background-color:#rgb(99 128 155);\r\n                            color: #e6e6e6;\r\n                            overflow: hidden;\r\n                            margin: 0px;\"></ul>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\r\n            \r\n                 <div class=\"filter-section\" style=\"width:80%;align-self:flex-end;\">\r\n                     <div class=\"label\" style=\"display:none;\">All Items</div>\r\n\t\t\t\t\t <div class=\"item-group-field\"></div>\r\n                     <div class=\"search-field\"></div>\r\n\t\t\t\t\t <div class=\"pagination\"></div>\r\n                     \r\n                 </div>\r\n\t\t\t\t\r\n                 <div class=\"items-container\" style=\"width:80%;align-self:flex-end;\"></div>\r\n               \r\n             </section>`\r\n\t\t);\r\n\t\tthis.$component = this.wrapper.find('.items-selector');\r\n\t\tthis.$items_container = this.$component.find('.items-container');\r\n\t\tthis.$component.find('.filter-section').css({'padding':'','padding-left':'35px','padding-bottom':''})\r\n\t\tthis.$component.find('.pagination').css({\r\n\t\t\t\r\n\t\t\t'padding': '10px 0px 0px 0px',\r\n\t\t\t'margin': '0px 0px 10px 0px',\r\n\t\t\t'width': '80%',\r\n    \t\t'align-self': 'flex-end'\r\n\t\t})\r\n\t\tthis.$component.css('height','90vh')\r\n\t\tthis.search_item_group = this.wrapper.find('.search-item-group');\r\n\t\tthis.search_item_group.find('.dropdown-sub-menu').css({\r\n\t\t\t\r\n\t\t\t'padding': '4px',\r\n    'font-size': 'var(--text-md)',\r\n    'max-height': '500px'\r\n\r\n\t\t})\r\n\t}\r\n\t\r\n\tasync load_items_data() {\r\n\t\tif (!this.item_group) {\r\n\t\t\tconst res = await frappe.db.get_value(\"Item Group\", {lft: 1, is_group: 1}, \"name\");\r\n\t\t\tthis.parent_item_group = res.message.name;\r\n\t\t}\r\n        \r\n\t\tif (!this.price_list) {\r\n\t\t\tconst res = await frappe.db.get_value(\"POS Profile\", this.pos_profile, \"selling_price_list\");\r\n\t\t\tthis.price_list = res.message.selling_price_list;\r\n\t\t}\r\n\r\n\t\tthis.get_items({}).then(({message}) => {\r\n\t\t\tthis.render_item_list(message.items);\r\n\t\t\tthis.pagination();\r\n\t\t});\r\n\t}\r\n\r\n\tget_items({start = 0, page_length = 40, search_value=''}) {\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst price_list = (doc && doc.selling_price_list) || this.price_list;\r\n\t\tlet { item_group, pos_profile } = this;\r\n       \r\n\t\t!item_group && (item_group = this.parent_item_group);\r\n        if(price_list)\r\n        {\r\n            return frappe.call({\r\n                method: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_pos_items\",\r\n                freeze: true,\r\n                args: { start, page_length, price_list, item_group, search_value, pos_profile },\r\n            });\r\n        }\r\n\t\t\r\n\t}\r\n\r\n\r\n\trender_item_list(items) {\r\n\t\tthis.$items_container.html('');\r\n        \r\n\t\t\r\n\t\titems.forEach(item => {\r\n\t\t\tconst item_html = this.get_item_html(item);\r\n\t\t\tthis.$items_container.append(item_html);\r\n\t\t});\r\n\t}\r\n\r\n\tget_item_html(item) {\r\n\t\tconst me = this;\r\n\t\t// eslint-disable-next-line no-unused-vars\r\n\t\tconst { item_image, serial_no, batch_no, barcode, actual_qty, stock_uom,warehouse_reorder_level } = item;\r\n\t\tif(warehouse_reorder_level){\r\n            var indicator_color_=actual_qty > warehouse_reorder_level ? \"green\" : actual_qty <= (warehouse_reorder_level *50/100) ? \"orange\" : \"orange\";\r\n        }\r\n        else{\r\n\r\n        var  indicator_color_ = actual_qty > 10 ? \"green\" : actual_qty <= 0 ? \"red\" : \"orange\";\r\n        \r\n            \r\n           \r\n        }\r\n        const indicator_color =indicator_color_\r\n\t\tlet qty_to_display = actual_qty;\r\n\r\n\t\tif (Math.round(qty_to_display) > 999) {\r\n\t\t\tqty_to_display = Math.round(qty_to_display)/1000;\r\n\t\t\tqty_to_display = qty_to_display.toFixed(1) + 'K';\r\n\t\t}\r\n        // if (Math.round(qty_to_display) < 0) {\r\n\t\t// \tqty_to_display = '';\r\n\t\t\t\r\n\t\t// }\r\n\r\n\t\tfunction get_item_image_html() {\r\n\t\t\tif (!me.hide_images && item_image) {\r\n\t\t\t\treturn `<div class=\"item-qty-pill\">\r\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100\">\r\n\t\t\t\t\t\t\t<img class=\"h-full\" src=\"${item_image}\" alt=\"${frappe.get_abbr(item.item_name)}\" style=\"object-fit: cover;height:135px;\">\r\n\t\t\t\t\t\t</div>`;\r\n\t\t\t} else {\r\n\t\t\t\treturn `<div class=\"item-qty-pill\">\r\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"item-display abbr\">${frappe.get_abbr(item.item_name)}</div>`;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.$component.find('.item-rate').css({\r\n\t\t\t'background-color': '#0799a3bd'\r\n\t\t})\r\n\t\treturn (\r\n\t\t\t`<div class=\"item-wrapper\"\r\n\t\t\t\tdata-item-code=\"${escape(item.item_code)}\" data-serial-no=\"${escape(serial_no)}\"\r\n\t\t\t\tdata-batch-no=\"${escape(batch_no)}\" data-uom=\"${escape(stock_uom)}\" data-item-rate=\"${escape(item.price_list_rate)}\"\r\n\t\t\t\ttitle=\"${item.item_name}\"\r\n                data-minimum-sales-qty=\"${escape(item.minimum_sales_quantity)}\"\r\n                data-maximum-sales-qty=\"${escape(item.maximum_sales_quantity)}\"\r\n                data-bundle-item=\"${escape(item.bundle_item)}\">\r\n\r\n\t\t\t\t${get_item_image_html()}\r\n\r\n\t\t\t\t<div class=\"item-detail\">\r\n\t\t\t\t\t<div class=\"item-name\">\r\n\t\t\t\t\t\t${frappe.ellipsis(item.item_name, 18)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"item-rate\">${format_currency(item.price_list_rate, item.currency,2) || 0}</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>`\r\n\t\t);\r\n\t\t\r\n\t\t\r\n\t}\r\n\r\n\tmake_search_bar() {\r\n\t\tconst me = this;\r\n\t\tconst doc = me.events.get_frm().doc;\r\n\t\tthis.$component.find('.search-field').html('');\r\n\t\tthis.$component.find('.item-group-field').html('');\r\n\t\tthis.$component.find('.search-field').css({\r\n\t\t\t'grid-column': 'span 5/span 5',\r\n\t\t\t'width':'200px'\r\n\r\n\t\t})\r\n\t\t\r\n\t\tthis.search_field = frappe.ui.form.make_control({\r\n\t\t\tdf: {\r\n\t\t\t\tlabel: __('Search'),\r\n\t\t\t\tfieldtype: 'Data',\r\n\t\t\t\tplaceholder: __('Search by item code, serial number or barcode')\r\n\t\t\t},\r\n\t\t\tparent: this.$component.find('.search-field'),\r\n\t\t\trender_input: true,\r\n\t\t});\r\n\t\tthis.item_group_field = frappe.ui.form.make_control({\r\n\t\t\tdf: {\r\n\t\t\t\tlabel: __('Item Group'),\r\n\t\t\t\tfieldtype: 'Link',\r\n\t\t\t\toptions: 'Item Group',\r\n\t\t\t\tplaceholder: __('Select item group'),\r\n\t\t\t\tonchange: function() {\r\n\t\t\t\t\tme.item_group = this.value;\r\n\t\t\t\t\t!me.item_group && (me.item_group = me.parent_item_group);\r\n\t\t\t\t\tme.filter_items();\r\n\t\t\t\t},\r\n\t\t\t\tget_query: function () {\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tquery: 'erpnext.selling.page.point_of_sale.point_of_sale.item_group_query',\r\n\t\t\t\t\t\tfilters: {\r\n\t\t\t\t\t\t\tpos_profile: doc ? doc.pos_profile : ''\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tparent: this.$component.find('.item-group-field'),\r\n\t\t\trender_input: true,\r\n\t\t});\r\n\t\t// this.search_field.toggle_label(false);\r\n\t\t// this.item_group_field.toggle_label(false);\r\n\t}\r\n\r\n\tset_search_value(value) {\r\n\t\t$(this.search_field.$input[0]).val(value).trigger(\"input\");\r\n\t}\r\n\r\n\tbind_events() {\r\n\t\tconst me = this;\r\n\t\twindow.onScan = onScan;\r\n\r\n\t\tonScan.decodeKeyEvent = function (oEvent) {\r\n\t\t\tvar iCode = this._getNormalizedKeyNum(oEvent);\r\n\t\t\tswitch (true) {\r\n\t\t\t\tcase iCode >= 48 && iCode <= 90: // numbers and letters\r\n\t\t\t\tcase iCode >= 106 && iCode <= 111: // operations on numeric keypad (+, -, etc.)\r\n\t\t\t\tcase (iCode >= 160 && iCode <= 164) || iCode == 170: // ^ ! # $ *\r\n\t\t\t\tcase iCode >= 186 && iCode <= 194: // (; = , - . / `)\r\n\t\t\t\tcase iCode >= 219 && iCode <= 222: // ([ \\ ] ')\r\n\t\t\t\tcase iCode == 32: // spacebar\r\n\t\t\t\t\tif (oEvent.key !== undefined && oEvent.key !== '') {\r\n\t\t\t\t\t\treturn oEvent.key;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar sDecoded = String.fromCharCode(iCode);\r\n\t\t\t\t\tswitch (oEvent.shiftKey) {\r\n\t\t\t\t\t\tcase false: sDecoded = sDecoded.toLowerCase(); break;\r\n\t\t\t\t\t\tcase true: sDecoded = sDecoded.toUpperCase(); break;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn sDecoded;\r\n\t\t\t\tcase iCode >= 96 && iCode <= 105: // numbers on numeric keypad\r\n\t\t\t\t\treturn 0 + (iCode - 96);\r\n\t\t\t}\r\n\t\t\treturn '';\r\n\t\t};\r\n\r\n\t\tonScan.attachTo(document, {\r\n\t\t\tonScan: (sScancode) => {\r\n\t\t\t\tif (this.search_field && this.$component.is(':visible')) {\r\n\t\t\t\t\tthis.search_field.set_focus();\r\n\t\t\t\t\tthis.set_search_value(sScancode);\r\n\t\t\t\t\tthis.barcode_scanned = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.$component.on('click', '.item-wrapper', function() {\r\n\t\t\t\r\n\t\t\tconst $item = $(this);\r\n           \r\n\t\t\tconst item_code = unescape($item.attr('data-item-code'));\r\n\t\t\tlet batch_no = unescape($item.attr('data-batch-no'));\r\n\t\t\tlet serial_no = unescape($item.attr('data-serial-no'));\r\n\t\t\tlet uom = unescape($item.attr('data-uom'));\r\n            let rate=unescape($item.attr('data-item-rate'));\r\n            const minimum_sales_quantity=unescape($item.attr('data-minimum-sales-qty'));\r\n            const maximum_sales_quantity=unescape($item.attr('data-maximum-sales-qty'));\r\n\t\t\tvar bundle_item=unescape($item.attr('data-bundle-item'));\r\n\t\t\tcur_pos.item_selector.minimum_sales_quantity=minimum_sales_quantity;\r\n             cur_pos.item_selector.maximum_sales_quantity=maximum_sales_quantity;\r\n\t\t\t cur_pos.item_selector.bundle_item=bundle_item;\r\n            // console.log(this.minimum_sales_quantity,this.maximum_sales_quantity,\"this.maximum_sales_quantity\")\r\n            console.log(unescape($item.attr('data-item-rate')),\"ITM\")\r\n\t\t\t// escape(undefined) returns \"undefined\" then unescape returns \"undefined\"\r\n\t\t\tbatch_no = batch_no === \"undefined\" ? undefined : batch_no;\r\n\t\t\tserial_no = serial_no === \"undefined\" ? undefined : serial_no;\r\n\t\t\tuom = uom === \"undefined\" ? undefined : uom;\r\n\t\t\t// if(minimum_sales_quantity && minimum_sales_quantity>0)\r\n            //     {\r\n                 \r\n            //         const maximum_sales_quantity=unescape($item.attr('data-minimum-sales-qty'));\r\n            //         me.events.item_selected({ field: 'qty',value: minimum_sales_quantity, item: { item_code, batch_no, serial_no, uom }});\r\n            //     }\r\n            //     else{\r\n\t\t\t\t\t\r\n            //         me.events.item_selected({ field: 'qty', value: \"+1\", item: { item_code, batch_no, serial_no, uom }});\r\n            //     }\r\n           \r\n\t\t\t\tif(minimum_sales_quantity && minimum_sales_quantity>0)\r\n                {\r\n                 \r\n                    const maximum_sales_quantity=unescape($item.attr('data-minimum-sales-qty'));\r\n\t\t\t\t\t//frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\r\n                \r\n                    if(cur_pos.item_selector.bundle_item && cur_pos.item_selector.bundle_item!='' && cur_pos.item_selector.bundle_item!='null' && cur_pos.item_selector.bundle_item!='undefined' && cur_pos.item_selector.bundle_item!=0)  {\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\tbundle_item=1\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tme.events.bundle_item_selected({ field: 'qty',value: minimum_sales_quantity, item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\r\n                                const event = {\r\n                                    field: \"qty\",\r\n\t\t\t\t\t\t\t\t\tvalue:minimum_sales_quantity,\r\n                                    item: { item_code, batch_no, uom }\r\n                                }\r\n                                 \r\n                                 setTimeout(() => {\r\n                                 \r\n                                 cur_frm.doc.items.forEach(item => {\r\n\r\n                                    cur_pos.cart.update_item_html(item);\r\n                                });\r\n                                 \r\n                                }, 800);\r\n                                \r\n                        })\r\n\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\tbundle_item=0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tme.events.item_selected({ field: 'qty',value: minimum_sales_quantity, item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\r\n                                const event = {\r\n                                    field: \"qty\",\r\n\t\t\t\t\t\t\t\t\tvalue:minimum_sales_quantity,\r\n                                    item: { item_code, batch_no, uom }\r\n                                }\r\n                                 \r\n                                 setTimeout(() => {\r\n                                 \r\n                                 cur_frm.doc.items.forEach(item => {\r\n\r\n                                    cur_pos.cart.update_item_html(item);\r\n                                });\r\n                                 \r\n                                }, 800);\r\n                                \r\n                        })\r\n                                \r\n                           \r\n\t\t\t\t\t\t}\r\n\t\t\r\n\t\t\t\t\t//})\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n                }\r\n                else{\r\n\t\t\t\t\t//frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\r\n                \r\n                    if(cur_pos.item_selector.bundle_item && cur_pos.item_selector.bundle_item!='' && cur_pos.item_selector.bundle_item!='null' && cur_pos.item_selector.bundle_item!='undefined' && cur_pos.item_selector.bundle_item!=0)  {\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\tbundle_item=1\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tme.events.bundle_item_selected({ field: 'qty', value: \"+1\", item: { item_code, batch_no, serial_no, uom,rate }})\r\n\t\t\t\t\t\t\t.then(() => {\r\n                                const event = {\r\n                                    field: \"qty\",\r\n                                    value:\"+1\",\r\n                                    item: { item_code, batch_no, uom }\r\n                                }\r\n                                 \r\n                                 setTimeout(() => {\r\n                                 \r\n                                 cur_frm.doc.items.forEach(item => {\r\n\r\n                                    cur_pos.cart.update_item_html(item);\r\n                                });\r\n                                 \r\n                                }, 800);\r\n                                \r\n                        })\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\tbundle_item=0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tme.events.item_selected({ field: 'qty', value: \"+1\", item: { item_code, batch_no, serial_no, uom ,rate}})\r\n                            .then(() => {\r\n                                const event = {\r\n                                    field: \"qty\",\r\n                                    value:\"+1\",\r\n                                    item: { item_code, batch_no, uom }\r\n                                }\r\n                                 \r\n                                 setTimeout(() => {\r\n                                \r\n                                 cur_frm.doc.items.forEach(item => {\r\n\r\n                                    cur_pos.cart.update_item_html(item);\r\n                                });\r\n                                 \r\n                                }, 800);\r\n                                \r\n                        })\r\n\t\t\t\t\t\t}\r\n\t\t\r\n\t\t\t\t\t//})\r\n                    \r\n                }\r\n               \r\n            me.set_search_value('');\r\n           \r\n\t\t\t})\r\n\r\n\t\t\r\n\t\t//});\r\n       \r\n\t\tthis.search_field.$input.on('input', (e) => {\r\n\t\t\tclearTimeout(this.last_search);\r\n\t\t\tthis.last_search = setTimeout(() => {\r\n\t\t\t\tconst search_term = e.target.value;\r\n\t\t\t\tthis.filter_items({ search_term });\r\n\t\t\t}, 300);\r\n\t\t});\r\n\t}\r\n\t\r\n\tattach_shortcuts() {\r\n\t\tconst ctrl_label = frappe.utils.is_mac() ? 'âŒ˜' : 'Ctrl';\r\n\t\tthis.search_field.parent.attr(\"title\", `${ctrl_label}+I`);\r\n\t\tfrappe.ui.keys.add_shortcut({\r\n\t\t\tshortcut: \"ctrl+i\",\r\n\t\t\taction: () => this.search_field.set_focus(),\r\n\t\t\tcondition: () => this.$component.is(':visible'),\r\n\t\t\tdescription: __(\"Focus on search input\"),\r\n\t\t\tignore_inputs: true,\r\n\t\t\tpage: cur_page.page.page\r\n\t\t});\r\n\t\tthis.item_group_field.parent.attr(\"title\", `${ctrl_label}+G`);\r\n\t\tfrappe.ui.keys.add_shortcut({\r\n\t\t\tshortcut: \"ctrl+g\",\r\n\t\t\taction: () => this.item_group_field.set_focus(),\r\n\t\t\tcondition: () => this.$component.is(':visible'),\r\n\t\t\tdescription: __(\"Focus on Item Group filter\"),\r\n\t\t\tignore_inputs: true,\r\n\t\t\tpage: cur_page.page.page\r\n\t\t});\r\n\r\n\t\t// for selecting the last filtered item on search\r\n\t\tfrappe.ui.keys.on(\"enter\", () => {\r\n\t\t\tconst selector_is_visible = this.$component.is(':visible');\r\n\t\t\tif (!selector_is_visible || this.search_field.get_value() === \"\") return;\r\n\r\n\t\t\tif (this.items.length == 1) {\r\n\t\t\t\tthis.$items_container.find(\".item-wrapper\").click();\r\n\t\t\t\tfrappe.utils.play_sound(\"submit\");\r\n\t\t\t\t$(this.search_field.$input[0]).val(\"\").trigger(\"input\");\r\n\t\t\t} else if (this.items.length == 0 && this.barcode_scanned) {\r\n\t\t\t\t// only show alert of barcode is scanned and enter is pressed\r\n\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\tmessage: __(\"No items found. Scan barcode again.\"),\r\n\t\t\t\t\tindicator: 'orange'\r\n\t\t\t\t});\r\n\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\tthis.barcode_scanned = false;\r\n\t\t\t\t$(this.search_field.$input[0]).val(\"\").trigger(\"input\");\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfilter_items({ search_term='' }={}) {\r\n       \r\n\t\t\r\n\t\t\tsearch_term = search_term.toLowerCase();\r\n\r\n\t\t\t// memoize\r\n\t\t\tthis.search_index = this.search_index || {};\r\n\t\t\tif (this.search_index[search_term]) {\r\n\t\t\t\tconst items = this.search_index[search_term];\r\n\t\t\t\tthis.items = items;\r\n\t\t\t\tthis.render_item_list(items);\r\n\t\t\t\tthis.pagination();\r\n               \r\n\t\t\t\tthis.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\r\n        \r\n\t\tthis.get_items({ search_value: search_term })\r\n\t\t\t.then(({ message }) => {\r\n\t\t\t\t// eslint-disable-next-line no-unused-vars\r\n\t\t\t\tconst { items, serial_no, batch_no, barcode } = message;\r\n\t\t\t\tif (search_term && !barcode) {\r\n\t\t\t\t\tthis.search_index[search_term] = items;\r\n\t\t\t\t}\r\n\t\t\t\tthis.items = items;\r\n\t\t\t\tthis.render_item_list(items);\r\n\t\t\t\tthis.pagination();\r\n               \r\n                if(this.items.length == 1 && search_term){\r\n\t\t\t\t    this.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\r\n                }\r\n\r\n\t\t\t});\r\n        \r\n\t}\r\n\r\n\tadd_filtered_item_to_cart() {\r\n\t\tthis.$items_container.find(\".item-wrapper\").click();\r\n\t}\r\n\r\n\tresize_selector(minimize) {\r\n\t\tminimize ?\r\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\r\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(12, minmax(0, 1fr))');\r\n\t\t\t\r\n\t\t\r\n\t\tminimize ?\r\n\t\t\tthis.$component.find('.search-field').css('margin', 'var(--margin-sm) 0px') :\r\n\t\t\tthis.$component.find('.search-field').css('margin', '0px var(--margin-sm)');\r\n\r\n\t\tminimize ?\r\n\t\t\tthis.$component.css('grid-column', 'span 2 / span 2') :\r\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\r\n\r\n\t\tminimize ?\r\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\r\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(4, minmax(0, 1fr))');\r\n\t\tminimize ?\r\n\t\t\tthis.$component.find('.search-item-group').css('width','5%'):            \r\n\t\t\tthis.$component.find('.search-item-group').css('width','10%');\t\r\n        if(this.item_sub_groups.length>0)\r\n            {\r\n               \r\n\t\t\t\tif(this.$component.find('.filter-section').is(\":visible\")){\r\n\t\t\t\t\tthis.$component.find('.search-item-group').css('width','5%');\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.$component.find('.search-item-group').css('width','20%');\t\r\n\t\t\t\t}\r\n                \r\n            }\r\n\t\t\r\n\t}\r\n\r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\r\n\t}\r\n    //added by shiby\r\n    show_sub_group(show){\r\n\t\t\r\n\t\tif(show){\r\n           \r\n\t\t\tthis.$component.find('.pos-item-sub-cat').css({\r\n\t\t\t\t'display': 'block',\r\n                'width': '80%'\r\n\t\t\t})\r\n            this.$component.find('.filter-section').css({\r\n\t\t\t\t'display': 'none'\r\n               \r\n\t\t\t})\r\n            this.$component.find('.items-container').css({\r\n\t\t\t\t'display': 'none'\r\n               \r\n\t\t\t})\r\n\t\t\tthis.$component.find('.pos-item-cat').css({\r\n\t\t\t\t'width': '20%'\r\n\t\t\t})\r\n            this.$component.find('.search-item-group').css({\r\n\t\t\t\t'width': '50%'\r\n\t\t\t})\r\n        \r\n\t\t\t\r\n\t\t}\r\n\t\telse{\r\n\t\t\tthis.$component.find('.pos-item-sub-cat').css({\r\n\t\t\t\t'display': 'none'\r\n\t\t\t})\r\n\t\t\tthis.$component.find('.pos-item-cat').css({\r\n\t\t\t\t'width': '100%'\r\n\t\t\t})\r\n            this.$component.find('.items-container').css({\r\n\t\t\t\t'display': 'grid'\r\n               \r\n\t\t\t})\r\n\t\t\t\r\n            this.$component.find('.filter-section').css({\r\n\t\t\t\t'display': 'grid'\r\n               \r\n\t\t\t})\r\n            this.$component.find('.search-item-group').css({\r\n\t\t\t\t'width': '10%'\r\n\t\t\t})\r\n\r\n\t\t}\r\n\t\tif(this.$component.find('.filter-section').is(\":visible\")){\r\n\t\t\tthis.$component.find('.search-item-group').css('width','10%');\r\n\t\t\t\r\n\t\t\t\r\n\t\t}\r\n\t\telse{\r\n\t\t\t\r\n\t\t\tthis.$component.find('.search-item-group').css('width','20%');\t\r\n\t\t}\r\n\t}\r\n\tget_item_group() {\r\n        \r\n\t\tvar me = this;\r\n\t\tfrappe.call({\r\n\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_item_group\",\r\n\t\t\tfreeze: true,\r\n\t\t\targs: {\r\n\t\t\t\tpos_profile: me.pos_profile ? me.pos_profile : ''\r\n\t\t\t}\r\n\t\t}).then(r => {\r\n\t\t\tme.item_groups = r.message['item_group_dict'];\r\n\t\t\t// me.item_sub_groups=r.message['item_sub_group_dict'];\r\n            \r\n\t\t\tme.search_item_group = me.wrapper.find('.search-item-group');\r\n\t\t\t// var dropdown_html = me.get_sorted_item_groups().map(function(item_group) {\r\n\t\t\t// \tvar itmgrm=item_group\r\n\t\t\t\t\r\n\t\t\t// \treturn `<li style='margin: 0 5px;border-bottom: 1px solid #cccac6;font-size: 11px;padding: 15px 1px;'><a class='option' style=\"padding: 0;\" data-value='`+item_group+`'>`+item_group+`</a>\r\n\t\t\t// \t${me.get_sorted_item_sub_groups(item_group).map(function(item_sgroup) {\r\n\t\t\t\t\t\r\n\t\t\t// \t\treturn `<li class=\"subgroup`+itmgrm+` \"style='margin: 0 5px;display:none;overflow: hidden;background-color: silver;border-bottom: 1px solid #cccac6;font-size: 11px;padding: 15px 1px;'><a class='option' data-value='`+item_sgroup+`'>`+item_sgroup+`</a>\r\n\t\t\t\t\t\r\n\t\t\t// \t\t</li>`\r\n\t\t\t// \t })}\r\n\t\t\t// \t</li>`;\r\n\t\t\t//  }\r\n\t\t\t//  ).join(\"\");\r\n\t\t\tvar dropdown_html = me.get_sorted_item_groups().map(function(item_group) {\r\n\t\t\t\tvar itmgrm=item_group\r\n\t\t\t\t\r\n\t\t\t\treturn `<li style='margin: 0 5px;border-bottom: 1px solid #cccac6;font-size: 11px;padding: 15px 1px;'><a class='option' style=\"padding: 0;\" data-value='`+item_group+`'>`+item_group+`</a>\r\n\t\t\t\t\r\n\t\t\t\t</li>`;\r\n\t\t\t }\r\n\t\t\t ).join(\"\");\r\n\t\t\t\r\n\t\t\tme.search_item_group.find('.dropdown-menu').html(dropdown_html);\r\n\t\t\t\r\n\t\t\tme.search_item_group.on('click', '.dropdown-menu a', function() {\r\n\t\t\t\r\n\t\t\t\tif(cur_pos.combo_item_details.wrapper.find('.combo-item-details-container').is(\":visible\")){\r\n\t\t\t\t\tfrappe.throw(\"Please close Item Bundle popup\")\r\n\r\n\t\t\t\t}\r\n\t\t\t\tme.item_group_field.set_value($(this).attr('data-value'));\r\n\t\t\t\t\r\n                if(cur_pos.item_details.wrapper.find('.item-details-container').is(\":visible\")){\r\n                    cur_pos.item_details.events.close_item_details()\r\n                 }\r\n                me.show_sub_group(false);\r\n\t\t\t\tme.get_item_sub_group($(this).attr('data-value'))\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t});\r\n            me.search_item_group.find('.dropdown-menu').find(\"a:first\").trigger(\"click\");\r\n           \r\n\t\t});\r\n\t}\r\n\t\r\n\tget_item_sub_group(item_group){\r\n\t\tvar me=this;\r\n        //me.show_sub_group(false);\r\n\t\tvar sub_html ='<div class=\"row\" style=\"width: 100%; \">';\r\n\t\t\t\tfrappe.call({\r\n\t\t\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_item_sub_group\",\r\n\t\t\t\t\tfreeze: true,\r\n\t\t\t\t\targs: {\r\n\t\t\t\t\t\tpos_profile: me.pos_profile ? me.pos_profile : '',\r\n\t\t\t\t\t\titem_group:item_group?item_group:''\r\n\t\t\t\t\t}\r\n\t\t\t\t}).then(r => {\r\n\t\t\tme.item_sub_groups=r.message['item_sub_group_dict'];\r\n           \tme.search_item_group = me.wrapper.find('.search-item-group');\r\n               \r\n\t\t\t   if(me.item_sub_groups.length>0)\r\n\t\t\t   {\r\n\t\t\t\tme.show_sub_group(true);\r\n\t\t\t   }\r\n               \r\n\t\t\tvar dropdown_html = me.get_sorted_item_sub_groups().map(function(item_group) {\r\n\t\t\t\tvar itmgrm=item_group\r\n\t\t\t\t\r\n\t\t\t\treturn `<div class=\"col-md-4\"><li style='margin: 0 5px;border-bottom: 1px solid #cccac6;font-size: 11px;padding: 15px 1px;'><a class='option' style=\"padding: 0;\" data-value='`+item_group+`'>`+item_group+`</a>\r\n\t\t\t\t\r\n\t\t\t\t</li></div>`;\r\n\t\t\t }\r\n\t\t\t ).join(\"\");\r\n             dropdown_html=sub_html+dropdown_html+'</div>'\r\n\t\t\tme.search_item_group.find('.dropdown-sub-menu').html(dropdown_html);\r\n\t\t\t\r\n\t\t\tme.search_item_group.on('click', '.dropdown-sub-menu a', function() {\r\n\t\t\t\r\n\t\t\t\tme.item_group_field.set_value($(this).attr('data-value'));\r\n\t\t\t\tvar classname=\"subgroup\"+$(this).attr('data-value');\r\n\t\t\t\tme.$subgroup = me.search_item_group.find(\".\"+classname+\"\");\t\r\n\t\t\t\tif\t(me.$subgroup)\t{\r\n\t\t\t\t\tme.$subgroup.css('display', 'block');\r\n\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tme.show_sub_group(false);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tthis.$component.find('.search-item-group').css('width','5%');\t\r\n\t\t\t\t\r\n\t\t\t});\r\n\t\t\t\t// \tthis.item_sub_groups=r.message;\r\n\t\t\t\t\t\r\n\t\t\t\t// \treturn this.get_sorted_item_sub_groups().map(function(item_group) {\r\n\r\n\t\t\t\t// \t var html= \"<li style='margin: 0 5px;border-bottom: 1px solid #cccac6;font-size: 11px;padding: 15px 1px;'><a class='option' data-value='\"+item_group+\"'>\"+item_group+\"</a></li>\";\r\n\t\t\t\t\t \r\n\t\t\t\t\t \r\n\t\t\t\t// \t})\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t})\t\t\t\r\n\t\t\t\t\t\r\n\t}\r\n\t\r\n\t\r\n\tget_sorted_item_sub_groups(item_group) {\r\n       // console.log(\"get_sorted_item_sub_groups\")\r\n\t\tvar list = {}\r\n\t\tvar filtered =  this.item_sub_groups.filter(function(hero) {\r\n\t\t\treturn hero.parent_item_group == item_group;\r\n\t\t});\r\n\t\t\t\r\n\t\t\r\n\tvar\titem_sub_group_dict={};\r\n\t\t$.each(filtered, function(i, data) {\t\t\r\n\t\t\titem_sub_group_dict[data.name] = [data.lft, data.rgt]\r\n\t\t})\r\n\t\t\r\n\t\t$.each(item_sub_group_dict, function(i, data) {\r\n\t\t\tlist[i] = data[0]\r\n\t\t})\r\n\r\n\t\treturn Object.keys(list).sort(function(a,b){return list[a]-list[b]})\r\n\t}\r\n\tget_sorted_item_groups() {\r\n\t\tvar list = {}\r\n\t\t$.each(this.item_groups, function(i, data) {\r\n\t\t\t\r\n\t\t\tlist[i] = data[0]\r\n\t\t})\r\n\t\t\t\r\n\t\treturn Object.keys(list).sort(function(a,b){return list[a]-list[b]})\r\n\t}\r\n\t\r\n\tpagination() {\r\n\t\tvar me = this;\r\n\t\tconst pageSize = 2;\r\n        const showpage=3;\r\n        var diffpage=0;\r\n\t\tme.wrapper.find('.pagination').empty().hide();\r\n\t\tvar pageCount = Math.ceil((me.wrapper.find(\".item-wrapper\").size() || 1)/4)\r\n\t\t\r\n\t\tpageCount = pageCount / pageSize;\r\n\t\tif (pageCount <= 1)\r\n\t\t\treturn;\r\n\t\t\r\n\t\tvar container_list = me.wrapper.find('.items-selector');\t\t\r\n\t\tcontainer_list.find(\".pagination\").append(`<a class=\"previous disabled\">&laquo;</a>`)\r\n\t\tfor(var i = 0; i<pageCount; i++) {\r\n            if(i<showpage)\r\n            {\r\n                container_list.find(\".pagination\").append(`<a class=\"page-link\">`+(i+1)+`</a>`).show();\r\n            }\r\n            else{\r\n                container_list.find(\".pagination\").append(`<a class=\"page-link hide\">`+(i+1)+`</a>`).show();\r\n               \r\n            }\r\n            \r\n\t\t}\r\n\t\tcontainer_list.find(\".pagination\").append(`<a class=\"next\">&raquo;</a>`)\r\n\t\tcontainer_list.find(\".pagination a.page-link\").first().addClass(\"active\");\r\n\t\t\r\n\t\tconst showPage = function() {\r\n\t\t\r\n\t\t\tvar current_page = container_list.find(\".pagination a.active\");\r\n\t\t\tvar page_n = current_page.text();\r\n         \r\n\t\t\tvar row_idx = (page_n - 1) * pageSize;\r\n\t\t\t// console.log(page_n+\"   \"+row_idx)\r\n\r\n\t\t\tvar _row = me.wrapper.find(\".item-wrapper\").eq(row_idx);\r\n\t\t\t\r\n\r\n\t\t\tvar _idx = _row.index();\r\n\t\t\tvar row_height = _row.height();\r\n\t\t\tvar container_height = _row.parent().height();\r\n            \r\n\r\n\t\t\t// var scroll_to = container_height - (_idx * row_height);\r\n\t\t\tvar scroll_to = (_idx * row_height);\r\n\t\t\tvar scroll_to = scroll_to == container_height ? 0 : scroll_to;\r\n\t\t\t// console.log(container_height+\"   \"+_idx+\"   \"+row_height+\"   \"+scroll_to);\r\n\t\t\tcontainer_list.find('.items-container').animate({scrollTop: scroll_to}, \"fast\");\r\n\t\t}\r\n\t\t \r\n\t\tshowPage();\r\n\t \r\n\t\tcontainer_list.find(\".pagination a\").click(function() {\r\n\t\t\tvar page_idx = $(\".pagination a.active\").index();\r\n           \r\n\t\t\t$(\".pagination a.page-link\").removeClass(\"active\");\r\n\t\t\t$(\".pagination a\").removeClass(\"disabled\");\r\n\t\t\t\r\n\t\t\tif($(this).hasClass(\"page-link\")) {\r\n\t\t\t\t$(this).addClass(\"active\");\r\n                \r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvar pre_idx = (page_idx - 1) >= 1 ? (page_idx - 1) : 1;\r\n\t\t\t// console.log(\"prev idx \"+ pre_idx);\r\n\t\t\tif ($(this).hasClass(\"previous\"))\r\n            {\r\n                $(\".pagination a\").eq(pre_idx).addClass(\"active\");\r\n                if(pre_idx>=showpage)\r\n                {\r\n                    $(\".pagination a\").eq(pre_idx+1).addClass(\"hide\");\r\n                    $(\".pagination a\").eq(pre_idx+1-showpage).removeClass(\"hide\")\r\n                    $(\".pagination a\").eq(pre_idx+1-showpage).css('display','unset')\r\n                }\r\n            }\r\n\t\t\t\t\r\n                \r\n\t\t\t\r\n\t\t\tif ($(\".pagination a.active\").index() == 1)\r\n\t\t\t\t$(\".pagination a.previous\").addClass(\"disabled\");\r\n\t\t\t\r\n\t\t\tvar page_link_len = $(\".pagination a\").size() - 2;\r\n\t\t\tvar next_idx = (page_idx + 1) <= page_link_len ? (page_idx + 1) : page_link_len;\r\n\t\t\tvar page_link_len = $(\".pagination a\").size() - 2;\r\n\t\t\r\n\t\t\tif ($(this).hasClass(\"next\"))\r\n            {\r\n                $(\".pagination a\").eq(next_idx).addClass(\"active\");\r\n                if(next_idx<page_link_len)\r\n                {\r\n                    $(\".pagination a\").eq(next_idx+1).removeClass(\"hide\");\r\n                    $(\".pagination a\").eq(next_idx+1).css('display','unset')\r\n                    \r\n                }\r\n               if(next_idx-showpage>=0)\r\n               {\r\n                if(next_idx-showpage+1<showpage)\r\n                {\r\n                    $(\".pagination a\").eq(next_idx-showpage+1).addClass(\"hide\");\r\n                }\r\n                \r\n               }\r\n\r\n            }\r\n\t\t\t\t\r\n\r\n\t\t\tif ($(\".pagination a.active\").index() == page_link_len)\r\n\t\t\t\t$(\".pagination a.next\").addClass(\"disabled\");\r\n\r\n\t\t\tshowPage();\r\n          \r\n            $('.pagination a').css({\r\n\t\t\t\r\n                'padding': '8px 16px',\r\n                'text-decoration': 'none',\r\n                'margin': '0 1px',\r\n                'background-color': 'white',\r\n                'border': '1px solid #ddd'\r\n                \r\n            })\r\n            \r\n            $('.pagination a:not(.disabled)').css({\r\n                'color': 'black',\r\n                'transition': 'background-color .3s'\r\n            })\r\n            \r\n            $('.pagination a.page-link.active').css({\r\n                'background-color': '#4CAF50',\r\n                'color': 'white',\r\n                'border': '1px solid #4CAF50'\r\n            })\r\n            $('.pagination a.page-link.hide').css({\r\n                'display':'none'\r\n            })\r\n            $('.pagination a.page-link:hover:not(.active)').css({\r\n                'background-color': '#ddd'})\r\n            \r\n                $('.pagination a:first-child').css( {\r\n                'border-top-left-radius': '5px',\r\n                'border-bottom-left-radius': '5px'\r\n            })\r\n            \r\n            $('.pagination a:last-child').css({\r\n                'border-top-right-radius': '5px',\r\n                'border-bottom-right-radius': '5px'\r\n            })\r\n\t\t});\r\n\t\t\r\n        $('.pagination a').css({\r\n\t\t\t\r\n\t\t\t'padding': '8px 16px',\r\n\t\t\t'text-decoration': 'none',\r\n\t\t\t'margin': '0 1px',\r\n\t\t\t'background-color': 'white',\r\n\t\t\t'border': '1px solid #ddd'\r\n\t\t\t\r\n\t\t})\r\n\t\t\r\n\t\t$('.pagination a:not(.disabled)').css({\r\n\t\t\t'color': 'black',\r\n\t\t\t'transition': 'background-color .3s'\r\n\t\t})\r\n\t\t\r\n\t\t$('.pagination a.page-link.active').css({\r\n\t\t\t'background-color': '#4CAF50',\r\n\t\t\t'color': 'white',\r\n\t\t\t'border': '1px solid #4CAF50'\r\n\t\t})\r\n\t\t\r\n\t\t$('.pagination a.page-link:hover:not(.active)').css({\r\n\t\t\t'background-color': '#ddd'})\r\n\t\t\r\n\t\t\t$('.pagination a:first-child').css( {\r\n\t\t\t'border-top-left-radius': '5px',\r\n\t\t\t'border-bottom-left-radius': '5px'\r\n\t\t})\r\n\t\t\r\n\t\t$('.pagination a:last-child').css({\r\n\t\t\t'border-top-right-radius': '5px',\r\n\t\t\t'border-bottom-right-radius': '5px'\r\n\t\t})\r\n\t\r\n\t}\r\n    \r\n};\r\n\r\n\r\n","erpnext.PointOfSale.ItemCart = class {\n\tconstructor({ wrapper, events, settings,pos_profile }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.customer_info = undefined;\n\t\tthis.location_info = undefined;\n\t\tthis.so_info=undefined;\n\t\tthis.non_sharable_slot=0;\n\t\t\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.pos_profile = pos_profile;\n\t\tthis.allowed_customer_groups = settings.customer_groups;\n\t\tthis.allow_rate_change = settings.allow_rate_change;\n\t\tthis.allow_discount_change = settings.allow_discount_change;\n\t\tthis.disremark='';\n\t\tthis.init_component();\n\t\tthis.check_minimum_sales_qty=true;\n\t\tthis.custom_change_call=false;\n\t\tthis.old_val_set = 0;\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_child_components();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t\tthis.set_css();\n\t}\n\tmake_search_bar() {\n\t\tconst me = this;\n\t\t\n\t\tthis.$component.find('.sosearch-field').html('');\n\t\t\n\t\tthis.sosearch_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Search'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Scan Order Booking No/RFID')\n\t\t\t\t\n\t\t\t},\n\t\t\tparent: this.$component.find('.sosearch-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\t\n\t\tthis.sosearch_field.toggle_label(false);\n\t\t\n\t}\n\n\tset_css()\n\t{\n\t\t$('.cart-container').css('padding-left', '3px');\n\t\t\n\t\t$('.abs-cart-container').css({'padding':'',\n\t\t'padding-bottom':''});\n\n\t}\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"customer-cart-container\"></section>`\n\t\t)\n\t\t\n\t\tthis.$component = this.wrapper.find('.customer-cart-container');\n        $('.point-of-sale-app section').css('height','90vh')\t\n\t\t\n\t}\n\n\tinit_child_components() {\n\t\tthis.init_customer_selector();\n\t\tthis.init_cart_components();\n\t\tthis.init_sosearch();\n\t}\n\tinit_sosearch()\n\t{\n\t//this.$component.append(`<div class=\"sosearch-field\"></div>`)\n\t\tthis.make_search_bar()\n\t}\n\tinit_customer_selector() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"sosearch-field\"></div>\n\t\t\t<div class=\"customer-section\"></div>`\n\t\t)\n\t\tthis.$component.append(\n            \n\t\t\t`<div class=\"location-fields-container\">\n            <div class=\"visitdate-field\"></div>\n\t\t\t<div class=\"so-field\"></div>\n            </div>\t\t\t\n\t\t\t`\n\t\t)\n\t\tthis.$customer_section = this.$component.find('.customer-section');\n\t\tthis.$location_fields_container = this.$component.find('.location-fields-container');\n        $('.location-fields-container').css({\n            \t\t\t\t'background-color': '#0799a3bd',\n            \t\t\t\t'display': 'grid',\n            \t\t\t\t'grid-template-columns': 'repeat(2,minmax(0,1fr))',\n            \t\t\t\t'margin-top': 'var(--margin-md)',\n            \t\t\t\t'-moz-column-gap': 'var(--padding-sm)',\n            \t\t\t\t'column-gap': 'var(--padding-sm)',\n            \t\t\t\t'row-gap': 'var(--padding-xs)',\n            \t\t\t\t'padding-right': '3px',\n            \t\t\t\t'padding-left': '3px'\n                    });\n        this.make_customer_selector();\n        //added by shiby\n\t\t//this.render_location_fields();\n        //\n\t}\n\n\treset_customer_selector() {\n\t\tconst frm = this.events.get_frm();\n\t\t\n        \n        if(frm.doc.items.length==0){\n\t\tfrm.set_value('customer', '');\n\t\t\n\t\tthis.make_customer_selector();\n\t\tthis.customer_field.set_focus();\n\t\t}\n\t}\n//<div class=\"cart-label\">Item Cart</div>\n\tinit_cart_components() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"cart-container\">\n\t\t\t\t<div class=\"abs-cart-container\">\n\t\t\t\t\t\n\t\t\t\t\t<div class=\"cart-header\">\n                        \n\t\t\t\t\t\t<div class=\"name-header\">Item</div>\n\t\t\t\t\t\t<div class=\"qty-header\">Qty</div>\n\t\t\t\t\t\t<div class=\"rate-amount-header\">Amount</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"cart-items-section\"></div>\n\t\t\t\t\t<div class=\"cart-totals-section\"></div>\n\t\t\t\t\t<div class=\"numpad-section\"></div>\n                    \n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\t\tthis.$cart_container = this.$component.find('.cart-container');\n      \n\t\tthis.make_cart_totals_section();\n\t\tthis.make_cart_items_section();\n\t\tthis.make_cart_numpad();\n       \n\t}\n  \n\tmake_cart_items_section() {\n\t\tthis.$cart_header = this.$component.find('.cart-header');\n\t\tthis.$cart_items_wrapper = this.$component.find('.cart-items-section');\n        this.$abs_cart_container = this.$component.find('.abs-cart-container');\n        this.$abs_cart_container = this.$component.find('.abs-cart-container');\n        this.$net_total_container = this.$component.find('.net-total-container');\n        this.$grand_total_container = this.$component.find('.grand-total-container');\n\t\tthis.$cart_totals_section=this.$component.find('.cart-totals-section');\n\t\tthis.make_no_items_placeholder();\n\t}\n\n\tmake_no_items_placeholder() {\n\t\t\n\t\tthis.$cart_header.css('display', 'none');\n        this.$cart_header.css({'padding-left': '3px;',\n        'background-color': '#eceef0'});\n        this.$abs_cart_container.css('padding','')\n        this.$net_total_container.css({'padding-left': '10px',\n\t\t'color': '#fff'})\n        this.$grand_total_container.css({'padding-left': '10px',\n\t\t'color': '#fff'})\n\t\tthis.$cart_totals_section.css('background-color','rgba(7, 153, 163, 0.74)')\n\t\tthis.$component.find('.name-header').css('padding-left', '10px')\n\t\tthis.$component.find('.abs-cart-container').css('padding', 'unset')\n\t\tthis.$component.find('.qty-header').css('padding-right', '60px')\n\t\tthis.$component.find('.taxes-container').css({'padding-left': '10px',\n\t\t'color': '#fff'})\n\t\tthis.$component.find('.add-discount-wrapper').css({'color': '#fff'})\n\t\tthis.$cart_items_wrapper.html(\n\t\t\t`<div class=\"no-item-wrapper\">No items in cart</div>`\n\t\t);\n\t}\n\n\tget_discount_icon() {\n\t\treturn (\n\t\t\t`<svg class=\"discount-icon\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t<path d=\"M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15 9L9 15\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t</svg>`\n\t\t);\n\t}\n\n\tmake_cart_totals_section() {\n\t\tthis.$totals_section = this.$component.find('.cart-totals-section');\n       \n\t\t// this.$totals_section.append(\n\t\t// \t`<div class=\"add-discount-wrapper\">\n\t\t// \t\t${this.get_discount_icon()} Add Discount\n\t\t// \t</div>\n\t\t// \t<div class=\"net-total-container\">\n\t\t// \t\t<div class=\"net-total-label\">Net Total</div>\n\t\t// \t\t<div class=\"net-total-value\">0.00</div>\n\t\t// \t</div>\n\t\t// \t<div class=\"taxes-container\"></div>\n\t\t// \t<div class=\"grand-total-container\">\n\t\t// \t\t<div>Grand Total</div>\n\t\t// \t\t<div>0.00</div>\n\t\t// \t</div>\n\t\t// \t<div class=\"checkout-btn\">Checkout</div>\n\t\t// \t<div class=\"edit-cart-btn\">Edit Cart</div>`\n\t\t// )\n\t\t//Commented and added by shiby\n\t\tthis.$totals_section.append(\n\t\t\t`<div class=\"add-discount-wrapper\">\n\t\t\t\t<div>${this.get_discount_icon()}Discount</div>\n\t\t\t\t<div class=\"discount-value\">0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"net-total-container\">\n\t\t\t\t<div class=\"net-total-label\">Net Total</div>\n\t\t\t\t<div class=\"net-total-value\">0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"taxes-container\"></div>\n\t\t\t<div class=\"grand-total-container\">\n\t\t\t\t<div>Grand Total</div>\n\t\t\t\t<div>0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"checkout-btn\">Checkout</div>\n\t\t\t<div class=\"btn save-as-draft-btn\"  style=\"display:none;\">Approve Discount</div>\n\t\t\t<div class=\"edit-cart-btn\">Edit Cart</div>`\n\t\t)\n\n\t\tthis.$add_discount_elem = this.$component.find(\".add-discount-wrapper\");\n\t\tthis.$add_discount_elem.css({'justify-content': 'space-between'})\n\t\tconst me = this;\n      \n\t\tthis.$totals_section.on('click', '.save-as-draft-btn', function () {\n\t\t//me.save_as_draft();\n        me.validate_approver();\n            \n\t\t\t\n\t});\n    \n\t}\n\n\tmake_cart_numpad() {\n\t\tthis.$numpad_section = this.$component.find('.numpad-section');\n\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\n\t\t\twrapper: this.$numpad_section,\n\t\t\tevents: {\n\t\t\t\tnumpad_event: this.on_numpad_event.bind(this)\n\t\t\t},\n\t\t\tcols: 5,\n\t\t\tkeys: [\n\t\t\t\t[ 1, 2, 3, 'Quantity' ],\n\t\t\t\t[ 4, 5, 6, 'Discount' ],\n\t\t\t\t[ 7, 8, 9, 'Rate' ],\n\t\t\t\t[ '.', 0, 'Delete', 'Remove' ]\n\t\t\t],\n\t\t\tcss_classes: [\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2 remove-btn' ]\n\t\t\t],\n\t\t\tfieldnames_map: { 'Quantity': 'qty', 'Discount': 'discount_percentage' }\n\t\t})\n\n\t\tthis.$numpad_section.prepend(\n\t\t\t`<div class=\"numpad-totals\">\n\t\t\t\t<span class=\"numpad-net-total\"></span>\n\t\t\t\t<span class=\"numpad-grand-total\"></span>\n\t\t\t</div>`\n\t\t)\n\n\t\tthis.$numpad_section.append(\n\t\t\t`<div class=\"numpad-btn checkout-btn\" data-button-value=\"checkout\">Checkout</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.$customer_section.on('click', '.reset-customer-btn', function () {\n\t\t\tme.reset_customer_selector();\n\t\t});\n\n\t\t\n\t\tthis.$customer_section.on('click', '.close-details-btn', function () {\n\t\t\t\n\t\t\tme.toggle_customer_info(false);\n\t\t});\n\n\t\tthis.$customer_section.on('click', '.customer-display', function(e) {\n\t\t\tif ($(e.target).closest('.reset-customer-btn').length) return;\n\n\t\t\tconst show = me.$cart_container.is(':visible');\n           \n\t\t\tme.toggle_customer_info(show);\n\t\t});\n\t\tthis.$cart_items_wrapper.on('click', '.list-item', function() {\n\t\t\tme.toggle_item_highlight(this);\n\t\t\tthis.item_is_selected=true;\n\t\t});\n\t\tthis.$cart_items_wrapper.on('dblclick', '.cart-item-wrapper', function() {\n\t\t\tconst $cart_item = $(this);\n\n\t\t\tme.toggle_item_highlight(this);\n\t\t\t\n\t\t\tconst payment_section_hidden = !me.$totals_section.find('.edit-cart-btn').is(':visible');\n\t\t\tif (!payment_section_hidden) {\n\t\t\t\t// payment section is visible\n\t\t\t\t// edit cart first and then open item details section\n\t\t\t\tme.$totals_section.find(\".edit-cart-btn\").click();\n\t\t\t}\n\n\t\t\tconst item_code = unescape($cart_item.attr('data-item-code'));\n\t\t\tconst batch_no = unescape($cart_item.attr('data-batch-no'));\n\t\t\tconst uom = unescape($cart_item.attr('data-uom'));\n            var bundle_item=unescape($cart_item.attr('data-bundle-item'));\n\t\t\tconst rate=unescape($cart_item.attr('data-item-rate'));\n            const free_item=unescape($cart_item.attr('data-item-free'));\n            \n\t\t\tvar current_item={};\n\t\t\tcurrent_item.item_code = item_code;\n\t\t\tcurrent_item.batch_no = batch_no;\n\t\t\tcurrent_item.uom = uom\n\t\t\tcur_pos.item_details.current_item=current_item;\t\n\t\t\tconst $btn = $(this);\n\t\t\tcurrent_item.qty = flt($btn.closest(\".cart-item-wrapper\").find(\".quantity input\").val())\n\t\t\tcur_pos.combo_item_details.current_item=current_item;\n            \n            if(cur_frm.doc.is_return)\n           {\n            frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\n                \n                if(r.name ){\n                    bundle_item=1\n                    me.events.cart_combo_item_clicked(item_code, batch_no, uom,rate);\n                   //const item_row_name = unescape($cart_item.attr('data-row-name'));\n                  // me.events.cart_combo_item_clicked({ name: item_row_name });\n    \n                }\n                else{\n                    bundle_item=0\n                    me.events.cart_item_clicked(item_code, batch_no, uom,rate);\n                   //const item_row_name = unescape($cart_item.attr('data-row-name'));\n\t\t\t       // me.events.cart_item_clicked({ name: item_row_name });\n                }\n\n            })\n           }\n           \n           else{\n            if(free_item==0){\n            frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\n               \n                if(r.name ){\n                    bundle_item=1\n\n                    if(bundle_item && bundle_item!='' && bundle_item!='null' && bundle_item!=\"undefined\" ){\n                        //const item_row_name = unescape($cart_item.attr('data-row-name'));\n                       // me.events.cart_combo_item_clicked({ name: item_row_name });\n                        me.events.cart_combo_item_clicked(item_code, batch_no, uom,rate);\n\n                     }\n                    else{\n                        //const item_row_name = unescape($cart_item.attr('data-row-name'));\n                       // me.events.cart_item_clicked({ name: item_row_name });\n\t\t\t            me.events.cart_item_clicked(item_code, batch_no, uom,rate);\n                    }\n                }\n                else{\n                    bundle_item=0\n                    me.events.cart_item_clicked(item_code, batch_no, uom,rate);\n                    //const item_row_name = unescape($cart_item.attr('data-row-name'));\n\t\t\t        //me.events.cart_item_clicked({ name: item_row_name });\n                }})\n            }\n            else{\n                console.log(\"free\")\n                $('.quantity input').attr('readonly', true);\n            }\n           }\n            \n\t\t\tthis.numpad_value = '';\n\t\t});\n\n\t\tthis.$cart_items_wrapper.on('change', '.quantity input', function() {\n\t\t\tconst $input = $(this);\n           \n\t\t\tconst $item = $input.closest('.cart-item-wrapper[data-item-code]');\n           \n\t\t\tme.toggle_item_highlight( $item);\n\t\t\tconst item_code = unescape($item.attr('data-item-code'));\n\t\t\tvar current_item={};\n\t\t\tlet batch_no = unescape($item.attr('data-batch-no'));\n          \n\t\t\tconst serial_no = unescape($item.attr('data-serial-no'));\n\t\t\tconst uom = unescape($item.attr('data-uom'));\n            const free_item=unescape($item.attr('data-item-free'));\n            \n\t\t\tbatch_no = batch_no === \"undefined\" ? undefined : batch_no;\n\t\t\tbatch_no = batch_no === \"\" ? undefined : batch_no;\n            const maximum_sales_quantity=unescape($item.attr('data-maximum-sales-qty'));\n            const minimum_sales_quantity=unescape($item.attr('data-minimum-sales-qty')) && unescape($item.attr('data-minimum-sales-qty'))!=0?unescape($item.attr('data-minimum-sales-qty')):1\n\t\t\tvar bundle_item=unescape($item.attr('data-bundle-item'));\n\t\t\tvar rate=unescape($item.attr('data-item-rate'));\n\t\t\tcur_pos.item_selector.bundle_item=bundle_item;\n\t\t\tcurrent_item.item_code = unescape($item.attr('data-item-code'));\n\t\t\tcurrent_item.batch_no = batch_no;\n\t\t\tcurrent_item.uom = unescape($item.attr('data-uom'));\n\t\t\tcur_pos.item_details.current_item=current_item;\t\n\t\t\tcurrent_item.qty=flt($('.quantity input').val())\n\t\t\tcur_pos.combo_item_details.current_item=current_item;\t\t\n\t\t\t\n           \n           if(free_item==0){\n                frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\n               \n                if(r.name ){\n                    bundle_item =1\n                    cur_pos.item_selector.bundle_item=bundle_item;\n                    current_item.qty\n                    me.events.item_selected({ field: 'qty', value:current_item.qty , item: { item_code, batch_no, serial_no, uom ,rate}}).then(() => {\n\t\t\t\t\t\tconst event = {\n\t\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\t\tvalue:current_item.qty,\n\t\t\t\t\t\t\titem: { item_code, batch_no, uom }\n\t\t\t\t\t\t}\n\t\t\t\t\t\t \n\t\t\t\t\t\t setTimeout(() => {\n\t\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t\t});\n\t\t\t\t\t\t \n\t\t\t\t\t\t}, 800);\n\t\t\t\t\t\t\n\t\t\t\t})\n                    $('.quantity input').attr('readonly', true);\n                }\n                else{\n                    $('.quantity input').attr('readonly', false);\n\t\t\t\tif(!cur_frm.doc.is_return && minimum_sales_quantity  && flt($('.quantity input').val())<= minimum_sales_quantity )\n\t\t\t\t{\n\t\t\t\t\t frappe.show_alert({\n\t\t\t\t\t indicator: 'red',\n\t\t\t\t\t message: \"Minimum Sales Quantity is :\"+minimum_sales_quantity\n\t\t\t\t });\n\t\t\t\n\t\t\t\n             \tme.events.item_selected({ field: 'qty', value:flt(minimum_sales_quantity) , item: { item_code, batch_no, serial_no, uom ,rate}}).then(() => {\n\t\t\t\t\tconst event = {\n\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\tvalue:flt(minimum_sales_quantity) ,\n\t\t\t\t\t\titem: { item_code, batch_no, uom }\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\t setTimeout(() => {\n                       \n\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t});\n\t\t\t\t\t \n\t\t\t\t\t}, 800);\n\t\t\t\t\t\n\t\t\t})\n\t\t\t\n\t\t\t\t return;\n\n\t\t\t}\n\t\t\telse if(!cur_frm.doc.is_return && maximum_sales_quantity && maximum_sales_quantity!=0 && flt($('.quantity input').val())> maximum_sales_quantity )\n\t\t\t{\n\t\t\t\t\n\t\t\t\t frappe.show_alert({\n\t\t\t\t indicator: 'red',\n\t\t\t\t message: \"Maximum Sales Quantity is :\"+maximum_sales_quantity\n\t\t\t });\n\t\t\t me.events.item_selected({ field: 'qty', value:flt(maximum_sales_quantity) , item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\n\t\t\t\tconst event = {\n\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\tvalue:flt(maximum_sales_quantity) ,\n\t\t\t\t\titem: { item_code, batch_no, uom }\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\t setTimeout(() => {\n\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t});\n\t\t\t\t \n\t\t\t\t}, 800);\n\t\t\t\t\n\t\t})\n\t\t\t\n\t\t\t\t return;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tme.events.item_selected({ field: 'qty', value:flt($input.val()) , item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\n\t\t\t\t\tconst event = {\n\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\tvalue:flt($input.val()) ,\n\t\t\t\t\t\titem: { item_code, batch_no, uom }\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\t setTimeout(() => {\n\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t});\n\t\t\t\t\t \n\t\t\t\t\t}, 800);\n\t\t\t\t\t\n\t\t\t})\n\t\t\t\n\t\t\t}\n\t\t\t\n                }\n            })\n        }\n        else{\n            console.log(\"free\")\n            $('.quantity input').attr('readonly', true);\n        }\n           \n        //     if(bundle_item=='' || bundle_item=='null' || bundle_item==\"undefined\"  ){\n\t\t// \t\t$('.quantity input').attr('readonly', false);\n\t\t// \t\tif(!cur_frm.doc.is_return && minimum_sales_quantity && minimum_sales_quantity!=0 && flt($('.quantity input').val())<= minimum_sales_quantity )\n\t\t// \t\t{\n\t\t// \t\t\t frappe.show_alert({\n\t\t// \t\t\t indicator: 'red',\n\t\t// \t\t\t message: \"Minimum Sales Quantity is :\"+minimum_sales_quantity\n\t\t// \t\t });\n\t\t\t\n\t\t\t\n        //      \tme.events.item_selected({ field: 'qty', value:flt(minimum_sales_quantity) , item: { item_code, batch_no, serial_no, uom }});\n\t\t\t\n\t\t// \t\t return;\n\n\t\t// \t}\n\t\t// \telse if(!cur_frm.doc.is_return && maximum_sales_quantity && maximum_sales_quantity!=0 && flt($('.quantity input').val())> maximum_sales_quantity )\n\t\t// \t{\n\t\t\t\t\n\t\t// \t\t frappe.show_alert({\n\t\t// \t\t indicator: 'red',\n\t\t// \t\t message: \"Maximum Sales Quantity is :\"+maximum_sales_quantity\n\t\t// \t });\n\t\t// \t me.events.item_selected({ field: 'qty', value:flt(maximum_sales_quantity) , item: { item_code, batch_no, serial_no, uom }});\n\t\t\t\n\t\t// \t\t return;\n\t\t// \t}\n\t\t// \telse{\n\t\t// \t\tme.events.item_selected({ field: 'qty', value:flt($input.val()) , item: { item_code, batch_no, serial_no, uom }});\n\t\t\t\n\t\t// \t}\n\t\t\t\n\t\t\t\t\n\t\t// }\n\t\t// else{\n\t\t// \t$('.quantity input').attr('readonly', true);\n\t\t// }\n\t\t\t\t\t\t\t\t\t\t\n\t\t});\n\t\t\n\t\tthis.$cart_items_wrapper.on('click',\n\t\t\t'[data-action=\"increment\"], [data-action=\"decrement\"]', function() {\n\t\t\t\t\t\t\t\n\t\t\t\tconst $btn = $(this);\n\t\t\t\tconst $item = $btn.closest('.cart-item-wrapper[data-item-code]');\n\t\t\t\t\n\t\t\t\tconst item_code = unescape($item.attr('data-item-code'));\n\t\t\t\tconst action = $btn.attr('data-action');\n\t\t\t\t\n\t\t\tlet batch_no = unescape($item.attr('data-batch-no'));\n\t\t\tlet serial_no = unescape($item.attr('data-serial-no'));\n\t\t\tlet uom = unescape($item.attr('data-uom'));\n\t\t\tlet rate= unescape($item.attr('data-item-rate'));\n\t\t\tconst free_item=unescape($item.attr('data-item-free'));\n\t\t\t\n            \n            const maximum_sales_quantity=unescape($item.attr('data-maximum-sales-qty'));\n            const minimum_sales_quantity=unescape($item.attr('data-minimum-sales-qty')) && unescape($item.attr('data-minimum-sales-qty'))!=0?unescape($item.attr('data-minimum-sales-qty')):1\n            \n            //const bundle_item=unescape($item.attr('data-bundle-item'));\n\t\t\tvar bundle_item=0\n\t\t\tbatch_no = batch_no === \"undefined\" ? undefined : batch_no;\n\t\t\tserial_no = serial_no === \"undefined\" ? undefined : serial_no;\n\t\t\tuom = uom === \"undefined\" ? undefined : uom;\n\t\t\tvar qtyvalue=\"+1\";\n            console.log(free_item,\"free_item\")\n\t\t\tif(free_item==0){\n\t\t\tfrappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_code} ,\"name\", (r)=> {\n              \n                if(r.name ){\n                    bundle_item =1\n                    cur_pos.item_selector.bundle_item=bundle_item;\n                    if(bundle_item=='' || bundle_item=='null' || bundle_item==\"undefined\"  ||bundle_item==null  ){\n\t\t\t\t        if(action === 'increment') {\n\t\t\t\t\t//events.on_field_change(item_code, 'qty', '+1');\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(!cur_frm.doc.is_return && maximum_sales_quantity && maximum_sales_quantity!=0 && flt($btn.closest(\".cart-item-wrapper\").find(\".quantity input\").val())>= maximum_sales_quantity )\n\t\t\t\t\t\t{\n                            me.events.item_selected({ field: 'qty', value: maximum_sales_quantity, item: { item_code, batch_no, serial_no, uom ,rate}});\n\t\t\t\t\t\t\t frappe.show_alert({\n\t\t\t\t\t\t\t indicator: 'red',\n\t\t\t\t\t\t\t message: \"Maximum Sales Quantity is :\"+maximum_sales_quantity\n\t\t\t\t\t\t });\n\t\t\t\t\t\t\t return;\n\t \n\t\t\t\t\t\t}\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tqtyvalue=\"+1\";\n\t\t\t\t\t\t\tme.events.item_selected({ field: 'qty', value: qtyvalue, item: { item_code, batch_no, serial_no, uom,rate}}).then(() => {\n                                const event = {\n                                    field: \"qty\",\n                                    value:qtyvalue,\n                                    item: { item_code, batch_no, uom,rate }\n                                }\n                                 \n                                 setTimeout(() => {\n\t\t\t\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\t\t\t\tme.make_no_items_placeholder();\n                                 cur_frm.doc.items.forEach(item => {\n\n                                    cur_pos.cart.update_item_html(item);\n                                });\n                                 \n                                }, 800);\n                                \n                        })\n\t\t\t\t\t\t\n\t\t\t\t\t\t}\t\t\n\t\t\t\t        } else if(action === 'decrement') {\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tif(minimum_sales_quantity && minimum_sales_quantity!=0 && flt($btn.closest(\".cart-item-wrapper\").find(\".quantity input\").val())<= minimum_sales_quantity)\n\t\t\t\t\t{\n\t\t\t\t\t\t frappe.show_alert({\n\t\t\t\t\t\t indicator: 'red',\n\t\t\t\t\t\t message: \"Minimum Sales Quantity is :\"+minimum_sales_quantity\n\t\t\t\t\t });\n\t\t\t\t\t\t return;\n \n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t\n\t\t\t\t\t\tqtyvalue=\"-1\";\n\t\t\t\t\t\tme.events.item_selected_desc({ field: 'qty', value: qtyvalue, item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\n\t\t\t\t\t\t\tconst event = {\n\t\t\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\t\t\tvalue:qtyvalue,\n\t\t\t\t\t\t\t\titem: { item_code, batch_no, uom ,rate}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t setTimeout(() => {\n\t\t\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t}, 800);\n\t\t\t\t\t\t\t\n\t\t\t\t\t})\t\n\n\t\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t        }\n\t\t\t        else{\n\t\t\t\t        $btn.closest(\".cart-item-wrapper\").find(\".quantity input\").attr('readonly', true);\n\t\t\t            }\n            }else{\n                bundle_item=0\n                cur_pos.item_selector.bundle_item=bundle_item;\n                if(bundle_item=='' || bundle_item=='null' || bundle_item==\"undefined\"  ||bundle_item==null  ){\n                    if(action === 'increment') {\n                //events.on_field_change(item_code, 'qty', '+1');\n                    \n                    if(!cur_frm.doc.is_return && maximum_sales_quantity && maximum_sales_quantity!=0 && flt($btn.closest(\".cart-item-wrapper\").find(\".quantity input\").val())>= maximum_sales_quantity )\n                    {\n                        me.events.item_selected({ field: 'qty', value: maximum_sales_quantity, item: { item_code, batch_no, serial_no, uom,rate }});\n                         frappe.show_alert({\n                         indicator: 'red',\n                         message: \"Maximum Sales Quantity is :\"+maximum_sales_quantity\n                     });\n                         return;\n \n                    }\n                    else{\n                    \n                        qtyvalue=\"+1\";\n                        me.events.item_selected({ field: 'qty', value: qtyvalue, item: { item_code, batch_no, serial_no, uom,rate }}).then(() => {\n\t\t\t\t\t\t\tconst event = {\n\t\t\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\t\t\tvalue:qtyvalue,\n\t\t\t\t\t\t\t\titem: { item_code, batch_no, uom }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t setTimeout(() => {\n\t\t\t\t\t\t\t\tme.$cart_items_wrapper.html('');\n\t\t\t\t\t\t\t\tme.make_no_items_placeholder();\n\t\t\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\n\t\t\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t}, 800);\n\t\t\t\t\t\t\t\n\t\t\t\t\t})\n                    \n                    }\t\t\n                    } else if(action === 'decrement') {\n                \n                        console.log(minimum_sales_quantity,\"FFFFFFFFFF\")\n                if(!cur_frm.doc.is_return && minimum_sales_quantity  && flt($btn.closest(\".cart-item-wrapper\").find(\".quantity input\").val())<= minimum_sales_quantity )\n                {\n                     frappe.show_alert({\n                     indicator: 'red',\n                     message: \"Minimum Sales Quantity is :\"+minimum_sales_quantity\n                 });\n                     return;\n\n                }\n                else{\n                \n                    qtyvalue=\"-1\";\n                    me.events.item_selected_desc({ field: 'qty', value: qtyvalue, item: { item_code, batch_no, serial_no, uom ,rate}}).then(() => {\n\t\t\t\t\t\tconst event = {\n\t\t\t\t\t\t\tfield: \"qty\",\n\t\t\t\t\t\t\tvalue:qtyvalue,\n\t\t\t\t\t\t\titem: { item_code, batch_no, uom ,rate}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t setTimeout(() => {\n\t\t\t\t\t\t me.$cart_items_wrapper.html('');\n\t\t\t\t\t\t me.make_no_items_placeholder();\n\t\t\t\t\t\t cur_frm.doc.items.forEach(item => {\n\t\t\t\t\t\t\tcur_pos.cart.update_item_html(item);\n\t\t\t\t\t\t});\n\t\t\t\t\t\t}, 800);\n\t\t\t\t})\t\n\n                }\n            \n                \n            }\n            \n                }\n                else{\n                    $btn.closest(\".cart-item-wrapper\").find(\".quantity input\").attr('readonly', true);\n                    }\n\n             }})\n            }\n            else{\n                console.log(\"free\")\n                $('.quantity input').attr('readonly', true);\n            }\t\n\t\t\t});\n\n\n\t\tthis.$component.on('click', '.checkout-btn', function() {\n\t\t\n\t\t\tif ($(this).attr('style').indexOf('--blue-500') == -1) return;\n           //shiby\n\t\t //\n\t\t//  frappe.db.get_value('POS Profile',  cur_frm.doc.pos_profile, [\"is_event\"]).then(({ message }) => {\n\t\t// \tthis.is_event=message.is_event\n\t\t\n\t\t\n\t\t//   if(message.is_event==1)\n\t\t//   {\n\t\t// \tif(!cur_pos.cart.location_visitdate_field || cur_pos.cart.location_visitdate_field.value=='')\n\t\t// \t{\n\t\t// \t frappe.show_alert({\n\t\t// \t\t indicator: 'red',\n\t\t// \t\t message: \"Visit date is mandatory\"\n\t\t// \t });\n\t\t// \t return;\n \n\t\t// \t}\n\t\t\t\n\t\t// \tif(this.non_sharable_slot==1)\n\t\t// \t{\n\t\t\t \n\t\t// \t\tif(!cur_pos.cart.location_city_field || !cur_pos.cart.location_branch_field || !cur_pos.cart.location_brand_field && ! cur_pos.cart.location_department_field)\n\t\t// \t\t{\n\t\t// \t\t frappe.show_alert({\n\t\t// \t\t\t indicator: 'red',\n\t\t// \t\t\t message: \"Enter Location Details\"\n\t\t// \t\t });\n\t\t// \t\t return;\n \n\t\t// \t\t}\n\t\t\t\n\t\t\t\n\t\t\t \n\t\t// \t}\n\t\t\t\t \n\t\t// \tif(cur_pos.cart.location_so_field.value=='')\n\t\t// \t{\n\t\t\t   \n\t\t// \t\tif(cur_pos.cart.location_event_field || cur_pos.cart.location_event_field.value=='')\n\t\t// \t\t{\n\t\t// \t\t\tfrappe.show_alert({\n\t\t// \t\t\t\tindicator: 'red',\n\t\t// \t\t\t\tmessage: \"Please select Event or Sales Order to Continue\"\n\t\t// \t\t\t});\n\t\t// \t\t\treturn;\n\t\t// \t\t}\n\n\t\t// \t}\n\t\t\t\n\t\t// }\n\n\t\t\n\t\t\t// me.events.checkout();\n\t\t\t// me.toggle_checkout_btn(false);\n\t\t\t// me.allow_discount_change && me.$add_discount_elem.removeClass(\"d-none\");\n\t\t\n\t\n           \n\t\t// });\n\t\tconst frm = me.events.get_frm();\n        \n        if(frm.doc.items.length){\n\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\tconst $item = me.get_cart_item(item);\t\n                var current_item={}\n                current_item.qty = item.qty\n                if(item.qty==0)\n                {\n                    frappe.throw({\n\t\t\t\t        title: __(\"Check Quantity\"),\n\t\t\t\t         message: __('Item Code: {0} Quantity is Zero.', [item.item_code])\n\t\t\t        })\n                }\n                \n            })}\n\t\t\t\n\t\t\tme.events.checkout();\n\t\t\tme.toggle_checkout_btn(false);\n\t\t\tme.allow_discount_change && me.$add_discount_elem.removeClass(\"d-none\");\n\t\t\n\t\n\t\n        \n\t}); \n\t\t\t//end\n\t\t\t\n\n\t\tthis.$totals_section.on('click', '.edit-cart-btn', () => {\n\t\t\tthis.events.edit_cart();\n\t\t\tthis.toggle_checkout_btn(true);\n\t\t});\n\n\t\tthis.$component.on('click', '.add-discount-wrapper', () => {\n\t\t\tconst can_edit_discount = this.$add_discount_elem.find('.edit-discount-btn').length;\n\n\t\t\tif(!this.discount_field || can_edit_discount) this.show_discount_control();\n\t\t});\n\t\tthis.sosearch_field.$input.on('input', (e) => {\n           \n\t\t\tclearTimeout(this.last_search);\n\t\t\tthis.last_search = setTimeout(() => {\n\t\t\t\tconst search_term = e.target.value;\n                \n\t\t\t\tthis.get_so_detail(search_term);\n\t\t\t}, 300);\n\t\t});\n\t\tfrappe.ui.form.on(\"POS Invoice\", \"paid_amount\", frm => {\n\t\t\t// called when discount is applied\n\t\t\tthis.update_totals_section(frm);\n\t\t});\n        \n\t}\n\t//added by shiby\n\t \n\tasync get_so_detail() {\n        var me=this;\n\t\t//frappe.dom.freeze();\n\t\tconst frm = this.events.get_frm();\n\t\tconst search_term = this.sosearch_field.get_value();\t\n       \n\t\tconst  res = await frappe.db.get_value(\"Sales Order\",{'name': search_term,'pos_status':'Open'}  , \"customer\");\n        \n        if(res.message.customer){\n            \n            const  res1 = await frappe.db.get_value(\"Sales Order\",{'name': search_term,'pos_status':'Open'}  , \"delivery_date\");\n\t\t\t\n\t\t\tif(String(res1.message.delivery_date)==String(frappe.datetime.nowdate()))\n\t\t\t{\n               \n\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', res.message.customer);\t\t\t\t\t\n\t\t\t\tthis.location_info = {};\t\t\n\t\t\t\tthis.load_invoice();\n\t\t\t\tfrappe.db.get_value('Sales Order', {'name': search_term,'pos_status':'Open'}, [\"delivery_date\", \"customer\",\"brand\",\"city\",\"branch\",\"department\"]).then(({ message }) => {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tthis.location_info = { ...message };\n\t\t\t\t\t\t\t\tthis.location_info[\"visitdate\"] = message.delivery_date;\n\t\t\t\t\t\t\t\tthis.location_info[\"so\"] = search_term;\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tthis.location_info[\"brand\"] = message.brand;\n\t\t\t\t\t\t\t\tthis.location_info[\"city\"] = message.city;\n\t\t\t\t\t\t\t\tthis.location_info[\"branch\"] = message.branch;\n\t\t\t\t\t\t\t\tthis.location_info[\"department\"] = message.department;\n\t\t\t\t\t\t\t\tif(cur_pos.cart.location_so_field)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\tcur_pos.cart.location_so_field.set_value(search_term)\n\t\t\t\t\t\t\t\t\tcur_pos.cart.location_visitdate_field.set_value(message.delivery_date)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\tthis.render_location_fields();\n\t\t\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', '');\t\n\t\t\t\t\n\t\t\t\tthis.get_positems('')\t\t\t\t\n\t\t\t\tthis.location_info = {};\t\t\n\t\t\t\tthis.load_invoice();\t\n\t\t\t\tcur_pos.cart.location_so_field.set_value('')\n\t\t\t\tcur_pos.cart.location_visitdate_field.set_value('')\t\n\n\t\t\t\t// frappe.show_alert({\n\t\t\t\t// \tindicator: 'red',\n\t\t\t\t// \tmessage: __('Visit date not matched')\n\t\t\t\t// });\n\t\n\t\t\t}\n\n        }\n        else{\n           \n           var  pos_details=[];\n            frappe.call({\n                method: 'ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_pos_from_rfid',\n                args: {\n                    rfid: search_term?search_term:''\n                },\n                async: false,\n                callback: function(r) {\n                    \n                    if (r && r.message){                        \n                        pos_details = r.message;\n                        var sales_order=\"\",pos_invoice=\"\",customer=\"\";var creation=\"\"; \n                        pos_details.forEach(function (c, index) {\n                            sales_order=c.sales_order\n                            pos_invoice=c.pos_invoice\n                            customer=c.customer\n                            creation=c.creation\n                        })\n                        \n                                             \n                        var postime=new Date(creation)                     \n                        postime.setHours(postime.getHours() + 24) \n                        \n                    //    if(new Date(postime).toLocaleString()>=new Date().toLocaleString()){\n                      \n                        if(new Date(postime).getTime() >= new Date().getTime()){\n                            frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', customer);  \n                            me.location_info = {};\t\t\n                            me.load_invoice();\n                            frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer_pos', pos_invoice);  \n                            frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer_so', sales_order);  \n                       }\n                       else{\n                        frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', '');  \n                        me.location_info = {};\t\t\n                        me.load_invoice();\n                        frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer_pos', undefined);  \n                        frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer_so', undefined);  \n                        // frappe.show_alert({\n                        //     indicator: 'red',\n                        //     message: \"RFID not found...........\"\n                        // });\n\n                       }\n\n                       \n                    }\n                }\n            });\n            \n            \n            \n        }\n       \n\t\t\t\n\t\t\n\t\t\n\t\t\n\t}\n\tset_selected_item($item) {\n\t\tthis.selected_item = $item;\n\t\tthis.$cart_items_wrapper.find('.list-item').removeClass('current-item qty disc rate');\n\t\tthis.selected_item.addClass('current-item');\n\t\t\n\t}\n\tattach_shortcuts() {\n\t\tfor (let row of this.number_pad.keys) {\n\t\t\tfor (let btn of row) {\n\t\t\t\tif (typeof btn !== 'string') continue; // do not make shortcuts for numbers\n\n\t\t\t\tlet shortcut_key = `ctrl+${frappe.scrub(String(btn))[0]}`;\n\t\t\t\tif (btn === 'Delete') shortcut_key = 'ctrl+backspace';\n\t\t\t\tif (btn === 'Remove') shortcut_key = 'shift+ctrl+backspace'\n\t\t\t\tif (btn === '.') shortcut_key = 'ctrl+>';\n\n\t\t\t\t// to account for fieldname map\n\t\t\t\tconst fieldname = this.number_pad.fieldnames[btn] ? this.number_pad.fieldnames[btn] :\n\t\t\t\t\ttypeof btn === 'string' ? frappe.scrub(btn) : btn;\n\n\t\t\t\tlet shortcut_label = shortcut_key.split('+').map(frappe.utils.to_title_case).join('+');\n\t\t\t\tshortcut_label = frappe.utils.is_mac() ? shortcut_label.replace('Ctrl', 'âŒ˜') : shortcut_label;\n\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).attr(\"title\", shortcut_label);\n\n\t\t\t\tfrappe.ui.keys.on(`${shortcut_key}`, () => {\n\t\t\t\t\tconst cart_is_visible = this.$component.is(\":visible\");\n\t\t\t\t\tif (cart_is_visible && this.item_is_selected && this.$numpad_section.is(\":visible\")) {\n\t\t\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).click();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tconst ctrl_label = frappe.utils.is_mac() ? 'âŒ˜' : 'Ctrl';\n\t\tthis.$component.find(\".checkout-btn\").attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+enter\",\n\t\t\taction: () => this.$component.find(\".checkout-btn\").click(),\n\t\t\tcondition: () => this.$component.is(\":visible\") && !this.$totals_section.find('.edit-cart-btn').is(':visible'),\n\t\t\tdescription: __(\"Checkout Order / Submit Order / New Order\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.$component.find(\".edit-cart-btn\").attr(\"title\", `${ctrl_label}+E`);\n\t\tfrappe.ui.keys.on(\"ctrl+e\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tconst checkout_btn_invisible = !this.$totals_section.find('.checkout-btn').is('visible');\n\t\t\tif (item_cart_visible && checkout_btn_invisible) {\n\t\t\t\tthis.$component.find(\".edit-cart-btn\").click();\n\t\t\t}\n\t\t});\n\t\tthis.$component.find(\".add-discount-wrapper\").attr(\"title\", `${ctrl_label}+D`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+d\",\n\t\t\taction: () => this.$component.find(\".add-discount-wrapper\").click(),\n\t\t\tcondition: () => this.$add_discount_elem.is(\":visible\"),\n\t\t\tdescription: __(\"Add Order Discount\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tfrappe.ui.keys.on(\"escape\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tif (item_cart_visible && this.discount_field && this.discount_field.parent.is(\":visible\")) {\n\t\t\t\tthis.discount_field.set_value(0);\n\t\t\t}\n\t\t});\n\t}\n\n\ttoggle_item_highlight(item) {\n\t\tconst $cart_item = $(item);\n\t\tconst item_is_highlighted = $cart_item.attr(\"style\") == \"background-color:var(--gray-50);\";\n\n\t\tif (!item || item_is_highlighted) {\n\t\t\tthis.item_is_selected = false;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').css(\"background-color\", \"\");\n\t\t} else {\n\t\t\t$cart_item.css(\"background-color\", \"var(--gray-50)\");\n\t\t\tthis.item_is_selected = true;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').not(item).css(\"background-color\", \"\");\n\t\t}\n\t}\n\n\tmake_customer_selector() {\n\t\tthis.$customer_section.html(`\n\t\t\t<div class=\"customer-field\"></div>\n\t\t`);\n\t\tconst me = this;\n\t\t// const query = { query: 'erpnext.controllers.queries.customer_query' }; \n\t\tconst query = { query: 'ecs_vim.doctype_triggers.customer.customer.customer_query' }; \n\t\tconst allowed_customer_group = this.allowed_customer_groups || [];\n\t\tif (allowed_customer_group.length) {\n\t\t\tquery.filters = {\n\t\t\t\tcustomer_group: ['in', allowed_customer_group]\n\t\t\t}\n\t\t}\n\t\tthis.customer_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Customer'),\n\t\t\t\tfieldtype: 'Link',\n\t\t\t\toptions: 'Customer',\n\t\t\t\tplaceholder: __('Search by customer name, phone, email.'),\n\t\t\t\tget_query: () => query,\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (this.value) {\n\t\t\t\t\t\t\n\t\t\t\t\t\t//uncomment ,if SO Select\n\t\t\t\t\t\tcur_frm.set_value('customer_pos', undefined);  \n                        cur_frm.set_value('customer_so', undefined);  \n\t\t\t\t\t\tme.get_positems('');\n\t\t\t\t\t\tconst frm = me.events.get_frm();\n\t\t\t\t\t\tfrappe.dom.freeze();\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', this.value);\n\t\t\t\t\t\tfrm.script_manager.trigger('customer', frm.doc.doctype, frm.doc.name).then(() => {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => me.fetch_customer_details(this.value),\n\t\t\t\t\t\t\t\t() => me.events.customer_details_updated(me.customer_info),\n\t\t\t\t\t\t\t\t() => me.update_customer_section(),\n\t\t\t\t\t\t\t\t() => me.update_totals_section(),\n\t\t\t\t\t\t\t\t() => frappe.dom.unfreeze(),\n                                //uncomment ,if SO Select\n                                () => me.render_location_fields(),\n                                () => me.fetch_location_details(),\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t]);\n                            $('.search-item-group').find('.dropdown-menu').find(\"a:first\").trigger(\"click\");\n\t\t\t\t\t\t})\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t   \n\t\t\t\t\t}\n                    //Added by Shiby\n                    \tvar customer=this.value\n                        \n                        // cur_pos.cart.custom_field.set_value('');\n\t\t\t\t\t\t// cur_pos.cart.event_field.set_value('');\n\t\t\t\t\t\t// cur_pos.cart.slot_field.set_value('');\n\t\t\t\t\t\t// cur_pos.cart.visit_date.set_value('');\n\t\t\t\t\t\t\t\t\n                                // cur_pos.cart.location_so_field.get_query= function() {\n\t\t\t\t\t\t\t\t// \treturn {\n\t\t\t\t\t\t\t\t// \t filters: [\n\t\t\t\t\t\t\t\t// \t  [\"Sales Order\",\"customer\", \"=\", customer?customer:''],\n\t\t\t\t\t\t\t\t// \t  [\"Sales Order\",\"docstatus\", \"=\", 1],\n\t\t\t\t\t\t\t\t// \t  [\"Sales Order\",\"status\", \"!=\", 'Closed']\n\t\t\t\t\t\t\t\t// \t ]\n\t\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t\t//    }\n                                   //end\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$customer_section.find('.customer-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.customer_field.toggle_label(false);\n\t}\n//start Added by Shiby\n\n\tupdate_customer_branch(customer){\n\t\tfrappe.call({\n\t\t\tasync:false,\n\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_customer_branch\",\n\t\t\targs: {\n\t\t\t\t'customer': customer,\n\t\t\t\t'pos_profile':cur_frm.doc.pos_profile\n\t\t\t}\n\t\t});\n\n\t}\n\tgetslotDetails(select_event,delivery_date){\n        var resultlist=[];var slotlist=[];\n\t\tfrappe.call({\n\t\t\t\t\"method\": \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_slot_list\",\n\t\t\t\tasync: true,\n\t\t\t\targs:{item_name:select_event?select_event:'',is_new:0,delivery_date:delivery_date?delivery_date:''},\n\t\t\t\tcallback: function (r) {\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tresultlist = (r.message['result_list'] || []);\n\t\t\t\t\t\n\t\t\t\t\tObject.entries(resultlist).forEach(([key, value]) => {\n\t\t\t\t\t\tvar item = \"\";\n\t\t\t\t\t\titem=(value[\"slot_name\"]);\n\t\t\t\t\t\tslotlist.push(item);\n\t\t\t\t\t});\n                    \n\t\t\t\t\t//$(`.slot-field`).set_df_property()\n\t\t\t\t\treturn slotlist;\n\t\t\t\t}})\n\t}\n\t// getbranchDetails(brand){\n    //     var resultlist=[];var slotlist=[];\n\t// \tfrappe.call({\n\t// \t\t\"method\": \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_branch_list\",\n\t// \t\tasync: true,\n\t// \t\targs:{brand:brand?brand:''},\n\t// \t\tcallback: function (r) {\n\t\t\t\t\n\t// \t\t\tresultlist = (r.message['branch_list'] || []);\n\t// \t\t\treturn resultlist;\n\t// \t\t}\n\t// \t})\n\t// }\n\t//end\n\tfetch_customer_details(customer) {\n\t\tif (customer) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tfrappe.db.get_value('Customer', customer, [\"email_id\", \"mobile_no\", \"image\", \"loyalty_program\"]).then(({ message }) => {\n\t\t\t\t\tconst { loyalty_program } = message;\n\t\t\t\t\t// if loyalty program then fetch loyalty points too\n\t\t\t\t\tif (loyalty_program) {\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points\",\n\t\t\t\t\t\t\targs: { customer, loyalty_program, \"silent\": true },\n\t\t\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\t\t\tconst { loyalty_points, conversion_factor } = r.message;\n\t\t\t\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t\t\t\tthis.customer_info = { ...message, customer, loyalty_points, conversion_factor };\n\t\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.customer_info = { ...message, customer };\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tthis.customer_info = {}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t}\n\t}\n\tfetch_location_details(pos_invoice) {\n\t\tvar item_list_data=[];\n        if(cur_pos.cart.location_info && cur_pos.cart.location_info[\"so\"]!=undefined)\n        {\n            \n            this.get_positems('')\n\t\t\t\n\t\t\t\tif(cur_pos.cart.location_info[\"so\"])\n\t\t\t\t{\n\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_payment_entry\",\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\tsorder: cur_pos.cart.location_info[\"so\"]\n\t\t\t\t\t\t},\n\t\t\t\t\t\tasync: false,\n\t\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t\titem_list_data = (r.message['result_list'] || []); \n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tvar allocated_amount = 0;\n\t\t\t\t\t\t\tObject.entries(item_list_data).forEach(([key, value]) => {\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tallocated_amount=flt(value[\"allocated_amount\"])\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tvar child = cur_frm.add_child(\"advances\");\n\t\t\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"allocated_amount\", allocated_amount)\n\t\t\t\t\t\t\tcur_frm.refresh_field(\"advances\")\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\n        }\n       \n\t\tif (pos_invoice) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tfrappe.db.get_value('POS Invoice', pos_invoice, [\"visit_date\", \"sales_order\",\"event\", \"slot\",\"brand\",\"city\",\"branch\",\"department\"]).then(({ message }) => {\n\t\t\t\t\t\n\t\t\t\t\t\tthis.location_info = { ...message };\n\t\t\t\t\t\tthis.location_info[\"visitdate\"] = message.visit_date;\n\t\t\t\t\t\tthis.location_info[\"so\"] = message.sales_order;\n\t\t\t\t\t\tthis.location_info[\"event\"] = message.event;\n\t\t\t\t\t\tthis.location_info[\"event_slot\"] = message.slot;\n\t\t\t\t\t\tthis.location_info[\"brand\"] = message.brand;\n\t\t\t\t\t\tthis.location_info[\"city\"] = message.city;\n\t\t\t\t\t\tthis.location_info[\"branch\"] = message.branch;\n\t\t\t\t\t\tthis.location_info[\"department\"] = message.department;\n\t\t\t\t\t\tif(cur_pos.cart.location_so_field)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tcur_pos.cart.location_so_field.set_value(message.sales_order)\n\t\t\t\t\t\t\tcur_pos.cart.location_visitdate_field.set_value(message.visit_date)\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\n\t\t} else {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tthis.location_info = {}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t}\n\t\t\n\t}\n\tshow_discount_control() {\n\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\tthis.$add_discount_elem.html(\n\t\t\t`<div style=\"display:flex\">\n\t\t\t<div class=\"add-discount-remark-field\">\n\t\t\t<input type=\"text\" id=\"discremark\" name=\"disremark\" placeholder=\"Add Discount Remarks\" style=\"border: none;\n\t\t\tborder-radius: var(--border-radius);\n\t\t\tfont-size: var(--text-md);\n\t\t\theight: 26px;\"><br><br></div>\n\t\t\t<div class=\"add-discount-field\"></div>\n           </div>`\n\t\t);\n\n\t\tconst me = this;\n\t\t\tthis.$component.on('change', '#discremark', function () {\n\t\t\t\n\t\t\t\tme.disremark=$('#discremark').val();\n\t\t\t\n\t\t});\n\t\tthis.discount_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Discount'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Enter discount percentage.'),\n\t\t\t\tinput_class: 'input-xs',\n\t\t\t\tonchange: function() {\n\t\t\t\t\n\t\t\t\t\tconst frm = me.events.get_frm();\n\t\t\t\t\tif(frm.doc.is_approved==0) \n\t\t\t\t\t{\n\t\t\t\t\t\tif (flt(this.value) != 0 ) {\n\t\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', flt(this.value));\n\t\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_remark',String(me.disremark));\n\t\t\t\t\t\t   \n\t\t\t\t\t\t\t me.hide_discount_control(this.value,me.disremark);  \n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', 0);\n\t\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_remark', '');\n\t\t\t\t\t\t\tme.$add_discount_elem.css({\n\t\t\t\t\t\t\t\t'border': '1px dashed var(--gray-500)',\n\t\t\t\t\t\t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tme.$add_discount_elem.html(`${me.get_discount_icon()} Add Discount`);\n\t\t\t\t\t\t\tme.discount_field = undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tme.hide_discount_control(frm.doc.additional_discount_percentage,me.disremark); \n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$add_discount_elem.find('.add-discount-field'),\n\t\t\trender_input: true,\n\t\t});\n        \n\t\tthis.discount_field.toggle_label(false);\n\t\tthis.discount_field.set_focus();\n\t\t\n\t}\n    update_discount(remarks,discount)\n    {\n        \n\t\tif(discount>0)\n\t\t{\n\t\t\tconst frm = this.events.get_frm();\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_remark',remarks);\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage',discount);\n            \n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'is_approved',1);\n\t\t\tthis.disremark=remarks\n\t\t\tthis.discount_field=flt(discount);       \n\t\t\tthis.update_totals_section();\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'display': 'flex'})\n\t\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t\t});\n\t\t\tthis.$cart_container.find('.save-as-draft-btn').css({\n\t\t\t\t'display': 'none'})\n\t\t}\n        \n                       \n    }\n    update_discount_so(disc_perc,discount)\n    {\n        \n\t\tif(disc_perc>0)\n\t\t{\n\t\t\tconst frm = this.events.get_frm();\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage',disc_perc);\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'is_approved',1);\n\t\t\tthis.discount_field=flt(discount);       \n\t\t\tthis.update_totals_section();\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'display': 'flex'})\n\t\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t\t});\n\t\t\tthis.$cart_container.find('.save-as-draft-btn').css({\n\t\t\t\t'display': 'none'})\n\t\t}\n        else if (discount>0){\n            const frm = this.events.get_frm();\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage',0);\n            frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_amount',discount);\n\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'is_approved',1);\n\t\t\tthis.discount_field=flt(discount);       \n\t\t\t\n            const currency = this.events.get_frm().doc.currency;\n            this.$add_discount_elem.html(\n                `<div class=\"edit-discount-btn\" display: flex; style=\"color:white !important\" >\n                    ${this.get_discount_icon()}Discount&nbsp;${String(0).bold()}&nbsp;% &nbsp; ${String('')}\n                </div>\n                <div class=\"discount-amount\"> \n                ${format_currency(String(discount), currency,2)}\n                </div>`\n            );\n            this.update_totals_section();\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'display': 'flex'})\n\t\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t\t});\n\t\t\tthis.$cart_container.find('.save-as-draft-btn').css({\n\t\t\t\t'display': 'none'})\n        }\n       \n        \n                       \n    }\n//add and commented by shiby\n\thide_discount_control(discount,remark) {\n\tif (!discount) {\n        \n\t\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\t\tthis.$add_discount_elem.html(\n\t\t\t\t`<div class=\"add-discount-field\"></div>`\n\t\t\t);\n         this.toggle_checkout_btn(true);\n         this.$cart_container.find('.save-as-draft-btn').css({\n         'display': 'none'})\n        \n\t} else {\n\t\n\t\tthis.$add_discount_elem.css({\n\t\t\t'border': '1px dashed var(--white)',\n            'color':'white'\n            \n\t\t});\n\t\tconst frm = this.events.get_frm();\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tvar remarks=''\n\t\t\n\t\tthis.$add_discount_elem.html(\n\t\t\t`<div class=\"edit-discount-btn\" style=\"color:white !important\" >\n\t\t\t\t${this.get_discount_icon()}Discount&nbsp;${String(discount).bold()}&nbsp;% &nbsp; ${String(this.disremark)}\n\t\t\t</div>\n\t\t\t<div class=\"discount-amount\"> \n\t\t\t${format_currency(String(frm.doc.base_total*discount/100), currency,2)}\n\t\t\t</div>`\n\t\t);\n\t\tif(discount>0)\n        {\n            \n            frappe.db.get_value('POS Profile',  cur_frm.doc.pos_profile, [\"discount_approval_required\"]).then(({ message }) => {\n                this.discount_approval_required=message.discount_approval_required;\n                \n                if(message.discount_approval_required && message.discount_approval_required==1 && cur_frm.doc.is_approved==0)\n                {\n                    frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_approval_required', 1);\n                  \n                        this.$cart_container.find('.checkout-btn').css({\n                            'background-color': 'var(--blue-200)',\n                            'display':'none'\n                        });\n                        this.$cart_container.find('.save-as-draft-btn').css({'background-color': 'var(--blue-500)',\n                            'display': 'flex',\n                            'color': '#fff',\n                            'align-items': 'center',\n                            'justify-content': 'center',\n                            'padding': 'var(--padding-sm)',\n                            'margin-top': 'var(--margin-sm)',\n                            'border-radius': 'var(--border-radius-md)',\n                            'font-size': 'var(--text-lg)',\n                            'font-weight': '700',\n                        \n                            'cursor': 'pointer'})\n                           // this.create_discount_popup();\n                    \n                }\n    \n            });\n        }\n        \n        frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_approval_required', 0);\n       \n      \n\t}\n   \n\n\t}\n   \n\t// hide_discount_control(discount) {\n\t// \tif (!discount) {\n\t// \t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t// \t\tthis.$add_discount_elem.html(\n\t// \t\t\t`<div class=\"add-discount-field\"></div>`\n\t// \t\t);\n\t// \t} else {\n\t// \t\tthis.$add_discount_elem.css({\n\t// \t\t\t'border': '1px dashed var(--dark-green-500)',\n\t// \t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t// \t\t});\n\t// \t\tthis.$add_discount_elem.html(\n\t// \t\t\t`<div class=\"edit-discount-btn\">\n\t// \t\t\t\t${this.get_discount_icon()} Additional&nbsp;${String(discount).bold()}% discount applied\n\t// \t\t\t</div>`\n\t// \t\t);\n\t// \t}\n\t// }\n\n\tupdate_customer_section() {\n\t\tconst me = this;\n\t\tconst { customer, email_id='', mobile_no='', image } = this.customer_info || {}; \n\n\t\tif (customer) {\n\t\t\tthis.$customer_section.html(\n\t\t\t\t`<div class=\"customer-details\">\n\t\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t\t<div class=\"customer-name\">${customer}4</div>\n\t\t\t\t\t\t\t${get_customer_description()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"reset-customer-btn\" data-customer=\"${escape(customer)}\">\n\t\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`\n\t\t\t);\n\t\t\t\n\t\t} else {\n\t\t\t// reset customer selector\n\t\t\tthis.reset_customer_selector();\n\t\t}\n\n\t\tfunction get_customer_description() {\n\t\t\tif (!email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">Click to add email / phone</div>`;\n\t\t\t} else if (email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id}</div>`;\n\t\t\t} else if (mobile_no && !email_id) {\n\t\t\t\t\n\t\t\t\treturn `<div class=\"customer-desc\">${mobile_no}</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id} - ${mobile_no}</div>`;\n\t\t\t}\n\t\t}\n\n\t}\n\t\n\tget_customer_image() {\n\t\tconst { customer, image } = this.customer_info || {};\n\t\tif (image) {\n\t\t\treturn `<div class=\"customer-image\"><img src=\"${image}\" alt=\"${image}\"\"></div>`;\n\t\t} else {\n\t\t\treturn `<div class=\"customer-image customer-abbr\">${frappe.get_abbr(customer)}</div>`;\n\t\t}\n\t}\n\n\tupdate_totals_section(frm) {\n\t\t\n\t\n\t\tif (!frm) frm = this.events.get_frm();\n       \n\t\tthis.render_discount()\n\t\tthis.render_net_total(frm.doc.net_total);\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? frm.doc.grand_total : frm.doc.rounded_total;\n\t\t\n\t\tthis.render_grand_total(grand_total);\n\n\t\tconst taxes = frm.doc.taxes.map(t => {\n\t\t\treturn {\n\t\t\t\tdescription: t.description, rate: t.rate\n\t\t\t};\n\t\t});\n\t\tthis.render_taxes(frm.doc.total_taxes_and_charges, taxes);\n       \n\t\t\n\t}\n    \n\tupdate_totals_section_after_approval(frm) {\n\t\t\n\t\t\n\t\tif (!frm) frm = this.events.get_frm();\n\t\t\n\t\tthis.render_net_total(frm.doc.net_total);\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? frm.doc.grand_total : frm.doc.rounded_total;\n\t\t\n\t\tthis.render_grand_total(grand_total);\n\n\t\tconst taxes = frm.doc.taxes.map(t => {\n\t\t\treturn {\n\t\t\t\tdescription: t.description, rate: t.rate\n\t\t\t};\n\t\t});\n\t\tthis.render_taxes(frm.doc.total_taxes_and_charges, taxes);\n\t\t\n\t}\n\trender_net_total(value) {\n\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.net-total-container').html(\n\t\t\t`<div>Net Total</div><div>${format_currency(value, currency,2)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-net-total').html(\n\t\t\t`<div>Net Total: <span>${format_currency(value, currency,2)}</span></div>`\n\t\t);\n\t}\n\n\trender_grand_total(value) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.grand-total-container').html(\n\t\t\t`<div>Grand Total</div><div>${format_currency(value, currency,2)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-grand-total').html(\n\t\t\t`<div>Grand Total: <span>${format_currency(value, currency,2)}</span></div>`\n\t\t);\n\t}\n\trender_discount(){\n\t\n\t\tif(this.discount_field)\n\t\t{\n\t\t\t//this.discount_field.set_value(flt(cur_frm.doc.additional_discount_percentage));\n\t\t\tthis.disremark=cur_frm.doc.discount_remark\n\t\t\tthis.hide_discount_control(cur_frm.doc.additional_discount_percentage,cur_frm.doc.discount_remark);\n            \n\t\t\n\t\t}\n\t\telse{\n\t\t\tthis.show_discount_control()\n\t\t\tthis.discount_field.set_value(flt(cur_frm.doc.additional_discount_percentage));\n\t\t\tthis.disremark=cur_frm.doc.discount_remark\n\t\t\tthis.hide_discount_control(cur_frm.doc.additional_discount_percentage,cur_frm.doc.discount_remark);\n\t\t\n\t\t}\n\t\t\n\t\t// if(cur_pos.cart.discount_field)\n\t\t// { \n\t\t// \tconsole.log(cur_pos.cart.discount_field,\"1\")\t\t\t       \n        //     this.discount_field=cur_frm.doc.additional_discount_percentage;        \n\t\t// \tthis.hide_discount_control(this.discount_field,'');\n\t\t// }\n\t\t// else\n\t\t// {\n\t\t// \tthis.hide_discount_control(0,'');  \n\t\t\t\n\t\t// }\n\t\t\n\t\t// frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', flt(10));\n\t\t// console.log(\"renderdisc\")\n\t\t// const frm = this.events.get_frm();\n\t\t// const currency=this.events.get_frm().doc.currency;\n\t\t// this.$totals_section.find('.add-discount-field').html(\n\t\t// \t`<div class=\"edit-discount-btn\" >\n\t\t// \t\t${this.get_discount_icon()}Discount&nbsp;${String(5).bold()}&nbsp;%\n\t\t// \t</div>\n\t\t// \t<div class=\"discount-amount\"> \n\t\t// \t${format_currency(String(frm.doc.grand_total*10/100), currency)}\n\t\t// \t</div>`\n\t\t\n\t\t//);\n\n\t}\n\trender_taxes(value, taxes) {\n\t\tif (taxes.length) {\n\t\t\tconst currency = this.events.get_frm().doc.currency;\n\t\t\tconst taxes_html = taxes.map(t => {\n\t\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\n\t\t\t\treturn `<div class=\"tax-row\">\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(value, currency,2)}</div>\n\t\t\t\t</div>`;\n\t\t\t}).join('');\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'flex').html(taxes_html);\n\t\t} else {\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'none').html('');\n\t\t}\n\t}\n\n\tget_cart_item({ name }) {\n\t\t// const batch_attr = `[data-batch-no=\"${escape(batch_no)}\"]`;\n\t\t// const item_code_attr = `[data-item-code=\"${escape(item_code)}\"]`;\n\t\t// const uom_attr = `[data-uom=\"${escape(uom)}\"]`;\n        \n\t\t// const item_selector = batch_no ?\n\t\t// \t`.cart-item-wrapper${batch_attr}${uom_attr}` : `.cart-item-wrapper${item_code_attr}${uom_attr}`;\n\n\t\t// return this.$cart_items_wrapper.find(item_selector);\n        const item_selector = `.cart-item-wrapper[data-row-name=\"${escape(name)}\"]`;\n        console.log(item_selector,\"item_selector\")\n\t\treturn this.$cart_items_wrapper.find(item_selector);\n\t}\n    get_free_item(item) {\n        console.log(item,\"FFFFFFFFFFFF\")\n        const doc = this.events.get_frm().doc;\n        \n        var item_row=doc.items.find(i => i.name == item.name && i.uom == item.uom && i.rate == item.rate);\n        console.log(item_row,\"FFFFFFFFFFFF\")\n\t\treturn doc.items.find(i => i.parent_item_row == item_row.parent_item_row && i.is_free_item == 1);\n\t}\n    get_item_from_frm(item) {\n\t\tconst doc = this.events.get_frm().doc;\n        \n\t\treturn doc.items.find(i => i.name == item.name && i.uom == item.uom && i.rate == item.rate);\n\t}\n\tupdate_item_html(item, remove_item) {\n       \n\t\tconst $item = this.get_cart_item(item);\t\n\t\tif (remove_item) {\n            $item && $item.next().remove() && $item.remove(); \n            const no_items = this.$cart_items_wrapper.find('.cart-item-wrapper').length;\n            setTimeout(() => {\n                this.$cart_items_wrapper.html('');\n                this.make_no_items_placeholder();\n             cur_frm.doc.items.forEach(item => {\n\n                cur_pos.cart.update_item_html(item);\n            });\n             \n            }, 800);\n            console.log(no_items,\"no_items\")\n            // const frm = this.events.get_frm();\n            // this.update_totals_section(frm);\n\t\t} else {\n            const item_row = this.get_item_from_frm(item);\n           \n            this.render_cart_item(item_row, $item);\n\t\t\t// const { item_code, batch_no, uom } = item;\n\t\t\t// const search_field = batch_no ? 'batch_no' : 'item_code';\n\t\t\t// const search_value = batch_no || item_code;\n\t\t\t// const item_rowp = this.events.get_frm().doc.items.find(i => i[search_field] === search_value && i.uom === uom );\n\t\t\t\n\t\t\t// this.render_cart_item(item_rowp, $item)\n\t\t}\n\n\t\tconst no_of_cart_items = this.$cart_items_wrapper.find('.cart-item-wrapper').length;\n\t\tthis.highlight_checkout_btn(no_of_cart_items > 0);\n        console.log(no_of_cart_items,\"no_of_cart_items\",remove_item)\n\t\tthis.update_empty_cart_section(no_of_cart_items);\n        \n\t\t\n\t}\n   \n\tupdate_item_html_uom(item, removnuom,convfactore_item) {\n\t\t\n\t\tconst $item = this.get_cart_item(item);\t\n\t\t\n\t\t\tconst { item_code, batch_no, uom,slot_name } = item;\n\t\t\tconst search_field = batch_no ? 'batch_no' : 'item_code';\n\t\t\tconst search_value = batch_no || item_code;\n\t\t\tconst item_rowp = this.events.get_frm().doc.items.find(i => i[search_field] === search_value && i.uom === uom);\n\t\t\t\n\t\t\tthis.render_cart_item(item_rowp, $item);\n\t\t\t\n\t\t\n\n\t\tconst no_of_cart_items = this.$cart_items_wrapper.find('.cart-item-wrapper').length;\n\t\tthis.highlight_checkout_btn(no_of_cart_items > 0);\n\n\t\tthis.update_empty_cart_section(no_of_cart_items);\n\t}\n\trender_cart_item(item_data, $item_to_update) {\n       \n\t\t\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tconst me = this;\n        \n\t\tif (!$item_to_update.length) {\n           \n\t\t\tthis.$cart_items_wrapper.append(\n\t\t\t\t`<div class=\"cart-item-wrapper\"\n                        data-row-name=\"${escape(item_data.name)}\"\n\t\t\t\t\t\tdata-item-code=\"${escape(item_data.item_code)}\" data-uom=\"${escape(item_data.uom)}\"\n\t\t\t\t\t\tdata-batch-no=\"${escape(item_data.batch_no || '')}\"\n                        data-minimum-sales-qty=\"${escape(cur_pos.item_selector.minimum_sales_quantity)}\"\n                        data-maximum-sales-qty=\"${escape(cur_pos.item_selector.maximum_sales_quantity)}\"\n                        data-bundle-item=\"${escape(cur_pos.item_selector.bundle_item)}\"\n\t\t\t\t\t\tdata-item-rate=\"${escape(item_data.rate)}\"\n                        data-item-free=\"${escape(item_data.is_free_item)}\">\n\t\t\t\t</div>\n\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t)\n            // this.$cart_items_wrapper.append(\n\t\t\t// \t`<div class=\"cart-item-wrapper\" data-row-name=\"${escape(item_data.name)}\"></div>\n\t\t\t// \t<div class=\"seperator\"></div>`\n\t\t\t// )\n\t\t\t$item_to_update = this.get_cart_item(item_data);\n\t\t}\n        \n        if(cur_pos.cart.location_so_field.value){\n            //console.log(cur_pos.cart.location_so_field.value,\"console.log(cur_pos.cart.location_so_field)\")\n            //setTimeout(() => {\n                $item_to_update.html(\n                    `${get_item_image_html()}\n                    <div class=\"item-name-desc\">\n                        <div class=\"item-name\">\n                            ${item_data.item_name}\n                        </div>\n                        ${get_description_html()}\n                    </div>\n                    ${get_rate_discount_html()}`\n                )\n                $('.btn-xs').css('line-height','1.8')\n                $('.item-qty').css('width','110px')\n            // }, 800);\n\n        }\n        else{\n            \n            setTimeout(() => {\n                $item_to_update.html(\n                    `${get_item_image_html()}\n                    <div class=\"item-name-desc\">\n                        <div class=\"item-name\">\n                            ${item_data.item_name}\n                        </div>\n                        ${get_description_html()}\n                    </div>\n                    ${get_rate_discount_html()}`\n                )\n                $('.btn-xs').css('line-height','1.8')\n                $('.item-qty').css('width','110px')\n             }, 500);\n        }\n\t\t\n\t\t\n\t\t//added by tushar\n            // this.check_minimum_sales_qty=false;\n\t\t\t// if(!this.custom_change_call)\n            //  { \n\t\t\t// \t var s = $('.cart-item-wrapper .item-amount').text();\n\t\t\t// \tvar k = s.split(\" \")\n\t\t\t\t\n\t\t\t// \tconsole.log(item_data,frappe.model.get_value(item_data.doctype, item_data.name,'rate'),\"get_value\")\n\t\t\t// \tif (k.length>1 && flt(k[k.length-1] )==flt(item_data.rate) )\n\t\t\t// \t{\t\n\t\t\t// \t\tif(\tthis.old_val_set<10){\n\t\t\t// \t\t\tthis.old_val_set += 1;\n\t\t\t// \t\t}\n\t\t\t// \t\telse\n\t\t\t// \t\tthis.custom_change_call = true; \n\t\t\t// \t\t}\n            //     $('.cart-item-wrapper .quantity input').change();\n\t\t\t// }\n            //     this.check_minimum_sales_qty=true;\n        ///////////////////////////////\n\t\t\n\t\t\n\t\tset_dynamic_rate_header_width();\n\t\tthis.scroll_to_item($item_to_update);\n\n\t\tfunction set_dynamic_rate_header_width() {\n\t\t\tconst rate_cols = Array.from(me.$cart_items_wrapper.find(\".item-rate-amount\"));\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", \"\");\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", \"\");\n\t\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\n\t\t\t\tif ($(elm).width() > max_width)\n\t\t\t\t\tmax_width = $(elm).width();\n\t\t\t\treturn max_width;\n\t\t\t}, 0);\n\n\t\t\tmax_width += 1;\n\t\t\tif (max_width == 1) max_width = \"\";\n\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", max_width);\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", max_width);\n\t\t}\n\t\t\t\t\t\n\t\t// function get_rate_discount_html() {\n\t\t// \tif (item_data.rate && item_data.amount && item_data.rate !== item_data.amount) {\n\t\t// \t\treturn `\n\t\t// \t\t\t<div class=\"item-qty-rate\">\n\t\t// \t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t// \t\t\t\t<div class=\"item-rate-amount\">\n\t\t// \t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.amount, currency)}</div>\n\t\t// \t\t\t\t\t<div class=\"item-amount\">${format_currency(item_data.rate, currency)}</div>\n\t\t// \t\t\t\t</div>\n\t\t// \t\t\t</div>`\n\t\t// \t} else {\n\t\t// \t\treturn `\n\t\t// \t\t\t<div class=\"item-qty-rate\">\n\t\t// \t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t// \t\t\t\t<div class=\"item-rate-amount\">\n\t\t// \t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, currency)}</div>\n\t\t// \t\t\t\t</div>\n\t\t// \t\t\t</div>`\n\t\t// \t}\n\t\t// }\n\t\t//Comment and updated by shiby \n\t\tfunction get_rate_discount_html() {\n            let _item = Object.assign({}, item_data)\n\t\t\t\n\t\t\tif (item_data.rate && item_data.amount && item_data.rate !== item_data.amount) {\n\t\t\t\t\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\">\n\t\t\t\t\t\t<div class=\"quantity list-item__content text-right\">\n\t\t\t\t\t\t<div class=\"input-group input-group-xs\">\n\t\t\t\t\t<span class=\"input-group-btn\">\n\t\t\t\t\t\t<button class=\"btn-default btn-xs\" data-action=\"increment\">+</button>\n\t\t\t\t\t</span>\n\n\t\t\t\t\t<input class=\"form-control\" type=\"number\" value=\"${item_data.qty || 0}\" style=\"padding: unset;text-align:right\">\n\n\t\t\t\t\t<span class=\"input-group-btn\">\n\t\t\t\t\t\t<button class=\"btn-default btn-xs\" data-action=\"decrement\">-</button>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.amount, currency,2)}</div>\n\t\t\t\t\t\t\t<div class=\"item-amount\">${format_currency(item_data.rate, currency,2)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t} else {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\">\n\t\t\t\t\t\t<div class=\"quantity list-item__content text-right\">\n\t\t\t\t\t\t<div class=\"input-group input-group-xs\">\n\t\t\t\t\t<span class=\"input-group-btn\">\n\t\t\t\t\t\t<button class=\"btn-default btn-xs\" data-action=\"increment\">+</button>\n\t\t\t\t\t</span>\n\n\t\t\t\t\t<input class=\"form-control\" type=\"number\" value=\"${item_data.qty || 0}\" style=\"text-align:right;padding: unset;\">\n\n\t\t\t\t\t<span class=\"input-group-btn\">\n\t\t\t\t\t\t<button class=\"btn-default btn-xs\" data-action=\"decrement\">-</button>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, currency,2)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t}\n\n\t\t}\n\n\t\tfunction get_description_html() {\n\t\t\tif (item_data.description) {\n\t\t\t\tif (item_data.description.indexOf('<div>') != -1) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\titem_data.description = $(item_data.description).text();\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\titem_data.description = item_data.description.replace(/<div>/g, ' ').replace(/<\\/div>/g, ' ').replace(/ +/g, ' ');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\titem_data.description = frappe.ellipsis(item_data.description, 45);\n\t\t\t\treturn `<div class=\"item-desc\">${item_data.description}</div>`;\n\t\t\t}\n\t\t\treturn ``;\n\t\t}\n\n\t\tfunction get_item_image_html() {\n\t\t\tconst { image, item_name } = item_data;\n\t\t\tif (image) {\n\t\t\t\treturn `<div class=\"item-image\"><img src=\"${image}\" alt=\"${image}\"\"></div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-image item-abbr\">${frappe.get_abbr(item_name)}</div>`;\n\t\t\t}\n\t\t}\n\t\t\n\t\n\t}\n\n\tscroll_to_item($item) {\n\t\tif ($item.length === 0) return;\n\t\tconst scrollTop = $item.offset().top - this.$cart_items_wrapper.offset().top + this.$cart_items_wrapper.scrollTop();\n\t\tthis.$cart_items_wrapper.animate({ scrollTop });\n\t}\n\n\tupdate_selector_value_in_cart_item(selector, value, item) {\n\t\tconst $item_to_update = this.get_cart_item(item);\n\t\t$item_to_update.attr(`data-${selector}`, escape(value));\n\t}\n\n\ttoggle_checkout_btn(show_checkout) {\n\t\tif (show_checkout) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'flex');\n\t\t}\n\t}\n\n\thighlight_checkout_btn(toggle) {\n\t\tif (toggle) {\n\t\t\tthis.$add_discount_elem.css('display', 'flex');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.$add_discount_elem.css('display', 'none');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-200)'\n\t\t\t});\n\t\t}\n\t}\n\n\tupdate_empty_cart_section(no_of_cart_items) {\n\t\tconst $no_item_element = this.$cart_items_wrapper.find('.no-item-wrapper');\n\n\t\t// if cart has items and no item is present\n\t\tno_of_cart_items > 0 && $no_item_element && $no_item_element.remove() && this.$cart_header.css('display', 'flex');\n\n\t\tno_of_cart_items === 0 && !$no_item_element.length && this.make_no_items_placeholder();\n\t}\n\n\ton_numpad_event($btn) {\n\t\tconst current_action = $btn.attr('data-button-value');\n\t\tconst action_is_field_edit = ['qty', 'discount_percentage', 'rate'].includes(current_action);\n\t\tconst action_is_allowed = action_is_field_edit ? (\n\t\t\t(current_action == 'rate' && this.allow_rate_change) ||\n\t\t\t(current_action == 'discount_percentage' && this.allow_discount_change) ||\n\t\t\t(current_action == 'qty')) : true;\n\n\t\tconst action_is_pressed_twice = this.prev_action === current_action;\n\t\tconst first_click_event = !this.prev_action;\n\t\tconst field_to_edit_changed = this.prev_action && this.prev_action != current_action;\n\n\t\tif (action_is_field_edit) {\n\t\t\tif (!action_is_allowed) {\n\t\t\t\tconst label = current_action == 'rate' ? 'Rate'.bold() : 'Discount'.bold();\n\t\t\t\tconst message = __('Editing {0} is not allowed as per POS Profile settings', [label]);\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tindicator: 'red',\n\t\t\t\t\tmessage: message\n\t\t\t\t});\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (first_click_event || field_to_edit_changed) {\n\t\t\t\tthis.prev_action = current_action;\n\t\t\t} else if (action_is_pressed_twice) {\n\t\t\t\tthis.prev_action = undefined;\n\t\t\t}\n\t\t\tthis.numpad_value = '';\n\n\t\t} else if (current_action === 'checkout') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else if (current_action === 'remove') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n            \n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else {\n\t\t\tthis.numpad_value = current_action === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + current_action;\n\t\t\tthis.numpad_value = this.numpad_value || 0;\n\t\t}\n\n\t\tconst first_click_event_is_not_field_edit = !action_is_field_edit && first_click_event;\n\n\t\tif (first_click_event_is_not_field_edit) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tindicator: 'red',\n\t\t\t\tmessage: __('Please select a field to edit from numpad')\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (flt(this.numpad_value) > 100 && this.prev_action === 'discount_percentage') {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __('Discount cannot be greater than 100%'),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\tthis.numpad_value = current_action;\n\t\t}\n\n\t\tthis.highlight_numpad_btn($btn, current_action);\n\t\tthis.events.numpad_event(this.numpad_value, this.prev_action);\n\t}\n    \n    \n\thighlight_numpad_btn($btn, curr_action) {\n\t\tconst curr_action_is_highlighted = $btn.hasClass('highlighted-numpad-btn');\n\t\tconst curr_action_is_action = ['qty', 'discount_percentage', 'rate', 'done'].includes(curr_action);\n\n\t\tif (!curr_action_is_highlighted) {\n\t\t\t$btn.addClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action === curr_action && curr_action_is_highlighted) {\n\t\t\t// if Qty is pressed twice\n\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action && this.prev_action !== curr_action && curr_action_is_action) {\n\t\t\t// Order: Qty -> Rate then remove Qty highlight\n\t\t\tconst prev_btn = $(`[data-button-value='${this.prev_action}']`);\n\t\t\tprev_btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (!curr_action_is_action || curr_action === 'done') {\n\t\t\t// if numbers are clicked\n\t\t\tsetTimeout(() => {\n\t\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t\t}, 200);\n\t\t}\n\t}\n\n\ttoggle_numpad(show) {\n\t\tif (show) {\n\t\t\tthis.$totals_section.css('display', 'none');\n\t\t\tthis.$numpad_section.css('display', 'flex');\n\t\t} else {\n\t\t\tthis.$totals_section.css('display', 'flex');\n\t\t\tthis.$numpad_section.css('display', 'none');\n\t\t}\n\t\tthis.reset_numpad();\n\t}\n  \n\treset_numpad() {\n\t\tthis.numpad_value = '';\n\t\tthis.prev_action = undefined;\n\t\tthis.$numpad_section.find('.highlighted-numpad-btn').removeClass('highlighted-numpad-btn');\n\t}\n\n\ttoggle_numpad_field_edit(fieldname) {\n\t\tif (['qty', 'discount_percentage', 'rate'].includes(fieldname)) {\n\t\t\tthis.$numpad_section.find(`[data-button-value=\"${fieldname}\"]`).click();\n\t\t}\n\t}\n\n\t// toggle_customer_info(show) {\n\t// \tif (show) {\n\t// \t\tconst { customer } = this.customer_info || {};\n           \n\t// \t\tthis.$cart_container.css('display', 'none');\n\t// \t\tthis.$customer_section.css({\n\t// \t\t\t'height': '100%',\n\t// \t\t\t'padding-top': '0px'\n\t// \t\t});\n\t// \t\tthis.$customer_section.find('.customer-details').html(\n\t// \t\t\t`<div class=\"header\">\n\t// \t\t\t\t<div class=\"label\">Contact Details</div>\n\t// \t\t\t\t<div class=\"close-details-btn\">\n\t// \t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t// \t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t// \t\t\t\t\t</svg>\n\t// \t\t\t\t</div>\n\t// \t\t\t</div>\n\t// \t\t\t<div class=\"customer-display\">\n\t// \t\t\t\t${this.get_customer_image()}\n\t// \t\t\t\t<div class=\"customer-name-desc\">\n\t// \t\t\t\t\t<div class=\"customer-name\">${customer}5</div>\n\t// \t\t\t\t\t<div class=\"customer-desc\"></div>\n\t// \t\t\t\t</div>\n\t// \t\t\t</div>\n\t// \t\t\t<div class=\"customer-fields-container\">\n\t// \t\t\t\t<div class=\"email_id-field\"></div>\n\t// \t\t\t\t<div class=\"mobile_no-field\"></div>\n\t// \t\t\t\t<div class=\"loyalty_program-field\"></div>\n\t// \t\t\t\t<div class=\"loyalty_points-field\"></div>\n\t// \t\t\t</div>\n\t\t\t\t\n\t// \t\t\t<div class=\"location-fields-container\">\n\t// \t\t\t<div class=\"visitdate-field\"></div>\n\t// \t\t\t<div class=\"so-field\"></div>\n\t// \t\t\t<div class=\"event-field\"></div>\n\t// \t\t\t<div class=\"event_slot-field\"></div>\n\t\t\t\t\n\t// \t\t\t\t<div class=\"brand-field\"></div>\n\t// \t\t\t\t<div class=\"city-field\"></div>\n\t// \t\t\t\t<div class=\"branch-field\"></div>\n\t// \t\t\t\t<div class=\"department-field\"></div>\n\t// \t\t\t</div>\n\t// \t\t\t<div class=\"transactions-label\">Recent Transactions</div>`\n\t// \t\t);\n\t// \t\t//added by shiby\n\n    //         $('.location-fields-container').css({\n\t// \t\t\t\t'background-color': '#0799a3bd',\n\t// \t\t\t\t'display': 'grid',\n\t// \t\t\t\t'grid-template-columns': 'repeat(2,minmax(0,1fr))',\n\t// \t\t\t\t'margin-top': 'var(--margin-md)',\n\t// \t\t\t\t'-moz-column-gap': 'var(--padding-sm)',\n\t// \t\t\t\t'column-gap': 'var(--padding-sm)',\n\t// \t\t\t\t'row-gap': 'var(--padding-xs)',\n\t// \t\t\t\t'padding-right': '3px',\n\t// \t\t\t\t'padding-left': '3px'\n    //         });\n\t// \t\tthis.$customer_section.append(`<div class=\"location-details\"></div>`);\n\t// \t\t//\n\t// \t\t// transactions need to be in diff div from sticky elem for scrolling\n\t// \t\tthis.$customer_section.append(`<div class=\"customer-transactions\"></div>`);\n            \n\n\t// \t\tthis.render_customer_fields();\n\t// \t\t//added by shiby\n\t// \t\tthis.render_location_fields();\n\t// \t\t//\n\t\t  \n\t// \t\tthis.fetch_customer_transactions();\n\n\t// \t} else {\n\t\t\t\n\t// \t\tif(this.non_sharable_slot==1 )\n\t// \t\t\t{\n\t// \t\t\t\tif(!cur_pos.cart.location_visitdate_field.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tmessage: __(\"Please select Visit Date.\"),\n\t// \t\t\t\t\t\tindicator: 'red'\n\t// \t\t\t\t\t})\n\t// \t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\n\t// \t\t\t\t}\n\t// \t\t\t\tif(!cur_pos.cart.location_event_slot_field.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tmessage: __(\"Please select slot.\"),\n\t// \t\t\t\t\t\tindicator: 'red'\n\t// \t\t\t\t\t})\n\t// \t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\n\t// \t\t\t\t}\n\t// \t\t\t\tif(!cur_pos.cart.location_brand_field.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tmessage: __(\"Please select brand.\"),\n\t// \t\t\t\t\t\tindicator: 'red'\n\t// \t\t\t\t\t})\n\t// \t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\n\t// \t\t\t\t}\n\t// \t\t\t\tif(!cur_pos.cart.location_city_field.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tmessage: __(\"Please select city.\"),\n\t// \t\t\t\t\t\tindicator: 'red'\n\t// \t\t\t\t\t})\n\t// \t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\n\t// \t\t\t\t}\n\t// \t\t\t\tif(!cur_pos.cart.location_branch_field.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tmessage: __(\"Please select branch.\"),\n\t// \t\t\t\t\t\tindicator: 'red'\n\t// \t\t\t\t\t})\n\t// \t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\n\t// \t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t// \t\t\t}\n\t// \t\t\tthis.$cart_container.css('display', 'flex');\n\t// \t\tthis.$customer_section.css({\n\t// \t\t\t'height': '',\n\t// \t\t\t'padding-top': ''\n\t// \t\t});\n\n\t// \t\tthis.update_customer_section();\n           \n\t\t\t\t\n\t// }\n\t\t\t\n\t// }\n\ttoggle_customer_info(show) {\n\t\tif (show) {\n\t\t\tconst { customer } = this.customer_info || {};\n           \n\t\t\tthis.$cart_container.css('display', 'none');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '100%',\n\t\t\t\t'padding-top': '0px'\n\t\t\t});\n\t\t\tthis.$customer_section.find('.customer-details').html(\n\t\t\t\t`<div class=\"header\">\n\t\t\t\t\t<div class=\"label\">Contact Details</div>\n\t\t\t\t\t<div class=\"close-details-btn\">\n\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t<div class=\"customer-name\">${customer}6</div>\n\t\t\t\t\t\t<div class=\"customer-desc\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-fields-container\">\n\t\t\t\t\t<div class=\"email_id-field\"></div>\n\t\t\t\t\t<div class=\"mobile_no-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_program-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_points-field\"></div>\n                   \n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t \n                 <div class=\"btn edit-customer-btn\"  style=\"background-color: rgba(7, 153, 163, 0.74);font-weight: bold\">Edit Customer</div>\n\t\t\t\t<div class=\"transactions-label\">Recent Transactions</div>`\n\t\t\t);\n\t\t\t//added by shiby\n\n           \n\t\t\tthis.$customer_section.append(`<div class=\"location-details\"></div>`);\n\t\t\t//\n\t\t\t// transactions need to be in diff div from sticky elem for scrolling\n\t\t\tthis.$customer_section.append(`<div class=\"customer-transactions\"></div>`);\n            const me = this;\n            this.$customer_section.on('click', '.edit-customer-btn', function () {\n               \n                window.open('#Form/Customer/'+me.customer_info.customer, '_blank')\n                    \n                    \n            });\n\t\t\tthis.render_customer_fields();\n\t\t\t//added by shiby\n\t\t\t//this.render_location_fields();\n\t\t\t//\n\t\t  \n\t\t\tthis.fetch_customer_transactions();\n\n\t\t} else {\n\t\n\t\t\t\tthis.$cart_container.css('display', 'flex');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '',\n\t\t\t\t'padding-top': ''\n\t\t\t});\n\n\t\t\tthis.update_customer_section();\n           \n\t\t\t\t\n\t}\n\t\t\t\n\t}\n\trender_customer_fields() {\n\t\tconst $customer_form = this.$customer_section.find('.customer-fields-container');\n\n\t\tconst dfs = [{\n\t\t\tfieldname: 'email_id',\n\t\t\tlabel: __('Email'),\n\t\t\tfieldtype: 'Data',\n\t\t\toptions: 'email',\n\t\t\tplaceholder: __(\"Enter customer's email\")\n\t\t},{\n\t\t\tfieldname: 'mobile_no',\n\t\t\tlabel: __('Phone Number'),\n\t\t\tfieldtype: 'Data',\n\t\t\tplaceholder: __(\"Enter customer's phone number\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_program',\n\t\t\tlabel: __('Loyalty Program'),\n\t\t\tfieldtype: 'Link',\n\t\t\toptions: 'Loyalty Program',\n\t\t\tplaceholder: __(\"Select Loyalty Program\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_points',\n\t\t\tlabel: __('Loyalty Points'),\n\t\t\tfieldtype: 'Data',\n\t\t\tread_only: 1\n\t\t}];\n\n\t\tconst me = this;\n\t\tdfs.forEach(df => {\n            \n                this[`customer_${df.fieldname}_field`] = frappe.ui.form.make_control({\n               \n                    df: { ...df,\n                        onchange: handle_customer_field_change,\n                    },\n                    parent: $customer_form.find(`.${df.fieldname}-field`),\n                    render_input: true,\n                });\n\n            \n\t\t\t\n            //console.log(this[`customer_edit_customer_field`],\"customer_edit_customer_field\")\n\t\t\tthis[`customer_${df.fieldname}_field`].set_value(this.customer_info[df.fieldname]);\n\t\t\tconst frm=this.events.get_frm();\n\t\t\tif(frm.doc.items.length==0)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tif(cur_pos.cart.customer_mobile_no_field){cur_pos.cart.customer_mobile_no_field.input.readOnly=false}\n\t\t\t\t}\n\t\t\telse{\n\t\t\t\t\n\t\t\t\tif(cur_pos.cart.customer_mobile_no_field){cur_pos.cart.customer_mobile_no_field.input.readOnly=true}\n\t\t\t\t\n\t\t\t\t//this[`customer_mobile_no_field`].attr('readonly', false);\n\t\t\t}\n            \n           \n\t\t})\n        \n\t\tfunction handle_customer_field_change() {\n\t\t\tconst current_value = me.customer_info[this.df.fieldname];\n\t\t\tconst current_customer = me.customer_info.customer;\n\t\t\t\n\n\n\t\t\tif (this.value && current_value != this.value && this.df.fieldname != 'loyalty_points') {\n\t\t\t\t\n\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: 'erpnext.selling.page.point_of_sale.point_of_sale.set_customer_info',\n\t\t\t\t\targs: {\n\t\t\t\t\t\tfieldname: this.df.fieldname,\n\t\t\t\t\t\tcustomer: current_customer,\n\t\t\t\t\t\tvalue: this.value\n\t\t\t\t\t},\n\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tme.customer_info[this.df.fieldname] = this.value;\n\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\tmessage: __(\"Customer contact updated successfully.\"),\n\t\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n//Added by Shiby\n\t// render_location_fields() {\n       \n\t// \tvar slotoptions= this.getslotDetails('','');\n\t// \tvar opbranch=this.getbranchDetails('');\n\t// \tconst $customer_form = this.$customer_section.find('.location-fields-container');\n    //     const query = { query: 'ecs_vim.doctype_triggers.point_of_sale.point_of_sale.event_query' };\n    //     const soquery = { soquery: 'ecs_vim.doctype_triggers.point_of_sale.point_of_sale.so_query' };\n\t// \tconst dfs = [{\n\t// \t\tfieldname: 'visitdate',\n\t// \t\tlabel: __('Visit Date'),\n\t// \t\tfieldtype: 'Date'\n\t\t\t\n\t// \t}\n    //     ,{\n\t// \t\tfieldname: 'so',\n\t// \t\tlabel: __('Sales Order'),\n\t// \t\tfieldtype: 'Link',\n\t// \t\toptions:'Sales Order', \n    //         get_query: () => soquery,\n    //         filters: {  \n    //             \"customer\":[ \"=\", this.customer_info.customer?this.customer_info.customer:'' ]  ,           \n    //            \"pos_status\":[ \"=\", 'Open']\n    //         },\n    //         placeholder: __(\"Select SO\")\n           \t\n\t\t\t\n\t// \t},{\n\t// \t\tfieldname: 'event',\n\t// \t\tlabel: __('Event'),\n\t// \t\tfieldtype: 'Link',\n\t// \t\toptions: 'Item',\t\t\t\t\n\t// \t\t\tget_query: () => query,\n\t// \t\t\tplaceholder: __(\"Event\"),\n\t\t\t\t\n\t// \t},\n    //     ,{\n            \n    //         fieldname: 'event_slot',\n\t// \t\tlabel: __('Slot'),\n\t// \t\tfieldtype: 'Select',\n\t// \t\toptions:slotoptions,\n    //         placeholder: __(\"Slot\"),\n               \n\t// \t},{\n\t// \t\tfieldname: 'brand',\n\t// \t\tlabel: __('Brand'),\n\t// \t\tfieldtype: 'Link',\n\t// \t\toptions: 'Dimension Brand',\n\t// \t\tplaceholder: __(\"Enter customer's email\")\n\t// \t},{\n\t// \t\tfieldname: 'city',\n\t// \t\tlabel: __('City'),\n\t// \t\tfieldtype: 'Link',\n\t// \t\toptions:'Dimension City',\n\t// \t\tplaceholder: __(\"Enter customer's phone number\")\n\t// \t},{\n\t// \t\tfieldname: 'branch',\n\t// \t\tlabel: __('Branch'),\n\t// \t\tfieldtype: 'Select',\n\t// \t\toptions: opbranch,\n\t// \t\tplaceholder: __(\"Select Branch\")\n\t// \t},{\n\t// \t\tfieldname: 'department',\n\t// \t\tlabel: __('Department'),\n\t// \t\tfieldtype: 'Link',\n\t// \t\toptions:'Dimension Department'\n\t\t\t\n\t// \t}\n    // ];\n\n\t// \tconst me = this;\n\t\n\t// \tdfs.forEach(df => {\n\t// \t\tthis[`location_${df.fieldname}_field`] = frappe.ui.form.make_control({\n\t// \t\t\tdf: { ...df,\n\t// \t\t\t\tonchange: handle_location_field_change,\n\t\t\t\t\t\n\t// \t\t\t},\n\t// \t\t\tparent: $customer_form.find(`.${df.fieldname}-field`),\n\t// \t\t\trender_input: true,\n\t// \t\t});\n          \n    //         me.slot_field=this.location_info.event_slot;\n    //         me.branch_field=this.location_info.branch;\n\t\t\n\t// \t\tif(me.branch_field && cur_pos.cart.location_branch_field )\n\t// \t\t{\n\t// \t\t\tcur_pos.cart.location_branch_field.set_value(me.branch_field)\n\t// \t\t\tcur_pos.cart.location_branch_field.refresh();\n\t// \t\t}\n\t// \t\tthis[`location_${df.fieldname}_field`].set_value(me.location_info[df.fieldname]);\n\t// \t})\n\t// \tfunction handle_location_field_change() {\n\t// \t\tconst current_value = me.location_info[this.df.fieldname];\n\t// \t\tconst current_customer = me.customer_info.customer;\n\t// \t\tconst visitdate_value=this.value\n\t// \t\tif(this.value)\n\t// \t\t{\n\t// \t\t\tif(this.df.fieldname == 'so')\n\t// \t\t\t{\n\t// \t\t\tcur_pos.cart.location_event_field.value='';\n\t// \t\t\tcur_pos.cart.location_event_slot_field.value='';\n\t// \t\t\tme.non_sharable_slot=0;\n\t// \t\t\tme.location_info.event='';\n\t// \t\t\tme.location_info.event_slot='';\n\t// \t\t\tcur_pos.cart.location_event_field.refresh();\n\t// \t\t\tcur_pos.cart.location_event_slot_field.refresh();\t\n\t// \t\t\tcur_pos.cart.location_so_field.read_only=false;\n\t// \t\t\tcur_pos.cart.location_event_field.read_only=true;\n\t// \t\t\tcur_pos.cart.location_event_slot_field.read_only=true;\n\t\t\t\t\n\t// \t\t\t}\n\t// \t\t\tif(this.df.fieldname == 'event')\n\t// \t\t\t{\n\t\t\t\t\n\t// \t\t\tcur_pos.cart.location_event_slot_field.value='';\n\t// \t\t\tcur_pos.cart.location_so_field.value='';\n\t// \t\t\tme.location_info.so='';\n\t// \t\t\t//me.location_info.event_slot='';\n\t// \t\t\tme.non_sharable_slot=0;\n\t// \t\t\tcur_pos.cart.location_event_slot_field.refresh();\n\t// \t\t\tcur_pos.cart.location_so_field.refresh();\t\n\t// \t\t\tcur_pos.cart.location_so_field.read_only=true;\n\t// \t\t\tcur_pos.cart.location_event_field.read_only=false;\n\t// \t\t\tcur_pos.cart.location_event_slot_field.read_only=false;\n\t\t\t\t\n\t// \t\t\t}\n\t// \t\t\tif(this.df.fieldname=='visitdate')\n\t// \t\t\t{\n\t// \t\t\tcur_pos.cart.location_so_field.value='';\n\t// \t\t\tcur_pos.cart.location_event_field.value='';\n\t// \t\t\tcur_pos.cart.location_event_slot_field.value='';\n\t// \t\t\tme.location_info.so='';\n\t\t\t\t\n\t// \t\t\tme.location_info.event='';\n    //             me.location_info.event_slot='';\n\t// \t\t\tcur_pos.cart.location_so_field.refresh();\n\t// \t\t\tcur_pos.cart.location_event_field.refresh();\n\t// \t\t\tcur_pos.cart.location_event_slot_field.refresh();\n\t// \t\t\tme.non_sharable_slot=0;\n\t// \t\t\t}\n\n\t// \t\t}\n\t// \t\telse{\n\t// \t\t\tcur_pos.cart.location_event_field.value='';\n\t// \t\t\tcur_pos.cart.location_event_slot_field.value='';\n\t// \t\t\tcur_pos.cart.location_so_field.value='';\n\t// \t\t\tme.location_info.so='';\n\t\t\t\t\n\t// \t\t\tme.location_info.event='';\n    //             me.location_info.event_slot='';\n\t// \t\t\tme.non_sharable_slot=0;\n\t// \t\t\tcur_pos.cart.location_event_field.refresh();\n\t// \t\t\tcur_pos.cart.location_event_slot_field.refresh();\n\t// \t\t\tcur_pos.cart.location_so_field.refresh();\t\n\t// \t\t\tcur_pos.cart.location_so_field.read_only=false;\n\t// \t\t\tcur_pos.cart.location_event_field.read_only=false;\n\t// \t\t\tcur_pos.cart.location_event_slot_field.read_only=false;\n\t\t\t\t\n\n\t// \t\t}\n\t\t\n\t// \t\tme.location_info[this.df.fieldname]=this.value;\n\t// \t\tconst frm = me.events.get_frm();\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'visitdate') {\n\t\t\t\t\n\t// \t\t\t//me.location_info.visitdate =this.value;\n\t\t\t\t\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'visit_date', this.value);\n\t\t\t\t\n\t// \t\t\tcur_pos.cart.location_so_field.get_query= function() {\t\t\t\t\t\n\t// \t\t\t\t\t\t\t\treturn {\n\t// \t\t\t\t\t\t\t\t filters: [\n\t// \t\t\t\t\t\t\t\t  [\"Sales Order\",\"customer\", \"=\", current_customer?current_customer:''],\n\t// \t\t\t\t\t\t\t\t  [\"Sales Order\",\"docstatus\", \"=\", 1],\n\t// \t\t\t\t\t\t\t\t  [\"Sales Order\",\"pos_status\", \"=\", 'Open'],\n\t// \t\t\t\t\t\t\t\t  [\"Sales Order\",\"delivery_date\", \"=\", me.location_info.visitdate]\n\t// \t\t\t\t\t\t\t\t ]\n\t\t\t\t\t\t\t\t \n\t// \t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t \n\t// \t\t\t\t\t}\n\n\t// \t\t}\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'so') {\n\t// \t\t\t\tvar sorder=this.value;\n\t// \t\t\t\tvar item_list_data=[];\n\t// \t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'sales_order', this.value);\t\t\t\t\t\n\t// \t\t\t\tme.get_items(sorder);\n\t// \t\t\t\tif(this.value)\n\t// \t\t\t\t{\n\t// \t\t\t\t\tfrappe.call({\n\t// \t\t\t\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_payment_entry\",\n\t// \t\t\t\t\t\targs: {\n\t// \t\t\t\t\t\t\tsorder: sorder\n\t// \t\t\t\t\t\t},\n\t// \t\t\t\t\t\tasync: false,\n\t// \t\t\t\t\t\tcallback: function(r) {\n\t// \t\t\t\t\t\t\titem_list_data = (r.message['result_list'] || []); \n\t// \t\t\t\t\t\t\tconsole.log(item_list_data,\"item_list_data\")\n\t// \t\t\t\t\t\t\tvar allocated_amount = 0;\n\t// \t\t\t\t\t\t\tObject.entries(item_list_data).forEach(([key, value]) => {\n\t\t\t\t\t\t\t\t\t\n\t// \t\t\t\t\t\t\t\tallocated_amount=flt(value[\"allocated_amount\"])\n\t// \t\t\t\t\t\t\t});\n\t// \t\t\t\t\t\t\tvar child = cur_frm.add_child(\"advances\");\n\t// \t\t\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"allocated_amount\", allocated_amount)\n\t// \t\t\t\t\t\t\tcur_frm.refresh_field(\"advances\")\n\t// \t\t\t\t\t\t}\n\t// \t\t\t\t\t});\n\t// \t\t\t\t}\n\t// \t\t}\n\t\t\t\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'event') {\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'event', this.value);\n\t// \t\t\tvar event=this.value\n    //             if(me.slot_field==undefined )\n    //             {\n                    \n    //                 me.clear_cart();\n    //             }\n    //             else if(me.slot_field=='')\n    //             {\n                   \n    //                 me.clear_cart();\n    //             }\n                \n    //             me.get_items_event(event);\n    //             if(me.slot_field && me.slot_field!='')\n    //                {\n                   \n    //                 \tme.slot_change=false;\n    //                    cur_pos.cart.location_event_slot_field.set_value(me.slot_field)\n    //                    cur_pos.cart.location_event_slot_field.refresh();\n                      \n    //                 }\n               \n                       \n\t// \t\t}\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'event_slot') {\n\t// \t\t\t//me.location_info.event_slot =this.value;\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'slot', this.value);\n\t// \t\t\tvar slot=this.value\n               \n    //             if(me.slot_change==undefined )\n    //             {\n                    \n    //                 me.make_item_slot(slot,cur_pos.cart.location_event_field.value)\n    //             }\n    //             else if(me.slot_change==true)\n    //             {\n                   \n    //                 me.make_item_slot(slot,cur_pos.cart.location_event_field.value)\n    //             }\n\t// \t\t}\n    //         if (this.value && current_value != this.value && this.df.fieldname == 'brand') {\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'brand', this.value);\n\t// \t\t\tvar brand=this.value\n    //             me.get_branch_list(this.value);\n              \n    //             if(me.branch_field && me.branch_field!='')\n    //                {\n\t\t\t\t\t\t\n                    \n\t// \t\t\t\t   cur_pos.cart.location_branch_field.set_value(me.branch_field)\n    //                    cur_pos.cart.location_branch_field.refresh();\n    //                 }\n               \n\t// \t\t}\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'city') {\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'city', this.value);\n\t\t\t\t\n\t// \t\t}\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'branch') {\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'branch', this.value);\n\t\t\t\t\n\t// \t\t}\n\t// \t\tif (this.value && current_value != this.value && this.df.fieldname == 'department') {\n\t// \t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'department', this.value);\n\t\t\t\t\n\t// \t\t}\n\t\t\t\n\t// \t\t//me.location_info[this.df.fieldname]=this.value;\n\t// \t}\n\t\t\n\t// }\n    //\n    render_location_fields() {\n\t\tconst $customer_form = this.$location_fields_container;\n        const soquery = { soquery: 'ecs_vim.doctype_triggers.point_of_sale.point_of_sale.so_query' };\n\t\tconst dfs = [{\n\t\t\tfieldname: 'visitdate',\n\t\t\tlabel: __('Visit Date'),\n\t\t\tfieldtype: 'Date',\n\t\t\tdefault:frappe.datetime.nowdate()\n\t\t}\n        ,{\n\t\t\tfieldname: 'so',\n\t\t\tlabel: __('Sales Order'),\n\t\t\tfieldtype: 'Link',\n\t\t\toptions:'Sales Order', \n            get_query: () => soquery,\n            filters: {  \n                \"customer\":[ \"=\", this.customer_info.customer?this.customer_info.customer:'' ]  ,           \n               \"pos_status\":[ \"=\", 'Open'],\n\t\t\t   \"delivery_date\":[\"=\",frappe.datetime.nowdate()]\n            },\n            placeholder: __(\"Select SO\")\n\t\t}\n       \n    ];\n\t\tconst me = this;\n        if(!cur_pos.cart.location_visitdate_field)\n        {\n            dfs.forEach(df => {\n                this[`location_${df.fieldname}_field`] = frappe.ui.form.make_control({\n                    df: { ...df,\n                        onchange: handle_location_field_change,\n                        \n                    },\n                    parent: $customer_form.find(`.${df.fieldname}-field`),\n                    render_input: true,\n                });\n                this[`location_${df.fieldname}_field`].set_value(me.location_info[df.fieldname]);\n            })\n\t\t    \tcur_pos.cart.location_visitdate_field.set_value(String(frappe.datetime.nowdate()))\n\t\t\t\t//me.get_default_so();\n\t\t\t\t\n\t\t\t\t\n        }\n        else{\n\t\t\t\n\t\t\tif(cur_pos.cart.location_visitdate_field)\n\t\t\t{\n\t\t\t\tcur_pos.cart.location_visitdate_field.set_value(String(frappe.datetime.nowdate()))\n\t\t\t\t//me.get_default_so();\n\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t\t\t\n\t\t\t\n\t\t\t\n            \n        }\n\t\t\n\t\tfunction handle_location_field_change() {\n\t\t\tconst current_value = me.location_info[this.df.fieldname];\n\t\t\tconst current_customer = me.customer_info.customer;\n\t\t\t\n\t\t\tif(this.value)\n\t\t\t{\n\t\t\t\tif(this.df.fieldname == 'so')\n\t\t\t\t{\n\t\t\t\t me.non_sharable_slot=0;\n\t\t\t\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(this.df.fieldname=='visitdate')\n\t\t\t\t{\n\t\t\t\t    cur_pos.cart.location_so_field.value='';\n\t\t\t\t    me.location_info.so='';\n\t\t\t\t    me.non_sharable_slot=0;\n                    cur_pos.cart.location_so_field.set_value('');\n\t\t\t\t\t//me.get_default_so();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse{\n\t\t\t\tme.location_info.so='';\n\t\t\t}\n\t\t\n\t\t\tme.location_info[this.df.fieldname]=this.value;\n\t\t\tconst frm = me.events.get_frm();\n           \n\t\t\tif (this.value && current_value != this.value && this.df.fieldname == 'visitdate') {\n\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'visit_date', this.value);\n               if(cur_frm.doc.__islocal==1)\n\t\t\t   {\n\t\t\t\t\n\t\t\t\tcur_pos.cart.location_so_field.get_query= function() {\t\t\t\t\t\n\t\t\t\t\treturn {\n\t\t\t\t\t filters: [\n\t\t\t\t\t  [\"Sales Order\",\"customer\", \"=\", current_customer?current_customer:''],\n\t\t\t\t\t  [\"Sales Order\",\"docstatus\", \"=\", 1],\n\t\t\t\t\t  [\"Sales Order\",\"pos_status\", \"=\", 'Open'],\n\t\t\t\t\t  [\"Sales Order\",\"delivery_date\", \"=\", me.location_info.visitdate]\n\t\t\t\t\t ]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t//me.get_default_so();\n\t\t\t\t\n\t\t\t   }\n\t\t\t   else{\n\t\t\t\t \n\t\t\t\t\n\t\t\t\tcur_pos.cart.location_so_field.get_query= function() {\t\t\t\t\t\n\t\t\t\t\treturn {\n\t\t\t\t\t filters: [\n\t\t\t\t\t  [\"Sales Order\",\"customer\", \"=\", current_customer?current_customer:''],\n\t\t\t\t\t  [\"Sales Order\",\"docstatus\", \"=\", 1],\n\t\t\t\t\t  [\"Sales Order\",\"pos_status\", \"=\", 'Executed'],\n\t\t\t\t\t  [\"Sales Order\",\"delivery_date\", \"=\", me.location_info.visitdate]\n\t\t\t\t\t ]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t   }\n\t\t\t\t\n\t\t\t}\n\t\t\tif (this.value && current_value != this.value && this.df.fieldname == 'so') {\n\t\t\t\t\tvar sorder=this.value;\n\t\t\t\t\tvar item_list_data=[];\n\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'sales_order', this.value);\t\n                    frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'sales_order_no', this.value);\t\t\t\t\t\t\n\t\t\t\tif(cur_pos.cart.location_visitdate_field.value!='')\n                {\n\t\t\t\t\t\n                    me.get_positems(sorder);\n\t\t\t\t\tif(this.value)\n\t\t\t\t\t{\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_payment_entry\",\n\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\tsorder: sorder\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tasync: false,\n\t\t\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t\t\titem_list_data = (r.message['result_list'] || []); \n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tvar allocated_amount = 0;\n\t\t\t\t\t\t\t\tif(item_list_data.length>0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tObject.entries(item_list_data).forEach(([key, value]) => {\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\tallocated_amount=flt(value[\"allocated_amount\"])\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tvar child = cur_frm.add_child(\"advances\");\n\t\t\t\t\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"allocated_amount\", allocated_amount)\n\t\t\t\t\t\t\t\t\tcur_frm.refresh_field(\"advances\")\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n                }\n                   \n\t\t\t}\n\t\t\t\n\t\t}\n\t\t\n\t}\n    \n    async get_default_so()\n\t{\n\t\tif(cur_frm.doc.__islocal==1)\n\t\t{\n\t\t\t\n\t\t\tconst  res = await frappe.db.get_value(\"Sales Order\",{'customer': cur_frm.doc.customer,'delivery_date':cur_pos.cart.location_visitdate_field.value,'pos_status':'Open','docstatus':1}  , \"name\");\n\t\t\t\n\t\t\tif(cur_frm.doc.customer)\n\t\t\t{\n\t\t\t\tcur_pos.cart.location_so_field.set_value(String(res.message.name))\n\t\t\t}\n\t\t}\n\n\t\t\n\t\t//cur_pos.cart.location_so_field.set_value(String(res.message.name))\n\t\t//return res.message.name;\n\t}\n\t\n    fetch_customer_transactions() {\n\t\tfrappe.db.get_list('POS Invoice', {\n\t\t\tfilters: { customer: this.customer_info.customer, docstatus: 1 },\n\t\t\tfields: ['name', 'grand_total', 'status', 'posting_date', 'posting_time', 'currency'],\n\t\t\tlimit: 20\n\t\t}).then((res) => {\n\t\t\tconst transaction_container = this.$customer_section.find('.customer-transactions');\n\n\t\t\tif (!res.length) {\n\t\t\t\ttransaction_container.html(\n\t\t\t\t\t`<div class=\"no-transactions-placeholder\">No recent transactions found</div>`\n\t\t\t\t)\n\t\t\t\treturn;\n\t\t\t};\n\n\t\t\tconst elapsed_time = moment(res[0].posting_date+\" \"+res[0].posting_time).fromNow();\n\t\t\tthis.$customer_section.find('.customer-desc').html(`Last transacted ${elapsed_time}`);\n\n\t\t\tres.forEach(invoice => {\n\t\t\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\n\t\t\t\tlet indicator_color = {\n\t\t\t\t\t'Paid': 'green',\n\t\t\t\t\t'Draft': 'red',\n\t\t\t\t\t'Return': 'gray',\n\t\t\t\t\t'Consolidated': 'blue'\n\t\t\t\t};\n\n\t\t\t\ttransaction_container.append(\n\t\t\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\n\t\t\t\t\t\t<div class=\"invoice-name-date\">\n\t\t\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\n\t\t\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"invoice-total-status\">\n\t\t\t\t\t\t\t<div class=\"invoice-total\">\n\t\t\t\t\t\t\t\t${format_currency(invoice.grand_total, invoice.currency, 0) || 0}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"invoice-status\">\n\t\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color[invoice.status]}\">\n\t\t\t\t\t\t\t\t\t<span>${invoice.status}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t\t)\n\t\t\t});\n\t\t});\n\t}\n    //Added by Shiby\n\t// fetch_location_details() {\n\t// \tfrappe.db.get_value('POS Profile', this.pos_profile, [\"is_event\"]).then(({ message }) => {\n\t\t\t\t\t\n\t// \t\tthis.location_info = { ...message };\n\t\t\t\n\t\t\n\t// });\n    \n\t// }\n\n\tload_invoice() {\n\t\tconst frm = this.events.get_frm();\n        \n\t\t\n\t\tthis.fetch_customer_details(frm.doc.customer).then(() => {\n\t\t\tthis.events.customer_details_updated(this.customer_info);\n\t\t\tthis.update_customer_section();\n\t\t});\n\t\t//added by shiby\n\t\tthis.location_info={}\n\t\tthis.render_location_fields();\n\t\tthis.fetch_location_details(frm.doc.name)\n\t\tthis.non_sharable_slot=0;\n\t\t\n       \n\t\t//\n\t\tthis.$cart_items_wrapper.html('');\n\t\tif (frm.doc.items.length) {\n          \n\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\tthis.update_item_html(item);\n\t\t\t});\n\t\t} else {\n\t\t\tthis.make_no_items_placeholder();\n\t\t\tthis.highlight_checkout_btn(false);\n\t\t}\n\n\t\tthis.update_totals_section(frm);\n     \n\t\tif(frm.doc.docstatus === 1) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t}\n\n\t\tthis.toggle_component(true);\n\n\t\tvar tbl = cur_frm.doc.seleceted_packed_items || [];\n        var item_list_data=[];\n            var i = tbl.length;\n            if(cur_frm.doc.is_return)\n            {\n                while (i--)\n                 {\n                    tbl[i].packed_quantity=tbl[i].packed_quantity*-1\n                 }\n                frappe.call({\n                    method: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_return_packed_items\",\n                    args: {\n                        pos_invoice: cur_frm.doc.return_against\n                    },\n                    async: false,\n                    callback: function(r) {\n\t\t\t\t\t\titem_list_data=   (r.message['result_list'] || []);\n\t\t\t\t\t\t\n\t\t\t\t\t\tvar item_code=\"\",parent_item='',set_no='',packed_quantity=0\n                        Object.entries(item_list_data).forEach(([key, value]) => {\n                            \n\t\t\t\t\t\t\t item_code=value[\"item_code\"]\n\t\t\t\t\t\t\tparent_item=value[\"parent_item\"]\n\t\t\t\t\t\t\tset_no=value[\"set_no\"]\n\t\t\t\t\t\t\tpacked_quantity=value[\"packed_quantity\"]\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n                            var itr = tbl.length;\n\t\t\t\t\t\t\t\n                            while (itr--)\n                            {\n                              \n                                if(tbl[itr].set_no==set_no && tbl[itr].parent_item==parent_item && tbl[itr].item_code==item_code)\n                                 {\n\t\t\t\t\t\t\t\t\t\n                                    var quantity=(parseInt(Math.abs(tbl[itr].packed_quantity))-parseInt(Math.abs(packed_quantity)))*-1\n\t\t\t\t\t\t\t\t\tfrappe.model.set_value(tbl[itr].doctype, tbl[itr].name, \"packed_quantity\", quantity)\n\t\t\t\t\t\t\t\t\tfrappe.model.set_value(tbl[itr].doctype, tbl[itr].name, \"quantity\", quantity*parseInt(tbl[itr].combo_qty))\n\t\t\t\t\t\t\t\t\tcombo_qty\n\t\t\t\t\t\t\t\t\tcur_frm.refresh_field(\"seleceted_packed_items\")\n                                 }\n                                }\n                            \n                           \n\t\t\t\t\t\t\t});\n                        cur_frm.doc.seleceted_packed_items=tbl\n                      \n                        // cur_frm.refresh_field(\"seleceted_packed_items\")\n                    }\n                });\n               \n            }\n            cur_frm.refresh();\n\n\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n    //Added by Shiby\n\tclear_cart(){\n        cur_pos.cart.location_event_slot_field.set_value(undefined)\n        cur_pos.cart.location_event_slot_field.refresh();\n\t\tconst frm = this.events.get_frm();\n\t\tif(frm.doc.items.length){\n\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\tconst $item = this.get_cart_item(item);\t\n                var current_item={}\n                current_item.item_code = item.item_code\n                current_item.batch_no = item.batch_no\n                current_item.uom = item.uom\n                frappe.model.set_value(item.doctype, item.name, 'qty', 0)\n                    .then(() => {\n                        frappe.model.clear_doc(item.doctype, item.name);\n                        cur_pos.update_cart_html(current_item, true);\n                        \n                    })\n                    .catch(e => console.log(e));\n\t\t\t    \n\t\t\t\t\n\t\t\t});\n        this.events.numpad_event(undefined, \"remove\");\n\n\t\t}\n\t\t\t\n\t}\n\t//clear cart and added selected SO Items to cart\n\tasync get_positems(sorder) {\n\t\t\n       \t\tconst me=this;\t\n\t\t\n\t\t\tconst frm = this.events.get_frm();\n\t\t\n\t\t\tfrm.doc.items.forEach(item => {\n                \n\t\t\t\tconst $item = this.get_cart_item(item);\t\n                var current_item={}\n                current_item.item_code = item.item_code\n                current_item.batch_no = item.batch_no\n                current_item.uom = item.uom\n                current_item.rate = item.rate\n              // \n                \n                frappe.model.set_value(item.doctype, item.name, 'qty', 0)\n                    .then(() => {\n                        frappe.model.clear_doc(item.doctype, item.name);\n                        cur_pos.update_cart_html(current_item, true);\n                        \n                    })\n                    .catch(e => console.log(e));\n\t\t\t    \n\t\t\t\t\n\t\t\t});\n        this.events.numpad_event(undefined, \"remove\");\n\t\t\n        if(sorder)\n        {\t\n\t\t\tconst  res = await frappe.db.get_value(\"Sales Order\",{'name': sorder,'pos_status':'Open'}  , \"select_slot\");\n\t\t\t\n\t\t\t// if(!res || !res.message.select_slot || res.message.select_slot=='')\n\t\t\t// {\n\t\t\t \tthis.get_so_pos_items(sorder);\n                \n                \n                //  frappe.db.get_value('Sales Order', {'name': sorder}, ['additional_discount_percentage','discount_amount','coupon_code']).then(({ message }) => {\n                //     frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'applied_coupen',message.coupon_code);\n                //     frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'couponcode',message.coupon_code);\n                //     this.update_discount_so(message.additional_discount_percentage,message.discount_amount)\n                    \n                //  })\n                frappe.db.get_value('Sales Order', {'name': sorder}, ['additional_discount_percentage','discount_amount','coupon_code']).then(({ message }) => {\n                    console.log(message.coupon_code,message)  \n                    this.update_discount_so(message.additional_discount_percentage,message.discount_amount)\n                    frappe.db.get_value('Coupon Code', {'name':message.coupon_code}, ['coupon_code']).then(({ message }) => {\n                      console.log(message.coupon_code,message)  \n                    frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'applied_coupen',message.coupon_code);\n                    frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'couponcode',message.coupon_code);\n                    \n                })\n                 })\n\t\t\t\t\n\t\t\t// }\n\t\t\t// else{\n\t\t\t// \tfrappe.db.get_value('Work Order', {'sales_order': sorder}, ['docstatus','status']).then(({ message }) => {\n\t\t\t\t\n\t\t\t// \t\tif(message.docstatus==1)\n\t\t\t// \t\t{\n\t\t\t// \t\t\tthis.get_so_pos_items(sorder);\t\n\t\t\t// \t\t}\n\t\t\t// \t\telse if(message.docstatus==undefined)\n\t\t\t// \t\t{\n\t\t\t// \t\t\tcur_pos.cart.location_so_field.set_value('')\n\t\t\t// \t\t\tfrappe.show_alert({\n\t\t\t// \t\t\t\tindicator: 'red',\n\t\t\t// \t\t\t\tmessage: \"Work Order Not Created\"\n\t\t\t// \t\t\t});\n\t\t\t// \t\t\treturn;\n\t\t\t// \t\t}\n\t\t\t// \t\telse {\n\t\t\t\t\t\t\n\t\t\t// \t\t\tcur_pos.cart.location_so_field.set_value('')\n\t\t\t// \t\t\tfrappe.show_alert({\n\t\t\t// \t\t\t\tindicator: 'red',\n\t\t\t// \t\t\t\tmessage: \"Work Order Not Submitted. Status: \"+message.status\n\t\t\t// \t\t\t});\n\t\t\t// \t\t\treturn;\n\t\t\t\t\t\t\n\t\t\t// \t\t}\n\t\n\t\t\t// \t});\n\t\n\t\t\t// }\n\t\t\n\n        }\n\t\t\n\t\t\n\t}\n\tasync\tget_so_pos_items(sorder )\n\t{\n\t\tvar item_list_data=[];var packed_list_data=[];\n\t\tconst me=this;\t\n        \n\t\tfrappe.call({\n\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_items\",\n\t\t\targs: {\n\t\t\t\tsorder: sorder\n\t\t\t},\n\t\t\tasync: false,\n\t\t\tcallback: function(r) {\n\t\t\t\titem_list_data = (r.message['result_list'] || []); \n                packed_list_data= (r.message['packed_list_data'] || []); \n                ////console.log('Anuppppp', item_list_data);\n\t\t\t\t let item_row = undefined;   if(item_list_data.length>0) \n\t\t\t\t {\n\t\t\t\t\t// console.log(\"getsoitem\")\n\t\t\t\t }             \n\t\t\t\tObject.entries(item_list_data).forEach(([key, value]) => {\n                   \n\t\t\t\t\t//item_row = this.get_item_from_frm(item_code, batch_no, uom)\n\t\t\t\t\tvar rate=0;var item_code = \"\";\tvar batch_no = \"\";\tvar serial_no = \"\";\tvar stock_uom = \"\";var conversion_factor = \"\";\tvar uom=\"\";\tvar bundle_item=\"\";\t\t\t\t\n\t\t\t\t\t// item.price_list_rate,item.base_price_list_rate,item.base_rate,item.base_amount,item.base_net_rate,item.base_net_amount,\n\t\t\t\t\t// item.base_rate_with_margin,item.actual_qty,item.valuation_rate,item.conversion_factor,item.net_rate,item.net_amount\n\t\t\t\t\titem_code=(value[\"item_code\"]);\n\t\t\t\t\tbatch_no=(value[\"batch_no\"]);\n\t\t\t\t\tserial_no=(value[\"serial_no\"]);\n\t\t\t\t\tstock_uom=(value[\"stock_uom\"]);\n\t\t\t\t\trate=(value[\"rate\"]);\n\t\t\t\t\tuom=(value[\"uom\"]); \n\t\t\t\t\tif(value[\"bundle_item\"])\n\t\t\t\t\t{\n\t\t\t\t\t\tbundle_item=(value[\"bundle_item\"]); \n\t\t\t\t\t}\n\t\t\t\t\n                    //cur_pos.item_selector.bundle_item=bundle_item==''?null:1\n\t\t\t\t\tme.events.so_item_selected({ field: 'qty', value: value[\"qty\"], item: { item_code, batch_no, serial_no, stock_uom,rate,conversion_factor,uom }})\n                    \n\t\t\t\t\t\n\t\t\t\t});\n                Object.entries(packed_list_data).forEach(([key, value]) => {\n                var child = cur_frm.add_child(\"seleceted_packed_items\");\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"parent_item\", value[\"parent_item\"])\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"item_code\", value[\"item_code\"])\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"set_no\",parseInt(value[\"set_no\"]))\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"combo_qty\",parseInt(value[\"qty\"]))\n\t\t\t\t\tif(value[\"set_no\"]!=0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"packed_quantity\", 0)\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"packed_quantity\", parseInt(value[\"packed_quantity\"]))\n\t\t\t\t\t}\n\t\t\t\t\t\n                    frappe.model.set_value(child.doctype, child.name, \"default_item\", value[\"default_item_in_pos\"])\n\t\t\t\t\tcur_frm.refresh_field(\"seleceted_packed_items\")\n                })\n\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t});\n\t\t// callback();\n\t}\n\t//clear cart and added selected event to cart if non_sharable_slot=1\n    // get_items_event(event) {\n        \n    //     const slot_= this.location_info.event_slot\n       \n\t// \t//cur_pos.cart.slot_field.set_value('');\n       \n\t\n\t// \tthis.non_sharable_slot=0;\t\n\t// \tif(event)\n    //     {\n\t// \t\tfrappe.db.get_value('Item', event, [\"non_sharable_slot\",\"minimum_sales_quantity\"]).then(({ message }) => {\n\t// \t\t\tthis.minimum_sales_quantity=message.minimum_sales_quantity\n\t// \t\t\tif (message.non_sharable_slot==1){\n\t\t\t\t\n\t// \t\t\t\tthis.non_sharable_slot=1;\n    //        \t\t\t// $(`.slot-field`).css('display', 'block');\n    //        \t\t\t var resultlist=[];var slotlist=[];\n\t// \t\t\t\tif(cur_pos.cart.location_visitdate_field.value){\n    //        \t\t\t frappe.call({\n    //                 \"method\": \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_slot_list\",\n    //                 async: false,\n    //                 args:{item_name:event?event:'',is_new:0,delivery_date:cur_pos.cart.location_visitdate_field.value},\n    //                 callback: function (r) {\n\t\t\t\t\t\t\n    //                     resultlist = (r.message['result_list'] || []);\n                        \n    //                     Object.entries(resultlist).forEach(([key, value]) => {\n    //                         var item = \"\";\n    //                         item=(value[\"slot_name\"]);\n    //                         slotlist.push(item);\n    //                     });\n                        \n    //                     this.slot_change=true;\n\t// \t\t\t\t\tcur_pos.cart.location_event_slot_field.df.options = slotlist\n    //                     cur_pos.cart.location_event_slot_field.refresh();\n                        \n    //                 }})\n                    \n\t\t\t\t\n\t// \t\t\t\t}\n\t// \t\t\t\telse{\n\t// \t\t\t\t\tfrappe.show_alert({\n\t// \t\t\t\t\t\tindicator: 'red',\n\t// \t\t\t\t\t\tmessage: \"Select Visit date\"\n\t// \t\t\t\t\t});\n\t// \t\t\t\t}\n            \n\t\t\t\t\n\t// \t\t\t\t}\n\t// \t\t\t\telse{\n\t\t\t\t\t\n\t// \t\t\t\t\tthis.make_item_slot('',cur_pos.cart.location_event_field.value,this.minimum_sales_quantity)\n\t\t\t\t\t   \n\t// \t\t\t\t}\n\t\t\t\t\t\n\t// \t\t\t});\t \n\t\t\n\t\t\t\n                       \n    //     }\n\t\t\t\t\t\t\n\t// }\n\t//added selected event to cart if non_sharable_slot=0\n    // make_item_slot(slot,item){\n   \n    //    const me=this;\n    //     const item_code = item;\n    //     let batch_no = '';\n    //     let serial_no = '';\n    //     let uom = '';\n\t// \tlet slot_name='';\n      \n    //     batch_no = batch_no === \"undefined\" ? undefined : batch_no;\n    //     serial_no = serial_no === \"undefined\" ? undefined : serial_no;\n    //     uom = uom === \"undefined\" ? undefined : uom;\n\t// \tslot_name = slot === \"undefined\" ? undefined : slot;\n    //     me.events.item_selected({ field: 'qty', value: me.minimum_sales_quantity, item: { item_code, batch_no, serial_no, uom,slot }});\n      \n\n    // }\n\t// get_branch_list(brandname){\n\t\n\t// \tvar resultlist=[];\n\t// \tfrappe.call({\n\t// \t\"method\": \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_branch_list\",\n\t// \tasync: false,\n\t// \t    args:{brand:brandname?brandname:''},\n\t// \t    callback: function (r) {\n\t\t\t\n\t// \t\tresultlist = (r.message['branch_list'] || []);\n\t// \t\tcur_pos.cart.location_branch_field.df.options = resultlist\n\t\t\t\n\t// \t\tcur_pos.cart.location_branch_field.set_value(cur_frm.doc.branch)\n    //         cur_pos.cart.location_branch_field.refresh();\n\t// \t}\n\t// })\n    \n            \n\t\t\n\t// }\n\tsave_as_draft(){\n       \n\t\tcur_pos.save_draft_invoice();\n        // if(cur_pos.cart.discount_field)\n        // {\n        //     this.disremark=''\n        //     this.hide_discount_control(0,'') \n        //     this.discount_field.value=0;\n            \n        // }  \n         \n\n}\nvalidate_approver(){\n    const me = this;\n    const dialog = new frappe.ui.Dialog({\n        title: __('Approve Discount'),\n          fields: [\n              {fieldtype: \"Section Break\"},\n              {fieldtype: 'Data', label: __('User'), fieldname: 'appuser',reqd:1\n                        },\n              {fieldtype: 'Password', label: __('Password'), fieldname: 'apppassword',reqd:1\n                   },\n            \n            ],\n            primary_action: async function({ appuser, apppassword}) {\n                if (!appuser) {\n                    frappe.show_alert({\n                        message: __(\"Please enter user name & password.\"),\n                        indicator: 'red'\n                    })\n                    return frappe.utils.play_sound(\"error\");\n                }\n               \n                const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.validate_user_permission\";\n                const res = await frappe.call({ method, args: { appuser, apppassword }, freeze:true });\n                \n                if(res.message==1)\n                {\n                    me.approve_discount(appuser);\n                }\n                else\n                {\n                    frappe.show_alert({\n                        message: __(\"No Permission.\"),\n                        indicator: 'red'\n                    })\n                }\n                \n                \n                dialog.hide();\n            },\n            primary_action_label: __('Login')\n            });\n\ndialog.show()\ndialog.$wrapper.find('.modal-dialog').css(\"width\", \"400px\");\n\n   \n}\napprove_discount(){\n    const me = this;\n    const dialog = new frappe.ui.Dialog({\n        title: __('Approve Discount'),\n          fields: [\n              {fieldtype: \"Section Break\"},\n              {fieldtype: 'Float', label: __('Discount'), default: cur_frm.doc.additional_discount_percentage,\n                             fieldname: 'discount'\n                        },\n              {fieldtype: 'Data', label: __('Remarks'), default: cur_frm.doc.discount_remark,\n                        fieldname: 'remarks'\n                   },\n            \n            ],\n            primary_action: async function({ discount, remarks }) {\n                \n                cur_pos.update_discount_approval(discount, remarks);\n                dialog.hide();\n            },\n            primary_action_label: __('Submit')\n            });\n\ndialog.show()\ndialog.$wrapper.find('.modal-dialog').css(\"width\", \"400px\");\ndialog.$wrapper.find('.modal-dialog').css(\"height\", \"300px\");\n   \n}\n\n\t\n//end\n\t\n\n}","erpnext.PointOfSale.ItemDetails = class {\r\n\tconstructor({ wrapper, events, settings }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\r\n\t\tthis.allow_rate_change = settings.allow_rate_change;\r\n\t\tthis.allow_discount_change = settings.allow_discount_change;\r\n\t\tthis.current_item = {};\r\n\r\n\t\tthis.init_component();\r\n\t}\r\n\r\n\tinit_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.init_child_components();\r\n\t\tthis.bind_events();\r\n\t\tthis.attach_shortcuts();\r\n\t}\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<section class=\"item-details-container\"></section>`\r\n\t\t)\r\n\r\n\t\tthis.$component = this.wrapper.find('.item-details-container');\r\n\t}\r\n\r\n\tinit_child_components() {\r\n\t\tthis.$component.html(\r\n\t\t\t`<div class=\"item-details-header\" >\r\n\t\t\t\t<div class=\"label\">Item Details</div>\r\n\t\t\t\t<div class=\"close-btn\">\r\n\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\r\n\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"item-display\">\r\n\t\t\t\t<div class=\"item-name-desc-price\">\r\n\t\t\t\t\t<div class=\"item-name\"></div>\r\n\t\t\t\t\t<div class=\"item-desc\"></div>\r\n\t\t\t\t\t<div class=\"item-price\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"item-image\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"discount-section\"></div>\r\n\t\t\t<div class=\"form-container\"></div>`\r\n\t\t)\r\n\r\n\t\tthis.$item_name = this.$component.find('.item-name');\r\n\t\tthis.$item_description = this.$component.find('.item-desc');\r\n\t\tthis.$item_price = this.$component.find('.item-price');\r\n\t\tthis.$item_image = this.$component.find('.item-image');\r\n\t\tthis.$form_container = this.$component.find('.form-container');\r\n\t\tthis.$dicount_section = this.$component.find('.discount-section');\r\n\t}\r\n\r\n\ttoggle_item_details_section(item) {\r\n\t\tconst { item_code, batch_no, uom,rate } = this.current_item;\r\n\t\tconst item_code_is_same = item && item_code === item.item_code;\r\n\t\tconst batch_is_same = item && batch_no == item.batch_no;\r\n\t\tconst uom_is_same = item && uom === item.uom;\r\n       \r\n\r\n\t\tthis.item_has_changed = !item ? false : item_code_is_same && batch_is_same && uom_is_same ? false : true;\r\n       \r\n\t\tthis.events.toggle_item_selector(this.item_has_changed);\r\n\t\tthis.toggle_component(this.item_has_changed);\r\n\r\n\t\tif (this.item_has_changed) {\r\n\t\t\tthis.doctype = item.doctype;\r\n\t\t\tthis.item_meta = frappe.get_meta(this.doctype);\r\n\t\t\tthis.name = item.name;\r\n\t\t\tthis.item_row = item;\r\n\t\t\tthis.currency = this.events.get_frm().doc.currency;\r\n\r\n\t\t\tthis.current_item = { item_code: item.item_code, batch_no: item.batch_no, uom: item.uom,rate:item.rate };\r\n\r\n\t\t\tthis.render_dom(item);\r\n\t\t\tthis.render_discount_dom(item);\r\n\t\t\tthis.render_form(item);\r\n\t\t} else {\r\n\t\t\tthis.validate_serial_batch_item();\r\n\t\t\tthis.current_item = {};\r\n\t\t}\r\n\t}\r\n\r\n\tvalidate_serial_batch_item() {\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst item_row = doc.items.find(item => item.name === this.name);\r\n\r\n\t\tif (!item_row) return;\r\n\r\n\t\tconst serialized = item_row.has_serial_no;\r\n\t\tconst batched = item_row.has_batch_no;\r\n\t\tconst no_serial_selected = !item_row.serial_no;\r\n\t\tconst no_batch_selected = !item_row.batch_no;\r\n\r\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\r\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\r\n\r\n\t\t\tfrappe.show_alert({\r\n\t\t\t\tmessage: __(\"Item will be removed since no serial / batch no selected.\"),\r\n\t\t\t\tindicator: 'orange'\r\n\t\t\t});\r\n\t\t\tfrappe.utils.play_sound(\"cancel\");\r\n\t\t\tif(cur_pos.doc.items.length>0){\r\n                console.log(\"remove_item_from_cart\")\r\n                this.events.remove_item_from_cart();\r\n            }\r\n            \r\n\t\t}\r\n\t}\r\n\r\n\trender_dom(item) {\r\n\t\tlet { item_name, description, image, price_list_rate } = item;\r\n\r\n\t\tfunction get_description_html() {\r\n\t\t\tif (description) {\r\n\t\t\t\tdescription = description.indexOf('...') === -1 && description.length > 140 ? description.substr(0, 139) + '...' : description;\r\n\t\t\t\treturn description;\r\n\t\t\t}\r\n\t\t\treturn ``;\r\n\t\t}\r\n\r\n\t\tthis.$item_name.html(item_name);\r\n\t\tthis.$item_description.html(get_description_html());\r\n\t\tthis.$item_price.html(format_currency(price_list_rate, this.currency,2));\r\n\t\tif (image) {\r\n\t\t\tthis.$item_image.html(`<img src=\"${image}\" alt=\"${image}\">`);\r\n\t\t} else {\r\n\t\t\tthis.$item_image.html(`<div class=\"item-abbr\">${frappe.get_abbr(item_name)}</div>`);\r\n\t\t}\r\n\r\n\t}\r\n\r\n\trender_discount_dom(item) {\r\n\t\tif (item.discount_percentage) {\r\n\t\t\tthis.$dicount_section.html(\r\n\t\t\t\t`<div class=\"item-rate\">${format_currency(item.price_list_rate, this.currency,2)}</div>\r\n\t\t\t\t<div class=\"item-discount\">${item.discount_percentage}% off</div>`\r\n\t\t\t)\r\n\t\t\tthis.$item_price.html(format_currency(item.rate, this.currency,2));\r\n\t\t} else {\r\n\t\t\tthis.$dicount_section.html(``)\r\n\t\t}\r\n\t}\r\n\r\n\trender_form(item) {\r\n\t\tconst fields_to_display = this.get_form_fields(item);\r\n\t\tthis.$form_container.html('');\r\n        var style=\"display:block;\"\r\n\t\tfields_to_display.forEach((fieldname, idx) => {\r\n            if (fieldname=='uom' || fieldname=='warehouse'|| fieldname=='conversion_factor'|| fieldname=='slot_name')\r\n            {\r\n                style=\"display: none;\"\r\n            }\r\n            else{\r\n                style=\"display:block;\"\r\n            }\r\n\t\t\tthis.$form_container.append(\r\n\t\t\t\t`<div class=\"${fieldname}-control\" data-fieldname=\"${fieldname}\" style=\"${style}\"></div>`\r\n\t\t\t)\r\n\r\n\t\t\tconst field_meta = this.item_meta.fields.find(df => df.fieldname === fieldname);\r\n\t\t\tfieldname === 'discount_percentage' ? (field_meta.label = __('Discount (%)')) : '';\r\n\t\t\tconst me = this;\r\n\r\n\t\t\tthis[`${fieldname}_control`] = frappe.ui.form.make_control({\r\n\t\t\t\tdf: {\r\n\t\t\t\t\t...field_meta,\r\n\t\t\t\t\tonchange: function() {\r\n                        //console.log(\"onchange\",item[fieldname],fieldname)\r\n\t\t\t\t\t\tme.events.form_updated(me.doctype, me.name, fieldname, this.value);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tparent: this.$form_container.find(`.${fieldname}-control`),\r\n\t\t\t\trender_input: true,\r\n\t\t\t})\r\n\t\t\tthis[`${fieldname}_control`].set_value(item[fieldname]);\r\n\t\t});\r\n\r\n\t\tthis.make_auto_serial_selection_btn(item);\r\n\r\n\t\tthis.bind_custom_control_change_event();\r\n\t}\r\n\r\n\tget_form_fields(item) {\r\n\t\tconst fields = ['qty', 'uom', 'rate', 'conversion_factor', 'discount_percentage', 'warehouse', 'actual_qty', 'price_list_rate','slot_name'];\r\n\t\tif (item.has_serial_no) fields.push('serial_no');\r\n\t\tif (item.has_batch_no) fields.push('batch_no');\r\n\t\treturn fields;\r\n\t}\r\n\r\n\tmake_auto_serial_selection_btn(item) {\r\n\t\tif (item.has_serial_no) {\r\n\t\t\tif (!item.has_batch_no) {\r\n\t\t\t\tthis.$form_container.append(\r\n\t\t\t\t\t`<div class=\"grid-filler no-select\"></div>`\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tthis.$form_container.append(\r\n\t\t\t\t`<div class=\"btn btn-sm btn-secondary auto-fetch-btn\">Auto Fetch Serial Numbers</div>`\r\n\t\t\t);\r\n\t\t\tthis.$form_container.find('.serial_no-control').find('textarea').css('height', '6rem');\r\n\t\t}\r\n\t}\r\n\r\n\tbind_custom_control_change_event() {\r\n       \r\n\t\tconst me = this;\r\n\t\tif (this.rate_control) {\r\n\t\t\tif (this.allow_rate_change) {\r\n\t\t\t\tthis.rate_control.df.onchange = function() {\r\n\t\t\t\t\tif (this.value || flt(this.value) === 0) {\r\n\t\t\t\t\t\tme.events.form_updated(me.doctype, me.name, 'rate', this.value).then(() => {\r\n\t\t\t\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\r\n\t\t\t\t\t\t\tconst doc = me.events.get_frm().doc;\r\n\t\t\t\t\t\t\tme.$item_price.html(format_currency(item_row.rate, doc.currency,2));\r\n\t\t\t\t\t\t\tme.render_discount_dom(item_row);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t} else {\r\n\t\t\t\tthis.rate_control.df.read_only = 1;\r\n\t\t\t}\r\n            \r\n\t\t\tthis.rate_control.refresh();\r\n\t\t}\r\n\r\n\t\tif (this.discount_percentage_control && !this.allow_discount_change) {\r\n\t\t\tthis.discount_percentage_control.df.read_only = 1;\r\n\t\t\tthis.discount_percentage_control.refresh();\r\n\t\t}\r\n\r\n\t\t// if (this.warehouse_control) {\r\n\t\t// \tthis.warehouse_control.df.reqd = 1;\r\n\t\t// \tthis.warehouse_control.df.onchange = function() {\r\n\t\t// \t\tif (this.value) {\r\n\t\t// \t\t\tme.events.form_updated(me.doctype, me.name, 'warehouse', this.value).then(() => {\r\n\t\t// \t\t\t\tme.item_stock_map = me.events.get_item_stock_map();\r\n\t\t// \t\t\t\tconst available_qty = me.item_stock_map[me.item_row.item_code][this.value];\r\n\t\t// \t\t\t\tif (available_qty === undefined) {\r\n\t\t// \t\t\t\t\tme.events.get_available_stock(me.item_row.item_code, this.value).then(() => {\r\n\t\t// \t\t\t\t\t\t// item stock map is updated now reset warehouse\r\n\t\t// \t\t\t\t\t\tme.warehouse_control.set_value(this.value);\r\n\t\t// \t\t\t\t\t})\r\n\t\t// \t\t\t\t} else if (available_qty === 0) {\r\n                            \r\n        //                     if(me.check_is_stock_item(me.item_row.item_code)==1)\r\n        //                     {\r\n                                \r\n\t\t// \t\t\t\t\t    me.warehouse_control.set_value('');\r\n\t\t// \t\t\t\t\t    const bold_item_code = me.item_row.item_code.bold();\r\n\t\t// \t\t\t\t\t    const bold_warehouse = this.value.bold();\r\n\t\t// \t\t\t\t\t    frappe.throw(\r\n\t\t// \t\t\t\t\t\t__('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\r\n\t\t// \t\t\t\t\t    );\r\n        //                     }\r\n\t\t// \t\t\t\t}\r\n\t\t// \t\t\t\tme.actual_qty_control.set_value(available_qty);\r\n\t\t// \t\t\t\tme.slot_name_control.set_value(me.item_row.slot_name);\r\n\t\t// \t\t\t});\r\n\t\t// \t\t}\r\n\t\t// \t}\r\n\t\t// \tthis.warehouse_control.df.get_query = () => {\r\n\t\t// \t\treturn {\r\n\t\t// \t\t\tfilters: { company: this.events.get_frm().doc.company }\r\n\t\t// \t\t}\r\n\t\t// \t};\r\n\t\t// \tthis.warehouse_control.refresh();\r\n\t\t// }\r\n\r\n\t\tif (this.serial_no_control) {\r\n\t\t\tthis.serial_no_control.df.reqd = 1;\r\n\t\t\tthis.serial_no_control.df.onchange = async function() {\r\n\t\t\t\t!me.current_item.batch_no && await me.auto_update_batch_no();\r\n\t\t\t\tme.events.form_updated(me.doctype, me.name, 'serial_no', this.value);\r\n\t\t\t}\r\n\t\t\tthis.serial_no_control.refresh();\r\n\t\t}\r\n\r\n\t\tif (this.batch_no_control) {\r\n\t\t\tthis.batch_no_control.df.reqd = 1;\r\n\t\t\tthis.batch_no_control.df.get_query = () => {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tquery: 'erpnext.controllers.queries.get_batch_no',\r\n\t\t\t\t\tfilters: {\r\n\t\t\t\t\t\titem_code: me.item_row.item_code,\r\n\t\t\t\t\t\twarehouse: me.item_row.warehouse,\r\n\t\t\t\t\t\tposting_date: me.events.get_frm().doc.posting_date\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tthis.batch_no_control.df.onchange = function() {\r\n\t\t\t\tme.events.set_value_in_current_cart_item('batch-no', this.value);\r\n\t\t\t\tme.events.form_updated(me.doctype, me.name, 'batch_no', this.value);\r\n\t\t\t\tme.current_item.batch_no = this.value;\r\n\t\t\t}\r\n\t\t\tthis.batch_no_control.refresh();\r\n\t\t}\r\n\r\n\r\n\t\tif (this.uom_control) {\r\n         \r\n\t\t\tthis.uom_control.df.onchange = function() {\r\n\t\t\t\tme.events.set_value_in_current_cart_item('uom', this.value);\r\n\t\t\t\tme.events.form_updated(me.doctype, me.name, 'uom', this.value);\r\n\t\t\t\tme.current_item.uom = this.value;\r\n\r\n\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\r\n\t\t\t\tme.conversion_factor_control.df.read_only = (item_row.stock_uom == this.value);\r\n\t\t\t\tme.conversion_factor_control.refresh();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfrappe.model.on(\"POS Invoice Item\", \"*\", (fieldname, value, item_row) => {\r\n           \r\n\t\t\tconst field_control = this[`${fieldname}_control`];\r\n\t\t\tconst { item_code, batch_no, uom } = this.current_item;\r\n\t\t\tconst item_code_is_same = item_code === item_row.item_code;\r\n\t\t\tconst batch_is_same = batch_no == item_row.batch_no;\r\n\t\t\tconst uom_is_same = uom === item_row.uom;\r\n\t\t\tconst item_is_same = item_code_is_same && batch_is_same && uom_is_same ? true : false;\r\n\r\n\t\t\tif (item_is_same && field_control && field_control.get_value() !== value) {\r\n\t\t\t\tfield_control.set_value(value);\r\n\t\t\t\tcur_pos.update_cart_html(item_row);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n    async set_uom_value(newuom,convfac){\r\n        var uomvalu=newuom;\r\n       // console.log(\"set_uom_value\",this)\r\n        cur_pos.item_details.uom_control.set_value(uomvalu)\r\n        //cur_pos.item_details.conversion_factor_control.set_value(4)\r\n        //cur_pos.cart.location_so_field.set_value('')\r\n       // await this.uom_control.set_value(uomvalu);\r\n        $('.uom_control').change();\r\n        \r\n                    // console.log(this.uom_control.value,\"this.uom_control.value\")\r\n                    // await this.conversion_factor_control.set_value(convfac);\r\n                    // this.conversion_factor_control.refresh();\r\n                    //this.events.close_item_details();\r\n\r\n    }\r\n    // bind_uom_control_change_event(nuom,doctypename) {\r\n    //     console.log(\"bind_uom_control_change_event\",doctypename)\r\n\t// \tconst me = this;\r\n\t\t\r\n\t\t\r\n\t// \t\t\tme.events.set_value_in_current_cart_item('uom', nuom);\r\n\t// \t\t\tme.events.form_updated('POS Invoice Item', doctypename, 'uom', nuom);\r\n\t// \t\t\tme.current_item.uom = nuom;\r\n\r\n\t// \t\t\tconst item_row = frappe.get_doc('POS Invoice Item', doctypename);\r\n\t// \t\t\t// me.conversion_factor_control.df.read_only = (item_row.stock_uom == nuom);\r\n\t// \t\t\t// me.conversion_factor_control.refresh();\r\n\t\t\t\r\n\t\t\r\n\r\n\t// \tfrappe.model.on(\"POS Invoice Item\", \"*\", (fieldname, value, item_row) => {\r\n    //         console.log(me,\"this.uom_control\",this)\r\n\t// \t\tconst field_control = this[`${fieldname}_control`];\r\n\t// \t\tconst { item_code, batch_no, uom } = this.current_item;\r\n\t// \t\tconst item_code_is_same = item_code === item_row.item_code;\r\n\t// \t\tconst batch_is_same = batch_no == item_row.batch_no;\r\n\t// \t\tconst uom_is_same = uom === item_row.uom;\r\n\t// \t\tconst item_is_same = item_code_is_same && batch_is_same && uom_is_same ? true : false;\r\n\r\n\t// \t\tif (item_is_same && field_control && field_control.get_value() !== value) {\r\n\t// \t\t\tfield_control.set_value(value);\r\n\t// \t\t\tcur_pos.update_cart_html(item_row);\r\n\t// \t\t}\r\n\t// \t});\r\n\t// }\r\n    async check_is_stock_item(itemcode)\r\n    {\r\n        const  res = await frappe.db.get_value(\"Item\",  itemcode, \"is_stock_item\");\r\n       \r\n        return res.message.is_stock_item;\r\n    }\r\n\tasync auto_update_batch_no() {\r\n\t\tif (this.serial_no_control && this.batch_no_control) {\r\n\t\t\tconst selected_serial_nos = this.serial_no_control.get_value().split(`\\n`).filter(s => s);\r\n\t\t\tif (!selected_serial_nos.length) return;\r\n\r\n\t\t\t// find batch nos of the selected serial no\r\n\t\t\tconst serials_with_batch_no = await frappe.db.get_list(\"Serial No\", {\r\n\t\t\t\tfilters: { 'name': [\"in\", selected_serial_nos]},\r\n\t\t\t\tfields: [\"batch_no\", \"name\"]\r\n\t\t\t});\r\n\t\t\tconst batch_serial_map = serials_with_batch_no.reduce((acc, r) => {\r\n\t\t\t\tacc[r.batch_no] || (acc[r.batch_no] = []);\r\n\t\t\t\tacc[r.batch_no] = [...acc[r.batch_no], r.name];\r\n\t\t\t\treturn acc;\r\n\t\t\t}, {});\r\n\t\t\t// set current item's batch no and serial no\r\n\t\t\tconst batch_no = Object.keys(batch_serial_map)[0];\r\n\t\t\tconst batch_serial_nos = batch_serial_map[batch_no].join(`\\n`);\r\n\t\t\t// eg. 10 selected serial no. -> 5 belongs to first batch other 5 belongs to second batch\r\n\t\t\tconst serial_nos_belongs_to_other_batch = selected_serial_nos.length !== batch_serial_map[batch_no].length;\r\n\r\n\t\t\tconst current_batch_no = this.batch_no_control.get_value();\r\n\t\t\tcurrent_batch_no != batch_no && await this.batch_no_control.set_value(batch_no);\r\n\r\n\t\t\tif (serial_nos_belongs_to_other_batch) {\r\n\t\t\t\tthis.serial_no_control.set_value(batch_serial_nos);\r\n\t\t\t\tthis.qty_control.set_value(batch_serial_map[batch_no].length);\r\n\t\t\t}\r\n\r\n\t\t\tdelete batch_serial_map[batch_no];\r\n\r\n\t\t\tif (serial_nos_belongs_to_other_batch)\r\n\t\t\t\tthis.events.clone_new_batch_item_in_frm(batch_serial_map, this.current_item);\r\n\t\t}\r\n\t}\r\n\r\n\tbind_events() {\r\n\t\tthis.bind_auto_serial_fetch_event();\r\n\t\tthis.bind_fields_to_numpad_fields();\r\n\r\n\t\tthis.$component.on('click', '.close-btn', () => {\r\n           \r\n\t\t\tthis.events.close_item_details();\r\n\t\t});\r\n\t}\r\n\r\n\tattach_shortcuts() {\r\n\t\tthis.wrapper.find('.close-btn').attr(\"title\", \"Esc\");\r\n\t\tfrappe.ui.keys.on(\"escape\", () => {\r\n\t\t\tconst item_details_visible = this.$component.is(\":visible\");\r\n\t\t\tif (item_details_visible) {\r\n\t\t\t\tthis.events.close_item_details();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tbind_fields_to_numpad_fields() {\r\n\t\tconst me = this;\r\n\t\tthis.$form_container.on('click', '.input-with-feedback', function() {\r\n\t\t\tconst fieldname = $(this).attr('data-fieldname');\r\n\t\t\tif (this.last_field_focused != fieldname) {\r\n\t\t\t\tme.events.item_field_focused(fieldname);\r\n\t\t\t\tthis.last_field_focused = fieldname;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tbind_auto_serial_fetch_event() {\r\n\t\tthis.$form_container.on('click', '.auto-fetch-btn', () => {\r\n\t\t\tthis.batch_no_control && this.batch_no_control.set_value('');\r\n\t\t\tlet qty = this.qty_control.get_value();\r\n\t\t\tlet conversion_factor = this.conversion_factor_control.get_value();\r\n\t\t\tlet expiry_date = this.item_row.has_batch_no ? this.events.get_frm().doc.posting_date : \"\";\r\n\r\n\t\t\tlet numbers = frappe.call({\r\n\t\t\t\tmethod: \"erpnext.stock.doctype.serial_no.serial_no.auto_fetch_serial_number\",\r\n\t\t\t\targs: {\r\n\t\t\t\t\tqty: qty * conversion_factor,\r\n\t\t\t\t\titem_code: this.current_item.item_code,\r\n\t\t\t\t\twarehouse: this.warehouse_control.get_value() || '',\r\n\t\t\t\t\tbatch_nos: this.current_item.batch_no || '',\r\n\t\t\t\t\tposting_date: expiry_date,\r\n\t\t\t\t\tfor_doctype: 'POS Invoice'\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tnumbers.then((data) => {\r\n\t\t\t\tlet auto_fetched_serial_numbers = data.message;\r\n\t\t\t\tlet records_length = auto_fetched_serial_numbers.length;\r\n\t\t\t\tif (!records_length) {\r\n\t\t\t\t\tconst warehouse = this.warehouse_control.get_value().bold();\r\n\t\t\t\t\tconst item_code = this.current_item.item_code.bold();\r\n\t\t\t\t\tfrappe.msgprint(\r\n\t\t\t\t\t\t__('Serial numbers unavailable for Item {0} under warehouse {1}. Please try changing warehouse.', [item_code, warehouse])\r\n\t\t\t\t\t);\r\n\t\t\t\t} else if (records_length < qty) {\r\n\t\t\t\t\tfrappe.msgprint(\r\n\t\t\t\t\t\t__('Fetched only {0} available serial numbers.', [records_length])\r\n\t\t\t\t\t);\r\n\t\t\t\t\tthis.qty_control.set_value(records_length);\r\n\t\t\t\t}\r\n\t\t\t\tnumbers = auto_fetched_serial_numbers.join(`\\n`);\r\n\t\t\t\tthis.serial_no_control.set_value(numbers);\r\n\t\t\t});\r\n\t\t})\r\n\t}\r\n\r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\r\n\t}\r\n}","erpnext.PointOfSale.NumberPad = class {\n\tconstructor({ wrapper, events, cols, keys, css_classes, fieldnames_map }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.cols = cols;\n\t\tthis.keys = keys;\n\t\tthis.css_classes = css_classes || [];\n\t\tthis.fieldnames = fieldnames_map || {};\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.bind_events();\n\t}\n\n\tprepare_dom() {\n\t\tconst { cols, keys, css_classes, fieldnames } = this;\n\n\t\tfunction get_keys() {\n\t\t\treturn keys.reduce((a, row, i) => {\n\t\t\t\treturn a + row.reduce((a2, number, j) => {\n\t\t\t\t\tconst class_to_append = css_classes && css_classes[i] ? css_classes[i][j] : '';\n\t\t\t\t\tconst fieldname = fieldnames && fieldnames[number] ?\n\t\t\t\t\t\tfieldnames[number] : typeof number === 'string' ? frappe.scrub(number) : number;\n\n\t\t\t\t\treturn a2 + `<div class=\"numpad-btn ${class_to_append}\" data-button-value=\"${fieldname}\">${number}</div>`;\n\t\t\t\t}, '');\n\t\t\t}, '');\n\t\t}\n\n\t\tthis.wrapper.html(\n\t\t\t`<div class=\"numpad-container\">\n\t\t\t\t${get_keys()}\n\t\t\t</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.wrapper.on('click', '.numpad-btn', function() {\n\t\t\tconst $btn = $(this);\n\t\t\tme.events.numpad_event($btn);\n\t\t});\n\t}\n}","/* eslint-disable no-unused-vars */\r\n\r\n\r\nerpnext.PointOfSale.Payment = class {\r\n\tconstructor({ events, wrapper }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\r\n\r\n\t\tthis.init_component();\r\n\t}\r\n    \r\n\tinit_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.initialize_numpad();\r\n\t\tthis.bind_events();\r\n\t\tthis.attach_shortcuts();\r\n        \r\n\r\n\t}\r\n    \r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<section class=\"payment-container\">\r\n\t\t\t\t<div class=\"section-label payment-section\">Payment Method</div>\r\n                \r\n\t\t\t\t<div class=\"payment-modes \">                \r\n                </div>\r\n                <div class=\"fields-numpad-container\"  style=\"margin-top: -335px;flex:0;\r\n\t\t\t\tmargin-left: 300px;\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\tdisplay: block;height:250px\">\r\n                <div class=\"number-pad\"></div></div>\r\n                \r\n\t\t\t\t\r\n\t\t\t\t\t<div class=\"fields-section\">\r\n\t\t\t\t\t\t<div class=\"section-label\">Additional Information</div>\r\n\t\t\t\t\t\t<div class=\"invoice-fields\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t<div class=\"totals-section\">\r\n\t\t\t\t\t<div class=\"totals\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"submit-order-btn\">Complete Order</div>\r\n\t\t\t</section>`\r\n\t\t);\r\n\t\tthis.$component = this.wrapper.find('.payment-container');\r\n\t\tthis.$payment_modes = this.$component.find('.payment-modes');\r\n\t\tthis.$totals_section = this.$component.find('.totals-section');\r\n\t\tthis.$totals = this.$component.find('.totals');\r\n\t\tthis.$numpad = this.$component.find('.number-pad');\r\n\t\tthis.$invoice_fields_section = this.$component.find('.fields-section');\r\n        this.$payment_modes.css({\r\n            'display':'block',\r\n            'width':'50%',\r\n\t\t\t'height':'320px',\r\n            'overflow-y': 'scroll'\r\n        })\r\n        //this.$totals_section.css('margin-top','0')\r\n        this.$numpad.css({'height': '270px'})\r\n        this.$component.find('.numpad-container').css('gap','0')\r\n        this.$component.css('height','90vh')\r\n\t}\r\n\r\n\tmake_invoice_fields_control() {\r\n        const me=this\r\n\t\tfrappe.db.get_doc(\"POS Settings\", undefined).then((doc) => {\r\n\t\t\tconst fields = doc.invoice_fields;\r\n\t\t\tif (!fields.length) return;\r\n\r\n\t\t\tthis.$invoice_fields = this.$invoice_fields_section.find('.invoice-fields');\r\n\t\t\tthis.$invoice_fields.html('');\r\n\t\t\tconst frm = this.events.get_frm();\r\n\r\n\t\t\tfields.forEach(df => {\r\n\t\t\t\tthis.$invoice_fields.append(\r\n\t\t\t\t\t`<div class=\"invoice_detail_field ${df.fieldname}-field\" data-fieldname=\"${df.fieldname}\" ></div>`\r\n\t\t\t\t);\r\n\t\t\t\tlet df_events = {\r\n\t\t\t\t\tonchange: function() {\r\n                        \r\n                        const doc = me.events.get_frm().doc;\r\n\t\t\t            const paid_amount = doc.paid_amount;\r\n\t\t\t            const items = doc.items;\r\n                        frm.set_value(this.df.fieldname, this.value);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tif (df.fieldtype == \"Button\") {\r\n\t\t\t\t\tdf_events = {\r\n\t\t\t\t\t\tclick:  function() {\r\n                            if(!frm.doc.applied_coupen){\r\n\t\t\t\t\t\t\tif ( frm.script_manager.has_handlers(df.fieldname, frm.doc.doctype)) {\r\n\t\t\t\t\t\t\t\t frm.script_manager.trigger(df.fieldname, frm.doc.doctype, frm.doc.docname)\r\n\t\t\t\t\t\t\t}\r\n                        }\r\n                        else{\r\n                            frappe.throw(\"Only one Coupon can applied; Applied Coupon: \"+frm.doc.applied_coupen)\r\n                        }\r\n                            setTimeout(() => {\r\n                            me.update_coupen_section()},500)\r\n                           \r\n                            \r\n                            \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis[`${df.fieldname}_field`] = frappe.ui.form.make_control({\r\n\t\t\t\t\tdf: {\r\n\t\t\t\t\t\t...df,\r\n\t\t\t\t\t\t...df_events\r\n\t\t\t\t\t},\r\n\t\t\t\t\tparent: this.$invoice_fields.find(`.${df.fieldname}-field`),\r\n\t\t\t\t\trender_input: true,\r\n\t\t\t\t});\r\n\t\t\t\tthis[`${df.fieldname}_field`].set_value(frm.doc[df.fieldname]);\r\n\t\t\t});\r\n\t\t});\r\n        \r\n       \r\n\t}\r\n   \r\n\tinitialize_numpad() {\r\n\t\tconst me = this;\r\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\r\n\t\t\twrapper: this.$numpad,\r\n\t\t\tevents: {\r\n\t\t\t\tnumpad_event: function($btn) {\r\n\t\t\t\t\tme.on_numpad_clicked($btn);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcols: 3,\r\n\t\t\tkeys: [\r\n\t\t\t\t[ 1, 2, 3 ],\r\n\t\t\t\t[ 4, 5, 6 ],\r\n\t\t\t\t[ 7, 8, 9 ],\r\n\t\t\t\t[ '.', 0, 'Delete' ]\r\n\t\t\t],\r\n\t\t});\r\n\r\n\t\tthis.numpad_value = '';\r\n\t}\r\n\r\n\ton_numpad_clicked($btn) {\r\n\t\tconst button_value = $btn.attr('data-button-value');\r\n\r\n\t\thighlight_numpad_btn($btn);\r\n\t\tthis.numpad_value = button_value === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + button_value;\r\n\t\tthis.selected_mode.$input.get(0).focus();\r\n\t\tthis.selected_mode.set_value(this.numpad_value);\r\n\r\n\t\tfunction highlight_numpad_btn($btn) {\r\n\t\t\t$btn.addClass('shadow-base-inner bg-selected');\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\t$btn.removeClass('shadow-base-inner bg-selected');\r\n\t\t\t}, 100);\r\n\t\t}\r\n\t}\r\n\r\n\tbind_events() {\r\n\t\tconst me = this;\r\n\r\n\t\tthis.$payment_modes.on('click', '.mode-of-payment', function(e) {\r\n\t\t\tconst mode_clicked = $(this);\r\n\t\t\t// if clicked element doesn't have .mode-of-payment class then return\r\n\t\t\tif (!$(e.target).is(mode_clicked)) return;\r\n\r\n\t\t\tconst scrollLeft = mode_clicked.offset().left - me.$payment_modes.offset().left + me.$payment_modes.scrollLeft();\r\n\t\t\tme.$payment_modes.animate({ scrollLeft });\r\n\r\n\t\t\tconst mode = mode_clicked.attr('data-mode');\r\n\r\n\t\t\t// hide all control fields and shortcuts\r\n\t\t\t$(`.mode-of-payment-control`).css('display', 'none');\r\n\t\t\t$(`.cash-shortcuts`).css('display', 'none');\r\n            $(`.shortcut`).css('padding', '0');\r\n\t\t\tme.$payment_modes.find(`.pay-amount`).css('display', 'inline');\r\n\t\t\tme.$payment_modes.find(`.loyalty-amount-name`).css('display', 'none');\r\n\r\n\t\t\t// remove highlight from all mode-of-payments\r\n\t\t\t$('.mode-of-payment').removeClass('border-primary');\r\n            $('.mode-of-payment').css({\r\n                'padding':'3px'\r\n            })\r\n\r\n\t\t\tif (mode_clicked.hasClass('border-primary')) {\r\n\t\t\t\t// clicked one is selected then unselect it\r\n\t\t\t\tmode_clicked.removeClass('border-primary');\r\n\t\t\t\tme.selected_mode = '';\r\n\t\t\t} else {\r\n\t\t\t\t// clicked one is not selected then select it\r\n\t\t\t\tmode_clicked.addClass('border-primary');\r\n\t\t\t\tmode_clicked.find('.mode-of-payment-control').css('display', 'flex');\r\n\t\t\t\tmode_clicked.find('.cash-shortcuts').css('display', 'grid');\r\n\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).css('display', 'none');\r\n\t\t\t\tme.$payment_modes.find(`.${mode}-name`).css('display', 'inline');\r\n\r\n\t\t\t\tme.selected_mode = me[`${mode}_control`];\r\n\t\t\t\tme.selected_mode && me.selected_mode.$input.get(0).focus();\r\n\t\t\t\tme.auto_set_remaining_amount();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tfrappe.ui.form.on('POS Invoice', 'contact_mobile', (frm) => {\r\n\t\t\tconst contact = frm.doc.contact_mobile;\r\n            var request_button = null;\r\n            if (this && this.request_for_payment_field)\r\n\t\t\t request_button = $(this.request_for_payment_field.$input[0]);\r\n\t\t\tif(request_button){if (contact) {\r\n\t\t\t\trequest_button.removeClass('btn-default').addClass('btn-primary');\r\n\t\t\t} else {\r\n\t\t\t\trequest_button.removeClass('btn-primary').addClass('btn-default');\r\n      }}\r\n    });\r\n\r\n\t\tthis.setup_listener_for_payments();\r\n\r\n\t\tthis.$payment_modes.on('click', '.shortcut' , function()  {\r\n            const cash_clicked = $(this);\r\n\t\t\tconst value = $(this).attr('data-value');\r\n          \r\n\t\t\tme.selected_mode.set_value(value);\r\n\t\t});\r\n\r\n\t\tthis.$component.on('click', '.submit-order-btn', () => {\r\n\t\t\tconst doc = this.events.get_frm().doc;\r\n\t\t\tconst paid_amount = doc.paid_amount;\r\n\t\t\tconst items = doc.items;\r\n\t\t\t\r\n            if (!cur_pos.cart.customer_field.value) {\r\n\t\t\t\tcur_pos.cart.customer_field.value=$('.reset-customer-btn').attr(\"data-customer\")\r\n\t\t\t\t\r\n\t\t\t\tif($('.reset-customer-btn').attr(\"data-customer\")=='')\r\n\t\t\t\t{\r\n\t\t\t\t\tconst message = items.length ? __(\"You cannot submit the order without Customer.\") : __(\"You cannot submitthe order without Customer.\");\r\n\t\t\t\t\tfrappe.show_alert({ message, indicator: \"orange\" });\r\n\t\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n            if(!cur_frm.doc.customer && !cur_frm.doc.customer_name){\r\n                const message = items.length ? __(\"You cannot submit the order without Customer.\") : __(\"You cannot submit the order without Customer.\");\r\n\t\t\t\t\tfrappe.show_alert({ message, indicator: \"orange\" });\r\n\t\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\t\treturn;\r\n            }\r\n           // console.log((doc.grand_total-doc.total_advance)-paid_amount,\"paid_amount+doc.total_advance\")\r\n\t\t\tif (flt((doc.grand_total-doc.total_advance).toFixed(2))-paid_amount> 0  ||  !items.length) {\r\n\t\t\t\tconst message = items.length ? __(\"You cannot submit the order without payment.\") : __(\"You cannot submit empty order.\");\r\n\t\t\t\tfrappe.show_alert({ message, indicator: \"orange\" });\r\n\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n            cur_frm.doc.items.forEach(item => {\r\n                if(item.bundle_item && item.bundle_item==1){\r\n                    var check_bundle_item = cur_frm.doc.seleceted_packed_items.filter(bundle_item => \r\n                      (bundle_item.parent_item === item.item_code ));\r\n                      if(check_bundle_item.length==0)\r\n                      {\r\n                        const message = items.length ? __(\"You cannot submit the order without select bundle for item :\"+item.item_code) : __(\"You cannot submit the order select bundle for item :\"+item.item_code);\r\n                        frappe.throw({ message, indicator: \"orange\" });\r\n                        frappe.utils.play_sound(\"error\");\r\n                        return;\r\n                      }\r\n\r\n                }\r\n                if(!item.income_account){\r\n                    console.log(cur_frm.doc.company)\r\n                    frappe.db.get_value('Company', cur_frm.doc.company, 'default_income_account').then(({ message }) => {\r\n                        item.income_account = (message.default_income_account) || false;\r\n                    });\r\n                }\r\n               \r\n            })\r\n            var tbl = cur_frm.doc.seleceted_packed_items || [];\r\n           console.log(cur_frm.doc.items,\"cur_frm.doc.items\")\r\n            var i = tbl.length;\r\n            while (i--)\r\n            {\r\n                 if(tbl[i].packed_quantity == 0)\r\n                    {\r\n                     cur_frm.get_field(\"seleceted_packed_items\").grid.grid_rows[i].remove();\r\n                     }\r\n                    //  else if(cur_frm.doc.is_return){\r\n                    //     tbl[i].packed_quantity=tbl[i].packed_quantity*-1\r\n                    //  }\r\n            }\r\n            \r\n            \r\n            var tbl_itm = cur_frm.doc.payments || [];\r\n           \r\n            var m = tbl_itm.length;\r\n            while (m--)\r\n            {\r\n                 if(tbl_itm[m].amount == '')\r\n                    {\r\n                        tbl_itm[m].amount=0\r\n                     }\r\n                    \r\n            }\r\n            \r\n            cur_frm.refresh();\r\n            \r\n            doc.advance=[];\r\n           \r\n\t\t\tthis.events.submit_invoice();\t\r\n\t\t\tcur_pos.item_selector.item_group_field.set_value('');\r\n\t\t\tcur_pos.item_selector.$items_container.html('')\r\n\t\t\tcur_pos.item_selector.load_items_data()\r\n            cur_pos.combo_item_details.combo_items = [];\r\n\t\t    cur_pos.combo_item_details.combo_default_items = [];\r\n            cur_pos.combo_item_details.total_packed_qty=0\r\n\t\t\tcur_pos.item_selector.bundle_item=0\r\n\t\t\t\r\n\t\t\t$(cur_pos.cart.sosearch_field.$input[0]).val('')\r\n\t\t\t\r\n\t\t});\r\n\r\n\t\tfrappe.ui.form.on('POS Invoice', 'paid_amount', (frm) => {\r\n\t\t\tthis.update_totals_section(frm.doc);\r\n\r\n\t\t\t// need to re calculate cash shortcuts after discount is applied\r\n\t\t\tconst is_cash_shortcuts_invisible = !this.$payment_modes.find('.cash-shortcuts').is(':visible');\r\n\t\t\tthis.attach_cash_shortcuts(frm.doc);\r\n\t\t\t!is_cash_shortcuts_invisible && this.$payment_modes.find('.cash-shortcuts').css('display', 'grid');\r\n\t\t});\r\n       \r\n\t\tfrappe.ui.form.on('POS Invoice', 'loyalty_amount', (frm) => {\r\n\t\t\tconst formatted_currency = format_currency(frm.doc.loyalty_amount, frm.doc.currency,2);\r\n\t\t\tthis.$payment_modes.find(`.loyalty-amount-amount`).html(formatted_currency);\r\n\t\t});\r\n\r\n\t\tfrappe.ui.form.on(\"Sales Invoice Payment\", \"amount\", (frm, cdt, cdn) => {\r\n\t\t\t// for setting correct amount after loyalty points are redeemed\r\n\t\t\tconst default_mop = locals[cdt][cdn];\r\n           \r\n\t\t\tconst mode = default_mop.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\r\n\t\t\tif (this[`${mode}_control`] && this[`${mode}_control`].get_value() != default_mop.amount) {\r\n\t\t\t\tthis[`${mode}_control`].set_value(default_mop.amount);\r\n\t\t\t}\r\n\t\t});\r\n       \r\n        \r\n\t\r\n\t}\r\n    \r\n\tsetup_listener_for_payments() {\r\n\t\tfrappe.realtime.on(\"process_phone_payment\", (data) => {\r\n\t\t\tconst doc = this.events.get_frm().doc;\r\n\t\t\tconst { response, amount, success, failure_message } = data;\r\n\t\t\tlet message, title;\r\n\r\n\t\t\tif (success) {\r\n\t\t\t\ttitle = __(\"Payment Received\");\r\n\t\t\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\r\n\t\t\t\tif (amount >= grand_total) {\r\n\t\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully.\", [format_currency(amount, doc.currency, 0)]);\r\n\t\t\t\t\tthis.events.submit_invoice();\r\n                    \r\n\t\t\t\t\tcur_frm.reload_doc();\r\n\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully. Waiting for other requests to complete...\", [format_currency(amount, doc.currency, 0)]);\r\n\t\t\t\t}\r\n\t\t\t} else if (failure_message) {\r\n\t\t\t\tmessage = failure_message;\r\n\t\t\t\ttitle = __(\"Payment Failed\");\r\n\t\t\t}\r\n\r\n\t\t\tfrappe.msgprint({ \"message\": message, \"title\": title });\r\n\t\t});\r\n\t}\r\n\r\n\t// auto_set_remaining_amount() {\r\n\t// \tconst doc = this.events.get_frm().doc;\r\n\t// \tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\r\n\t// \t//const remaining_amount = grand_total - doc.paid_amount;\r\n    //     const remaining_amount = grand_total - doc.paid_amount-(doc.total_advance?doc.total_advance:0);\r\n\t// \tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\r\n\t// \tif (!current_value && remaining_amount > 0 && this.selected_mode) {\r\n\t// \t\tthis.selected_mode.set_value(remaining_amount);\r\n\t// \t}\r\n\t// }\r\n    auto_set_remaining_amount() {\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\r\n\t\tconst remaining_amount = grand_total - doc.paid_amount;\r\n\t\tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\r\n        console.log(\"auto_set_remaining_amount=1\")\r\n\t\tif (!current_value && remaining_amount > 0 && this.selected_mode) {\r\n\t\t\tthis.selected_mode.set_value(flt(remaining_amount.toFixed(2)));\r\n\t\t}\r\n\t}\r\n\tsetup_listener_for_payments() {\r\n\t\tfrappe.realtime.on(\"process_phone_payment\", (data) => {\r\n\t\t\tconst doc = this.events.get_frm().doc;\r\n\t\t\tconst { response, amount, success, failure_message } = data;\r\n\t\t\tlet message, title;\r\n\r\n\t\t\tif (success) {\r\n\t\t\t\ttitle = __(\"Payment Received\");\r\n\t\t\t\tif (amount >= doc.grand_total) {\r\n\t\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully.\", [format_currency(amount, doc.currency, 0)]);\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.events.submit_invoice();                   \r\n                   \r\n\t\t\t\t\tcur_frm.reload_doc();\r\n\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully. Waiting for other requests to complete...\", [format_currency(amount, doc.currency, 0)]);\r\n\t\t\t\t}\r\n\t\t\t} else if (failure_message) {\r\n\t\t\t\tmessage = failure_message;\r\n\t\t\t\ttitle = __(\"Payment Failed\");\r\n\t\t\t}\r\n\r\n\t\t\tfrappe.msgprint({ \"message\": message, \"title\": title });\r\n\t\t});\r\n\t}\r\n    auto_set_remaining_amount() {\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst remaining_amount = doc.grand_total - doc.paid_amount;\r\n\t\tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\r\n        // console.log(\"auto_set_remaining_amount=2\")\r\n        // console.log(remaining_amount,current_value,\"hkgkjfjh\")\r\n\t\tif (!current_value && remaining_amount > 0 && this.selected_mode) {\r\n           // console.log(flt((remaining_amount-doc.total_advance).toFixed(2)),current_value,remaining_amount,this.selected_mode,doc.total_advance,\"doc.total_advance\")\r\n\t\t\t//this.selected_mode.set_value(remaining_amount-doc.total_advance);\r\n            this.selected_mode.set_value(flt((remaining_amount-doc.total_advance).toFixed(2)));\r\n\t\t}\r\n\t}\r\n\t// auto_set_remaining_amount() {\r\n\t// \tconst doc = this.events.get_frm().doc;\r\n\t// \t//const remaining_amount = doc.grand_total - doc.paid_amount;\r\n    //     const remaining_amount = doc.grand_total - doc.paid_amount-(doc.total_advance?doc.total_advance:0);\r\n\t// \tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\r\n\t// \tif (!current_value && remaining_amount > 0 && this.selected_mode) {\r\n\t// \t\tthis.selected_mode.set_value(remaining_amount);\r\n\t// \t}\r\n\t// }\r\n\r\n\tattach_shortcuts() {\r\n\t\tconst ctrl_label = frappe.utils.is_mac() ? 'âŒ˜' : 'Ctrl';\r\n\t\tthis.$component.find('.submit-order-btn').attr(\"title\", `${ctrl_label}+Enter`);\r\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\r\n\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\r\n\t\t\tconst active_mode = this.$payment_modes.find(\".border-primary\");\r\n\t\t\tif (payment_is_visible && active_mode.length) {\r\n\t\t\t\tthis.$component.find('.submit-order-btn').click();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tfrappe.ui.keys.add_shortcut({\r\n\t\t\tshortcut: \"tab\",\r\n\t\t\taction: () => {\r\n\t\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\r\n\t\t\t\tlet active_mode = this.$payment_modes.find(\".border-primary\");\r\n\t\t\t\tactive_mode = active_mode.length ? active_mode.attr(\"data-mode\") : undefined;\r\n\r\n\t\t\t\tif (!active_mode) return;\r\n\r\n\t\t\t\tconst mode_of_payments = Array.from(this.$payment_modes.find(\".mode-of-payment\")).map(m => $(m).attr(\"data-mode\"));\r\n\t\t\t\tconst mode_index = mode_of_payments.indexOf(active_mode);\r\n\t\t\t\tconst next_mode_index = (mode_index + 1) % mode_of_payments.length;\r\n\t\t\t\tconst next_mode_to_be_clicked = this.$payment_modes.find(`.mode-of-payment[data-mode=\"${mode_of_payments[next_mode_index]}\"]`);\r\n\r\n\t\t\t\tif (payment_is_visible && mode_index != next_mode_index) {\r\n\t\t\t\t\tnext_mode_to_be_clicked.click();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcondition: () => this.$component.is(':visible') && this.$payment_modes.find(\".border-primary\").length,\r\n\t\t\tdescription: __(\"Switch Between Payment Modes\"),\r\n\t\t\tignore_inputs: true,\r\n\t\t\tpage: cur_page.page.page\r\n\t\t});\r\n\t}\r\n\r\n\ttoggle_numpad() {\r\n\t\t// pass\r\n\t}\r\n\r\n\trender_payment_section() {\r\n\t\tthis.render_payment_mode_dom();\r\n\t\tthis.make_invoice_fields_control();\r\n\t\tthis.update_totals_section();\r\n\t}\r\n\r\n\tedit_cart() {\r\n\t\tthis.events.toggle_other_sections(false);\r\n\t\tthis.toggle_component(false);\r\n\t}\r\n\r\n\tcheckout() {\r\n\t\tthis.events.toggle_other_sections(true);\r\n\t\tthis.toggle_component(true);\r\n\r\n\t\tthis.render_payment_section();\r\n\t}\r\n\r\n\ttoggle_remarks_control() {\r\n\t\tif (this.$remarks.find('.frappe-control').length) {\r\n\t\t\tthis.$remarks.html('+ Add Remark');\r\n\t\t} else {\r\n\t\t\tthis.$remarks.html('');\r\n\t\t\tthis[`remark_control`] = frappe.ui.form.make_control({\r\n\t\t\t\tdf: {\r\n\t\t\t\t\tlabel: __('Remark'),\r\n\t\t\t\t\tfieldtype: 'Data',\r\n\t\t\t\t\tonchange: function() {\r\n                       \r\n\r\n                    }\r\n\t\t\t\t},\r\n\t\t\t\tparent: this.$totals_section.find(`.remarks`),\r\n\t\t\t\trender_input: true,\r\n\t\t\t});\r\n\t\t\tthis[`remark_control`].set_value('');\r\n\t\t}\r\n\t}\r\n\r\n\trender_payment_mode_dom() {\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst payments = doc.payments;\r\n\t\tconst currency = doc.currency;\r\n\t\tconsole.log(doc.payments,\"doc.payments\")\r\n\t\tthis.$payment_modes.html(`${\r\n\t\t\tpayments.map((p, i) => {\r\n\t\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\r\n\t\t\t\tconst payment_type = p.type;\r\n\t\t\t\tconst margin = i % 2 === 0 ? 'pr-2' : 'pl-2';\r\n\t\t\t\tconst amount = p.amount > 0 ?  format_currency(p.amount, currency,2): '';\r\n                //console.log(p.amount,\"payamt\",amount,doc.advances)\r\n\t\t\t\treturn (`\r\n\t\t\t\t\t<div class=\"payment-mode-wrapper\">\r\n\t\t\t\t\t\t<div class=\"mode-of-payment\" data-mode=\"${mode}\" data-payment-type=\"${payment_type}\">\r\n\t\t\t\t\t\t\t${p.mode_of_payment}\r\n\t\t\t\t\t\t\t<div class=\"${mode}-amount pay-amount\">${amount}</div>\r\n\t\t\t\t\t\t\t<div class=\"${mode} mode-of-payment-control\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t`);\r\n\t\t\t}).join('')\r\n\t\t}`);\r\n        //flt(this.value)==doc.total_advance? '':flt(this.value)\r\n\t\tpayments.forEach(p => {\r\n\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\r\n\t\t\tconst me = this;\r\n\t\t\tthis[`${mode}_control`] = frappe.ui.form.make_control({\r\n\t\t\t\tdf: {\r\n\t\t\t\t\tlabel: p.mode_of_payment,\r\n\t\t\t\t\tfieldtype: 'Currency',\r\n\t\t\t\t\tplaceholder: __('Enter {0} amount.', [p.mode_of_payment]),\r\n                    onchange: function() {\r\n\t\t\t\t\t\tconst current_value = frappe.model.get_value(p.doctype, p.name, 'amount');\r\n\t\t\t\t\t\tif (current_value != this.value) {\r\n\t\t\t\t\t\t\tfrappe.model\r\n\t\t\t\t\t\t\t\t.set_value(p.doctype, p.name, 'amount', flt(flt(this.value).toFixed(2)))\r\n\t\t\t\t\t\t\t\t.then(() => me.update_totals_section())\r\n\r\n\t\t\t\t\t\t\tconst formatted_currency = format_currency(this.value, currency,2);\r\n\t\t\t\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).html(formatted_currency);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n                    // onchange: function() {\r\n\t\t\t\t\t// \tconst current_value = frappe.model.get_value(p.doctype, p.name, 'amount');\r\n\t\t\t\t\t// \tif (current_value != this.value) {\r\n                    //         var totAmt=flt(this.value)\r\n                    //         if(doc.total_advance>0)\r\n                    //         {\r\n                    //             if(flt(this.value)==doc.total_advance)\r\n                    //             {\r\n                    //                 totAmt=\"\"\r\n                    //             }\r\n                    //             else if(flt(this.value)>doc.total_advance)\r\n                    //             {\r\n                    //                 totAmt=flt(this.value)-doc.total_advance\r\n                    //             }\r\n                    //             else{\r\n                    //                 totAmt=''\r\n                    //             }\r\n                    //         }\r\n\t\t\t\t\t// \t\tfrappe.model\r\n\t\t\t\t\t// \t\t\t.set_value(p.doctype, p.name, 'amount', totAmt)\r\n\t\t\t\t\t// \t\t\t.then(() => me.update_totals_section())\r\n\r\n\t\t\t\t\t// \t\tconst formatted_currency = format_currency(this.value, currency,2);\r\n\t\t\t\t\t// \t\tme.$payment_modes.find(`.${mode}-amount`).html(formatted_currency);\r\n\t\t\t\t\t// \t}\r\n\t\t\t\t\t// }\r\n\t\t\t\t},\r\n\t\t\t\tparent: this.$payment_modes.find(`.${mode}.mode-of-payment-control`),\r\n\t\t\t\trender_input: true,\r\n\t\t\t});\r\n\t\t\tthis[`${mode}_control`].toggle_label(false);\r\n\t\t\tthis[`${mode}_control`].set_value(p.amount.toFixed(2));\r\n\r\n\t\t\tif (p.default) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.$payment_modes.find(`.${mode}.mode-of-payment-control`).parent().click();\r\n\t\t\t\t}, 500);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.render_loyalty_points_payment_mode();\r\n\r\n\t\tthis.attach_cash_shortcuts(doc);\r\n\t}\r\n\r\n\tattach_cash_shortcuts(doc) {\r\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\r\n\t\tconst currency = doc.currency;\r\n\r\n\t\tconst shortcuts = this.get_cash_shortcuts(flt(grand_total));\r\n\r\n\t\tthis.$payment_modes.find('.cash-shortcuts').remove();\r\n\t\tlet shortcuts_html = shortcuts.map(s => {\r\n\t\t\treturn `<div class=\"shortcut\" data-value=\"${s}\">${format_currency(s, currency, 0)}</div>`;\r\n\t\t}).join('');\r\n\r\n\t\tthis.$payment_modes.find('[data-payment-type=\"Cash\"]').find('.mode-of-payment-control')\r\n\t\t\t.after(`<div class=\"cash-shortcuts\">${shortcuts_html}</div>`);\r\n\t}\r\n\r\n\tget_cash_shortcuts(grand_total) {\r\n\t\tlet steps = [1, 5, 10];\r\n\t\tconst digits = String(Math.round(grand_total)).length;\r\n\r\n\t\tsteps = steps.map(x => x * (10 ** (digits - 2)));\r\n\r\n\t\tconst get_nearest = (amount, x) => {\r\n\t\t\tlet nearest_x = Math.ceil((amount / x)) * x;\r\n\t\t\treturn nearest_x === amount ? nearest_x + x : nearest_x;\r\n\t\t};\r\n\r\n\t\treturn steps.reduce((finalArr, x) => {\r\n\t\t\tlet nearest_x = get_nearest(grand_total, x);\r\n\t\t\tnearest_x = finalArr.indexOf(nearest_x) != -1 ? nearest_x + x : nearest_x;\r\n\t\t\treturn [...finalArr, nearest_x];\r\n\t\t}, []);\r\n\t}\r\n\r\n\trender_loyalty_points_payment_mode() {\r\n\t\tconst me = this;\r\n\t\tconst doc = this.events.get_frm().doc;\r\n\t\tconst { loyalty_program, loyalty_points, conversion_factor } = this.events.get_customer_details();\r\n\r\n\t\tthis.$payment_modes.find(`.mode-of-payment[data-mode=\"loyalty-amount\"]`).parent().remove();\r\n\r\n\t\tif (!loyalty_program) return;\r\n\r\n\t\tlet description, read_only, max_redeemable_amount;\r\n\t\tif (!loyalty_points) {\r\n\t\t\tdescription = __(\"You don't have enough points to redeem.\");\r\n\t\t\tread_only = true;\r\n\t\t} else {\r\n\t\t\tmax_redeemable_amount = flt(flt(loyalty_points) * flt(conversion_factor), precision(\"loyalty_amount\", doc));\r\n\t\t\tdescription = __(\"You can redeem upto {0}.\", [format_currency(max_redeemable_amount)]);\r\n\t\t\tread_only = false;\r\n\t\t}\r\n\r\n\t\tconst margin = this.$payment_modes.children().length % 2 === 0 ? 'pr-2' : 'pl-2';\r\n\t\tconst amount = doc.loyalty_amount > 0 ? format_currency(doc.loyalty_amount, doc.currency,2) : '';\r\n\t\tthis.$payment_modes.append(\r\n\t\t\t`<div class=\"payment-mode-wrapper\">\r\n\t\t\t\t<div class=\"mode-of-payment\" data-mode=\"loyalty-amount\" data-payment-type=\"loyalty-amount\">\r\n\t\t\t\t\tRedeem Loyalty Points\r\n\t\t\t\t\t<div class=\"loyalty-amount-amount pay-amount\">${amount}</div>\r\n\t\t\t\t\t<div class=\"loyalty-amount-name\">${loyalty_program}</div>\r\n\t\t\t\t\t<div class=\"loyalty-amount mode-of-payment-control\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>`\r\n\t\t);\r\n\r\n\t\tthis['loyalty-amount_control'] = frappe.ui.form.make_control({\r\n\t\t\tdf: {\r\n\t\t\t\tlabel: __(\"Redeem Loyalty Points\"),\r\n\t\t\t\tfieldtype: 'Currency',\r\n\t\t\t\tplaceholder: __(\"Enter amount to be redeemed.\"),\r\n\t\t\t\toptions: 'company:currency',\r\n\t\t\t\tread_only,\r\n\t\t\t\tonchange: async function() {\r\n\t\t\t\t\tif (!loyalty_points) return;\r\n\r\n\t\t\t\t\tif (this.value > max_redeemable_amount) {\r\n\t\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\t\tmessage: __(\"You cannot redeem more than {0}.\", [format_currency(max_redeemable_amount)]),\r\n\t\t\t\t\t\t\tindicator: \"red\"\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\r\n\t\t\t\t\t\tme['loyalty-amount_control'].set_value(0);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst redeem_loyalty_points = this.value > 0 ? 1 : 0;\r\n\t\t\t\t\tawait frappe.model.set_value(doc.doctype, doc.name, 'redeem_loyalty_points', redeem_loyalty_points);\r\n\t\t\t\t\tfrappe.model.set_value(doc.doctype, doc.name, 'loyalty_points', parseInt(this.value / conversion_factor));\r\n\t\t\t\t},\r\n\t\t\t\tdescription\r\n\t\t\t},\r\n\t\t\tparent: this.$payment_modes.find(`.loyalty-amount.mode-of-payment-control`),\r\n\t\t\trender_input: true,\r\n\t\t});\r\n\t\tthis['loyalty-amount_control'].toggle_label(false);\r\n       \r\n\t\t// this.render_add_payment_method_dom();\r\n\t}\r\n\r\n\trender_add_payment_method_dom() {\r\n\t\tconst docstatus = this.events.get_frm().doc.docstatus;\r\n\t\tif (docstatus === 0)\r\n\t\t\tthis.$payment_modes.append(\r\n\t\t\t\t`<div class=\"w-full pr-2\">\r\n\t\t\t\t\t<div class=\"add-mode-of-payment w-half text-grey mb-4 no-select pointer\">+ Add Payment Method</div>\r\n\t\t\t\t</div>`\r\n\t\t\t);\r\n\t}\r\n    async update_coupen_section(){\r\n        console.log(cur_frm.doc.applied_coupen,\"cur_frm.doc.applied_coupen\")\r\n        if(cur_frm.doc.applied_coupen)\r\n            {\r\n                $('input[data-fieldname=\"couponcode\"]').css(\"pointer-events\", \"none\")\r\n\r\n            }\r\n       else{\r\n        $('input[data-fieldname=\"couponcode\"]').css(\"pointer-events\", \"auto\")\r\n\r\n       }\r\n       \r\n\r\n    }\r\n\tupdate_totals_section(doc) {\r\n\t\tif (!doc) doc = this.events.get_frm().doc;\r\n\t\tconst paid_amount = doc.paid_amount+(doc.total_advance?doc.total_advance:0);\r\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\r\n\t\t//const remaining = grand_total - doc.paid_amount;\r\n        const remaining = grand_total - doc.paid_amount-(doc.total_advance?doc.total_advance:0);\r\n\t\tconst change = doc.change_amount || remaining <= 0 ? -1 * remaining : undefined;\r\n\t\tconst currency = doc.currency;\r\n\t\tconst label = change ? __('Change') : __('To Be Paid');\r\n       \r\n\t\tthis.$totals.html(\r\n\t\t\t`<div class=\"col\">\r\n\t\t\t\t<div class=\"total-label\">Grand Total</div>\r\n\t\t\t\t<div class=\"value\">${format_currency(grand_total, currency,2)}</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"seperator-y\"></div>\r\n\t\t\t<div class=\"col\">\r\n\t\t\t\t<div class=\"total-label\">Paid Amount</div>\r\n\t\t\t\t<div class=\"value\">${format_currency(paid_amount, currency,2)}</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"seperator-y\"></div>\r\n\t\t\t<div class=\"col\">\r\n\t\t\t\t<div class=\"total-label\">${label}</div>\r\n\t\t\t\t<div class=\"value\">${format_currency(change || remaining, currency,2)}</div>\r\n\t\t\t</div>`\r\n\t\t);\r\n\t}\r\n  \r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\r\n\t}\r\n};","erpnext.PointOfSale.PastOrderList = class {\r\n\tconstructor({ wrapper, events,pos_profile }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\r\n        this.pos_profile = pos_profile;\r\n\t\tthis.init_component();\r\n\t}\r\n\r\n\tinit_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.make_filter_section();\r\n\t\tthis.bind_events();\r\n\t}\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<section class=\"past-order-list\">\r\n\t\t\t\t<div class=\"filter-section\">\r\n\t\t\t\t\t<div class=\"label\">Recent Orders</div>\r\n\t\t\t\t\t<div class=\"search-field\"></div>\r\n\t\t\t\t\t<div class=\"status-field\"></div>\r\n                    <div class=\"approved-field\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"invoices-container\"></div>\r\n\t\t\t</section>`\r\n\t\t);\r\n\r\n\t\tthis.$component = this.wrapper.find('.past-order-list');\r\n\t\tthis.$invoices_container = this.$component.find('.invoices-container');\r\n\t}\r\n\r\n\tbind_events() {\r\n\t\tthis.search_field.$input.on('input', (e) => {\r\n\t\t\tclearTimeout(this.last_search);\r\n\t\t\tthis.last_search = setTimeout(() => {\r\n\t\t\t\tconst search_term = e.target.value;\r\n\t\t\t\tthis.refresh_list(search_term, this.status_field.get_value());\r\n\t\t\t}, 300);\r\n\t\t});\r\n\t\tconst me = this;\r\n\t\tthis.$invoices_container.on('click', '.invoice-wrapper', function() {\r\n\t\t\tconst invoice_name = unescape($(this).attr('data-invoice-name'));\r\n\r\n\t\t\tme.events.open_invoice_data(invoice_name);\r\n\t\t});\r\n\t}\r\n\r\n\tmake_filter_section() {\r\n\t\tconst me = this;\r\n\t\tthis.search_field = frappe.ui.form.make_control({\r\n\t\t\tdf: {\r\n\t\t\t\tlabel: __('Search'),\r\n\t\t\t\tfieldtype: 'Data',\r\n\t\t\t\tplaceholder: __('Search by invoice id or customer name')\r\n\t\t\t},\r\n\t\t\tparent: this.$component.find('.search-field'),\r\n\t\t\trender_input: true,\r\n\t\t});\r\n\t\tthis.status_field = frappe.ui.form.make_control({\r\n\t\t\tdf: {\r\n\t\t\t\tlabel: __('Invoice Status'),\r\n\t\t\t\tfieldtype: 'Select',\r\n\t\t\t\toptions: `Draft\\nPaid\\nReturn`,\r\n\t\t\t\tplaceholder: __('Filter by invoice status'),\r\n\t\t\t\tonchange: function() {\r\n\t\t\t\t\tif (me.$component.is(':visible')) me.refresh_list();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tparent: this.$component.find('.status-field'),\r\n\t\t\trender_input: true,\r\n\t\t});\r\n        // this.approved_field = frappe.ui.form.make_control({\r\n\t\t// \tdf: {\r\n\t\t// \t\tlabel: __('Is Approved'),\r\n\t\t// \t\tfieldtype: 'Check',\r\n\t\t// \t\tonchange: function() {\r\n\t\t// \t\t\tif (me.$component.is(':visible')) me.refresh_list();\r\n\t\t// \t\t}\r\n\t\t// \t},\r\n\t\t// \tparent: this.$component.find('.approved-field'),\r\n\t\t// \trender_input: true,\r\n\t\t// });\r\n\t\tthis.search_field.toggle_label(false);\r\n\t\tthis.status_field.toggle_label(false);\r\n        //this.approved_field.toggle_label(false);\r\n\t\tthis.status_field.set_value('Draft');\r\n       // this.approved_field.set_value(1);\r\n        \r\n\t}\r\n\r\n\trefresh_list() {\r\n\t\tfrappe.dom.freeze();\r\n\t\tthis.events.reset_summary();\r\n\t\tconst search_term = this.search_field.get_value();\r\n\t\tconst status = this.status_field.get_value();\r\n        const doc = this.events.get_frm().doc;\r\n        let pos_profile= doc.pos_profile;\r\n       // console.log(pos_profile,this.pos_profile,\"posprofi\")\r\n       // const isapproved = this.approved_field.get_value();\r\n\r\n\t\tthis.$invoices_container.html('');\r\n\r\n\t\treturn frappe.call({\r\n\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_past_order_list\",\r\n\t\t\tfreeze: true,\r\n\t\t\targs: { search_term, status,pos_profile },\r\n\t\t\tcallback: (response) => {\r\n\t\t\t\tfrappe.dom.unfreeze();\r\n                this.$invoices_container.html('');\r\n\t\t\t\tresponse.message.forEach(invoice => {\r\n\t\t\t\t\tconst invoice_html = this.get_invoice_html(invoice);\r\n\t\t\t\t\tthis.$invoices_container.append(invoice_html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tget_invoice_html(invoice) {\r\n\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\r\n\t\treturn (\r\n\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\r\n\t\t\t\t<div class=\"invoice-name-date\">\r\n\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\r\n\t\t\t\t\t<div class=\"invoice-date\">\r\n\t\t\t\t\t\t<svg class=\"mr-2\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"1\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n\t\t\t\t\t\t\t<path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/>\r\n\t\t\t\t\t\t</svg>\r\n\t\t\t\t\t\t${frappe.ellipsis(invoice.customer, 20)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"invoice-total-status\">\r\n\t\t\t\t\t<div class=\"invoice-total\">${format_currency(invoice.grand_total, invoice.currency, 0) || 0}</div>\r\n\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"seperator\"></div>`\r\n\t\t);\r\n\t}\r\n\r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'flex') && this.refresh_list() : this.$component.css('display', 'none');\r\n\t}\r\n};","erpnext.PointOfSale.PastOrderSummary = class {\r\n\tconstructor({ wrapper, events }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\r\n        this.sendinvoicesms=0;\r\n        this.posinvoice=0;\r\n\t\tthis.init_component();\r\n\t}\r\n\r\n\tinit_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.init_email_print_dialog();\r\n\t\tthis.bind_events();\r\n\t\tthis.attach_shortcuts();\r\n\t}\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<section class=\"past-order-summary\">\r\n\t\t\t\t<div class=\"no-summary-placeholder\">\r\n\t\t\t\t\tSelect an invoice to load summary data\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"invoice-summary-wrapper\">\r\n\t\t\t\t\t<div class=\"abs-container\">\r\n\t\t\t\t\t\t<div class=\"upper-section\"></div>\r\n\t\t\t\t\t\t<div class=\"label\">Items</div>\r\n\t\t\t\t\t\t<div class=\"items-container summary-container\"></div>\r\n\t\t\t\t\t\t<div class=\"label\">Totals</div>\r\n\t\t\t\t\t\t<div class=\"totals-container summary-container\"></div>\r\n\t\t\t\t\t\t<div class=\"label\">Payments</div>\r\n\t\t\t\t\t\t<div class=\"payments-container summary-container\"></div>\r\n\t\t\t\t\t\t<div class=\"summary-btns\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</section>`\r\n\t\t);\r\n\r\n\t\tthis.$component = this.wrapper.find('.past-order-summary');\r\n\t\tthis.$summary_wrapper = this.$component.find('.invoice-summary-wrapper');\r\n\t\tthis.$summary_container = this.$component.find('.abs-container');\r\n\t\tthis.$upper_section = this.$summary_container.find('.upper-section');\r\n\t\tthis.$items_container = this.$summary_container.find('.items-container');\r\n\t\tthis.$totals_container = this.$summary_container.find('.totals-container');\r\n\t\tthis.$payment_container = this.$summary_container.find('.payments-container');\r\n\t\tthis.$summary_btns = this.$summary_container.find('.summary-btns');\r\n\t}\r\n\r\n\tinit_email_print_dialog() {\r\n\t\tconst email_dialog = new frappe.ui.Dialog({\r\n\t\t\ttitle: 'Email Receipt',\r\n\t\t\tfields: [\r\n\t\t\t\t{fieldname: 'email_id', fieldtype: 'Data', options: 'Email', label: 'Email ID'},\r\n\t\t\t\t// {fieldname:'remarks', fieldtype:'Text', label:'Remarks (if any)'}\r\n\t\t\t],\r\n\t\t\tprimary_action: () => {\r\n\t\t\t\tthis.send_email();\r\n\t\t\t},\r\n\t\t\tprimary_action_label: __('Send'),\r\n\t\t});\r\n\t\tthis.email_dialog = email_dialog;\r\n\r\n\t\tconst print_dialog = new frappe.ui.Dialog({\r\n\t\t\ttitle: 'Print Receipt',\r\n\t\t\tfields: [\r\n\t\t\t\t{fieldname: 'print', fieldtype: 'Data', label: 'Print Preview'}\r\n\t\t\t],\r\n\t\t\tprimary_action: () => {\r\n\t\t\t\tthis.print_receipt();\r\n\t\t\t},\r\n\t\t\tprimary_action_label: __('Print'),\r\n\t\t});\r\n\t\tthis.print_dialog = print_dialog;\r\n\t}\r\n\r\n\tget_upper_section_html(doc) {\r\n\t\tconst { status } = doc;\r\n\t\tlet indicator_color = '';\r\n\r\n\t\tin_list(['Paid', 'Consolidated'], status) && (indicator_color = 'green');\r\n\t\tstatus === 'Draft' && (indicator_color = 'red');\r\n\t\tstatus === 'Return' && (indicator_color = 'grey');\r\n\r\n\t\treturn `<div class=\"left-section\">\r\n\t\t\t\t\t<div class=\"customer-name\">${doc.customer}7</div>\r\n\t\t\t\t\t<div class=\"customer-email\">${this.customer_email}</div>\r\n\t\t\t\t\t<div class=\"cashier\">Sold by: ${doc.owner}</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"right-section\">\r\n\t\t\t\t\t<div class=\"paid-amount\">${format_currency(doc.paid_amount, doc.currency,2)}</div>\r\n\t\t\t\t\t<div class=\"invoice-name\">${doc.name}</div>\r\n\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\"><span>${doc.status}</span></span>\r\n\t\t\t\t</div>`;\r\n\t}\r\n\r\n\tget_item_html(doc, item_data) {\r\n\t\treturn `<div class=\"item-row-wrapper\">\r\n\t\t\t\t\t<div class=\"item-name\">${item_data.item_name}</div>\r\n\t\t\t\t\t<div class=\"item-qty\">${item_data.qty || 0}</div>\r\n\t\t\t\t\t<div class=\"item-rate-disc\">${get_rate_discount_html()}</div>\r\n\t\t\t\t</div>`;\r\n\r\n\t\tfunction get_rate_discount_html() {\r\n\t\t\tif (item_data.rate && item_data.price_list_rate && item_data.rate !== item_data.price_list_rate) {\r\n\t\t\t\treturn `<span class=\"item-disc\">(${item_data.discount_percentage}% off)</span>\r\n\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, doc.currency,2)}</div>`;\r\n\t\t\t} else {\r\n\t\t\t\treturn `<div class=\"item-rate\">${format_currency(item_data.price_list_rate || item_data.rate, doc.currency,2)}</div>`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget_discount_html(doc) {\r\n\t\tif (doc.discount_amount) {\r\n\t\t\treturn `<div class=\"summary-row-wrapper\">\r\n\t\t\t\t\t\t<div>Discount (${doc.additional_discount_percentage} %)</div>\r\n\t\t\t\t\t\t<div>${format_currency(doc.discount_amount, doc.currency,2)}</div>\r\n\t\t\t\t\t</div>`;\r\n\t\t} else {\r\n\t\t\treturn ``;\r\n\t\t}\r\n\t}\r\n\r\n\tget_net_total_html(doc) {\r\n\t\treturn `<div class=\"summary-row-wrapper\">\r\n\t\t\t\t\t<div>Net Total</div>\r\n\t\t\t\t\t<div>${format_currency(doc.net_total, doc.currency,2)}</div>\r\n\t\t\t\t</div>`;\r\n\t}\r\n\r\n\tget_taxes_html(doc) {\r\n\t\tif (!doc.taxes.length) return '';\r\n\r\n\t\tlet taxes_html = doc.taxes.map(t => {\r\n\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\r\n\t\t\treturn `\r\n\t\t\t\t<div class=\"tax-row\">\r\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\r\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(t.tax_amount_after_discount_amount, doc.currency,2)}</div>\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t}).join('');\r\n\r\n\t\treturn `<div class=\"taxes-wrapper\">${taxes_html}</div>`;\r\n\t}\r\n\r\n\tget_grand_total_html(doc) {\r\n\t\treturn `<div class=\"summary-row-wrapper grand-total\">\r\n\t\t\t\t\t<div>Grand Total</div>\r\n\t\t\t\t\t<div>${format_currency(doc.grand_total, doc.currency,2)}</div>\r\n\t\t\t\t</div>`;\r\n\t}\r\n\r\n\tget_payment_html(doc, payment) {\r\n\t\treturn `<div class=\"summary-row-wrapper payments\">\r\n\t\t\t\t\t<div>${payment.mode_of_payment}</div>\r\n\t\t\t\t\t<div>${format_currency(payment.amount, doc.currency,2)}</div>\r\n\t\t\t\t</div>`;\r\n\t}\r\n\r\n\tbind_events() {\r\n        const pome = this;\r\n        cur_pos.item_selector.search_item_group.css('width','10%');\r\n\t\tthis.$summary_container.on('click', '.return-btn', () => {\r\n            const me = this;\r\n        const dialog = new frappe.ui.Dialog({\r\n        title: __('Approve Return'),\r\n          fields: [\r\n              {fieldtype: \"Section Break\"},\r\n              {fieldtype: 'Data', label: __('User'), fieldname: 'appuser',reqd:1\r\n                        },\r\n              {fieldtype: 'Password', label: __('Password'), fieldname: 'apppassword',reqd:1\r\n                   },\r\n            \r\n            ],\r\n            primary_action: async function({ appuser, apppassword}) {\r\n                if (!appuser) {\r\n                    frappe.show_alert({\r\n                        message: __(\"Please enter user name & password.\"),\r\n                        indicator: 'red'\r\n                    })\r\n                    return frappe.utils.play_sound(\"error\");\r\n                }\r\n               \r\n                const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.validate_user_permission\";\r\n                const res = await frappe.call({ method, args: { appuser, apppassword }, freeze:true });\r\n                \r\n                if(res.message==1)\r\n                {\r\n                    me.events.process_return(me.doc.name);\r\n                    me.toggle_component(false);\r\n                    me.$component.find('.no-summary-placeholder').css('display', 'flex');\r\n                    me.$summary_wrapper.css('display', 'none');\r\n                    dialog.hide();\r\n                   \r\n                }\r\n                else\r\n                {\r\n                    frappe.show_alert({\r\n                        message: __(\"No Permission.\"),\r\n                        indicator: 'red'\r\n                    })\r\n                   \r\n                }\r\n                \r\n                \r\n               \r\n            },\r\n            primary_action_label: __('Login')\r\n            });\r\n\r\n            dialog.show()\r\n            dialog.$wrapper.find('.modal-dialog').css(\"width\", \"400px\");\r\n\r\n               \r\n            \r\n\t\t\t\r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.edit-btn', () => {\r\n\t\t\t\r\n\t\t\tthis.events.edit_order(this.doc.name);\r\n\t\t\tthis.toggle_component(false);\r\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\r\n\t\t\tthis.$summary_wrapper.css('display', 'none');\r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\r\n\t\t\tthis.events.delete_order(this.doc.name);\r\n\t\t\tthis.show_summary_placeholder();\r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\r\n\t\t\tthis.events.delete_order(this.doc.name);\r\n\t\t\tthis.show_summary_placeholder();\r\n\t\t\t// this.toggle_component(false);\r\n\t\t\t// this.$component.find('.no-summary-placeholder').removeClass('d-none');\r\n\t\t\t// this.$summary_wrapper.addClass('d-none');\r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.new-btn', () => {\r\n\t\t\tthis.events.new_order();\r\n            // setTimeout(() => {\t\t\t\t\r\n\t\t\t \t//location.reload(true)\r\n\t\t\t// }, 100);\r\n\t\t\tthis.toggle_component(false);\r\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\r\n\t\t\tthis.$summary_wrapper.css('display', 'none');\r\n            $('.search-item-group').find('.dropdown-menu').find(\"a:first\").trigger(\"click\");\r\n           \r\n            \r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.email-btn', () => {\r\n\t\t\tthis.email_dialog.fields_dict.email_id.set_value(this.customer_email);\r\n\t\t\tthis.email_dialog.show();\r\n\t\t});\r\n\r\n\t\tthis.$summary_container.on('click', '.print-btn', () => {\r\n\t\t\tthis.print_receipt();\r\n\t\t});\r\n        this.$summary_container.on('click', '.send-btn', () => {\r\n            console.log(this.doc,'dssdds')\r\n            \r\n\t\t\tthis.make_dialog(this.doc.customer,this.doc.name);\r\n\t\t});\r\n        this.$summary_container.on('click', '.issue-btn', () => {\r\n            const me=this\r\n\t\t\tlet voucher = frappe.model.get_new_doc('Customer RFID');\r\n\t\t    voucher.pos_invoice =me.doc.name    \r\n            frappe.set_route('Form', 'Customer RFID', voucher.name);\r\n            cur_pos.show_header();\r\n\t\t});\r\n\t}\r\n    \r\nasync validate_approver(){\r\n    \r\n   \r\n}\r\n\tprint_receipt() {\r\n\t\tconst frm = this.events.get_frm();\r\n\t\tfrappe.utils.print(\r\n\t\t\tthis.doc.doctype,\r\n\t\t\tthis.doc.name,\r\n\t\t\tfrm.pos_print_format,\r\n\t\t\tthis.doc.letter_head,\r\n\t\t\tthis.doc.language || frappe.boot.lang\r\n\t\t);\r\n        //this.$summary_container.find('.new-btn').click()\r\n\t}\r\n\r\n\tattach_shortcuts() {\r\n\t\tconst ctrl_label = frappe.utils.is_mac() ? 'âŒ˜' : 'Ctrl';\r\n\t\tthis.$summary_container.find('.print-btn').attr(\"title\", `${ctrl_label}+P`);\r\n\t\tfrappe.ui.keys.add_shortcut({\r\n\t\t\tshortcut: \"ctrl+p\",\r\n\t\t\taction: () => this.$summary_container.find('.print-btn').click(),\r\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.print-btn').is(\":visible\"),\r\n\t\t\tdescription: __(\"Print Receipt\"),\r\n\t\t\tpage: cur_page.page.page\r\n\t\t});\r\n\t\tthis.$summary_container.find('.new-btn').attr(\"title\", `${ctrl_label}+Enter`);\r\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\r\n\t\t\tconst summary_is_visible = this.$component.is(\":visible\");\r\n\t\t\tif (summary_is_visible && this.$summary_container.find('.new-btn').is(\":visible\")) {\r\n\t\t\t\tthis.$summary_container.find('.new-btn').click();\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.$summary_container.find('.edit-btn').attr(\"title\", `${ctrl_label}+E`);\r\n\t\tfrappe.ui.keys.add_shortcut({\r\n\t\t\tshortcut: \"ctrl+e\",\r\n\t\t\taction: () => this.$summary_container.find('.edit-btn').click(),\r\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.edit-btn').is(\":visible\"),\r\n\t\t\tdescription: __(\"Edit Receipt\"),\r\n\t\t\tpage: cur_page.page.page\r\n\t\t});\r\n\t}\r\n\r\n\tsend_email() {\r\n\t\tconst frm = this.events.get_frm();\r\n\t\tconst recipients = this.email_dialog.get_values().email_id;\r\n\t\tconst doc = this.doc || frm.doc;\r\n\t\tconst print_format = frm.pos_print_format;\r\n\r\n\t\tfrappe.call({\r\n\t\t\tmethod: \"frappe.core.doctype.communication.email.make\",\r\n\t\t\targs: {\r\n\t\t\t\trecipients: recipients,\r\n\t\t\t\tsubject: __(frm.meta.name) + ': ' + doc.name,\r\n\t\t\t\tdoctype: doc.doctype,\r\n\t\t\t\tname: doc.name,\r\n\t\t\t\tsend_email: 1,\r\n\t\t\t\tprint_format,\r\n\t\t\t\tsender_full_name: frappe.user.full_name(),\r\n\t\t\t\t_lang: doc.language\r\n\t\t\t},\r\n\t\t\tcallback: r => {\r\n\t\t\t\tif (!r.exc) {\r\n\t\t\t\t\tfrappe.utils.play_sound(\"email\");\r\n\t\t\t\t\tif (r.message[\"emails_not_sent_to\"]) {\r\n\t\t\t\t\t\tfrappe.msgprint(__(\r\n\t\t\t\t\t\t\t\"Email not sent to {0} (unsubscribed / disabled)\",\r\n\t\t\t\t\t\t\t[ frappe.utils.escape_html(r.message[\"emails_not_sent_to\"]) ]\r\n\t\t\t\t\t\t));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\t\tmessage: __('Email sent successfully.'),\r\n\t\t\t\t\t\t\tindicator: 'green'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.email_dialog.hide();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfrappe.msgprint(__(\"There were errors while sending email. Please try again.\"));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tadd_summary_btns(map) {\r\n\t\tthis.$summary_btns.html('');\r\n\t\tmap.forEach(m => {\r\n\t\t\tif (m.condition) {\r\n\t\t\t\tm.visible_btns.forEach(b => {\r\n\t\t\t\t\tconst class_name = b.split(' ')[0].toLowerCase();\r\n\t\t\t\t\tthis.$summary_btns.append(\r\n\t\t\t\t\t\t`<div class=\"summary-btn btn btn-default ${class_name}-btn\">${b}</div>`\r\n\t\t\t\t\t);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.$summary_btns.children().last().removeClass('mr-4');\r\n\t}\r\n\r\n\ttoggle_summary_placeholder(show) {\r\n\t\tif (show) {\r\n\t\t\tthis.$summary_wrapper.css('display', 'none');\r\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\r\n\t\t} else {\r\n\t\t\tthis.$summary_wrapper.css('display', 'flex');\r\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'none');\r\n\t\t}\r\n\t}\r\n    make_dialog(customer,posinvoice_name){\r\n        let a  = document.getElementsByClassName(\"send-btn\")[0];\r\n        \r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n            \"doctype\": \"Selling Settings\",\r\n            \"fieldname\": [\"send_invoice_sms\",\"pos_invoice\"]\r\n            }, callback: function(r) {\r\n                console.log(r,'sdfdsf')\r\n                this.sendinvoicesms=r.message.send_invoice_sms;\r\n                this.posinvoice=r.message.pos_invoice;\r\n                \r\n                if(this.sendinvoicesms==1 && this.posinvoice==1){\r\n                    frappe.call({\r\n                        method: \"frappe.client.get_value\",\r\n                        args: {\r\n                        \"doctype\": \"Customer\",\r\n                        \"filters\": {\"name\":customer},\r\n                        \"fieldname\": \"mobile_no\"\r\n                        }, callback: function(r) {\r\n                        \r\n                        const dialog = new frappe.ui.Dialog({\r\n                            title: __('Send sms to'),\r\n                            static: true,\r\n                            fields: [\r\n                                {\r\n                                    fieldtype: 'Link', label: __('Customer'), fieldname: 'customer_name',\r\n                                    options: 'Customer', reqd: 1,default:customer,read_only:1\r\n                                },\r\n                                {\r\n                                    fieldtype: 'Int', label: __('Mobile No'),\r\n                                     fieldname: 'mobile_no', reqd: 1,default:r.message[\"mobile_no\"]\r\n                                },\r\n                              \r\n                            ],\r\n                            primary_action: async function({ customer_name,mobile_no }) {\r\n                                    \r\n                                        if(mobile_no.toString().length < 9 || mobile_no.toString().length > 10){\r\n                                            frappe.throw(\"Invalid Mobile No !!\")\r\n                                        }\r\n                                        return frappe.call({\r\n                                            method: \"ecs_vim.sms.send_sms.send_invoice_sms\",\r\n                                            args: {\r\n                                                'mobile_no': mobile_no,\r\n                                                'name': posinvoice_name,\r\n                                                'type':'POS'\r\n                                            },\r\n                                            callback(res) {\r\n                                                a.disabled=true;\r\n                                                dialog.hide();\r\n                                            }\r\n                                        });\r\n                              \r\n                            },\r\n                            primary_action_label: __('Submit')\r\n                        });\r\n                      \r\n                        }});\r\n                }\r\n                else{\r\n                    a.disabled=true;\r\n                }\r\n            }\r\n            })\r\n      \r\n       \r\n    }\r\n\tget_condition_btn_map(after_submission) {\r\n\t\tif (after_submission)\r\n\t\t\treturn [{ condition: true, visible_btns: ['Print Receipt', 'Email Receipt','Issue RFID', 'New Order','Send SMS'] }];\r\n\r\n\t\treturn [\r\n\t\t\t{ condition: this.doc.docstatus === 0, visible_btns: ['Edit Order', 'Delete Order'] },\r\n\t\t\t{ condition: !this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt','Issue RFID', 'Return']},\r\n\t\t\t{ condition: this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt']}\r\n\t\t];\r\n\t}\r\n\r\n\tload_summary_of(doc, after_submission=false) {\r\n\t\tafter_submission ?\r\n\t\t\tthis.$component.css('grid-column', 'span 10 / span 10') :\r\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\r\n\r\n\t\tthis.toggle_summary_placeholder(false);\r\n\r\n\t\tthis.doc = doc;\r\n\r\n\t\tthis.attach_document_info(doc);\r\n\r\n\t\tthis.attach_items_info(doc);\r\n\r\n\t\tthis.attach_totals_info(doc);\r\n\r\n\t\tthis.attach_payments_info(doc);\r\n\r\n\t\tconst condition_btns_map = this.get_condition_btn_map(after_submission);\r\n\r\n\t\tthis.add_summary_btns(condition_btns_map);\r\n        //this.print_receipt();\r\n        \r\n\t}\r\n\r\n\tattach_document_info(doc) {\r\n\t\tfrappe.db.get_value('Customer', this.doc.customer, 'email_id').then(({ message }) => {\r\n\t\t\tthis.customer_email = message.email_id || '';\r\n\t\t\tconst upper_section_dom = this.get_upper_section_html(doc);\r\n\t\t\tthis.$upper_section.html(upper_section_dom);\r\n\t\t});\r\n\t}\r\n\r\n\tattach_items_info(doc) {\r\n\t\tthis.$items_container.html('');\r\n\t\tdoc.items.forEach(item => {\r\n\t\t\tconst item_dom = this.get_item_html(doc, item);\r\n\t\t\tthis.$items_container.append(item_dom);\r\n\t\t\tthis.set_dynamic_rate_header_width();\r\n\t\t});\r\n\t}\r\n\r\n\tset_dynamic_rate_header_width() {\r\n\t\tconst rate_cols = Array.from(this.$items_container.find(\".item-rate-disc\"));\r\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", \"\");\r\n\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\r\n\t\t\tif ($(elm).width() > max_width)\r\n\t\t\t\tmax_width = $(elm).width();\r\n\t\t\treturn max_width;\r\n\t\t}, 0);\r\n\r\n\t\tmax_width += 1;\r\n\t\tif (max_width == 1) max_width = \"\";\r\n\r\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", max_width);\r\n\t}\r\n\r\n\tattach_payments_info(doc) {\r\n\t\tthis.$payment_container.html('');\r\n\t\tdoc.payments.forEach(p => {\r\n\t\t\tif (p.amount) {\r\n\t\t\t\tconst payment_dom = this.get_payment_html(doc, p);\r\n\t\t\t\tthis.$payment_container.append(payment_dom);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (doc.redeem_loyalty_points && doc.loyalty_amount) {\r\n\t\t\tconst payment_dom = this.get_payment_html(doc, {\r\n\t\t\t\tmode_of_payment: 'Loyalty Points',\r\n\t\t\t\tamount: doc.loyalty_amount,\r\n\t\t\t});\r\n\t\t\tthis.$payment_container.append(payment_dom);\r\n\t\t}\r\n\t}\r\n\r\n\tattach_totals_info(doc) {\r\n\t\tthis.$totals_container.html('');\r\n\r\n\t\tconst net_total_dom = this.get_net_total_html(doc);\r\n\t\tconst taxes_dom = this.get_taxes_html(doc);\r\n\t\tconst discount_dom = this.get_discount_html(doc);\r\n\t\tconst grand_total_dom = this.get_grand_total_html(doc);\r\n\t\tthis.$totals_container.append(net_total_dom);\r\n\t\tthis.$totals_container.append(taxes_dom);\r\n\t\tthis.$totals_container.append(discount_dom);\r\n\t\tthis.$totals_container.append(grand_total_dom);\r\n\t}\r\n\r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\r\n\t}\r\n};","erpnext.PointOfSale.Controller = class {\r\n\tconstructor(wrapper) {\r\n\t\tthis.wrapper = $(wrapper).find('.layout-main-section');\r\n\t\tthis.page = wrapper.page;\r\n\t\tthis.check_opening_entry();\r\n        this.hide_header();\r\n\r\n\t}\r\n\t//added by shiby\r\n    hide_header()\r\n    {\r\n        $('.sticky-top').css('display', 'none');\r\n        $('.page-head').css('position', 'unset');\r\n        $('.page-head .page-head-content').css('height', '25px');\r\n\t\t$('.layout-main-section-wrapper').css('margin-bottom', '10px');\r\n      \r\n\t\t//this.$sticky-top = this.$component.find('.sticky-top');\r\n        // console.log(this.wrapper.find('.sticky-top'),\"this.wrapper.find\",this.$component)\r\n        // this.wrapper.find('.sticky-top').css('display', 'none');\r\n        // this.wrapper.find('.page-head').css('position','unset')\r\n        //this.$component.css('display', 'none');\r\n    }\r\n\tshow_header()\r\n    {\r\n\t\t$('.sticky-top').css('display', 'flex');\r\n        $('.page-head').css('position', 'sticky');\r\n        $('.page-head .page-head-content').css('height', 'var(--page-head-height)');\r\n\t\t$('.layout-main-section-wrapper').css('margin-bottom', '10px');\r\n    }\r\n\tfetch_opening_entry() {\r\n\t\treturn frappe.call(\"erpnext.selling.page.point_of_sale.point_of_sale.check_opening_entry\", { \"user\": frappe.session.user });\r\n\t}\r\n\r\n\tcheck_opening_entry() {\r\n\t\tthis.fetch_opening_entry().then((r) => {\r\n\t\t\tif (r.message.length) {\r\n\t\t\t\t// assuming only one opening voucher is available for the current user\r\n\t\t\t\tthis.prepare_app_defaults(r.message[0]);\r\n\t\t\t} else {\r\n\t\t\t\tthis.create_opening_voucher();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n    create_closing_voucher(){\r\n        const me = this;\r\n\t\t\r\n\t\tconst table_fields = [\r\n\t\t\t{\r\n\t\t\t\tfieldname: \"mode_of_payment\", fieldtype: \"Link\",\r\n\t\t\t\tin_list_view: 1, label: \"Mode of Payment\",\r\n\t\t\t\toptions: \"Mode of Payment\",\t\t\t\t\r\n\t\t\t\t filters: {\r\n\t\t\t\t\t\"type\":[ \"=\", 'Cash']\r\n\t\t\t\t},\r\n\t\t\t\treqd: 1,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tfieldname: \"closing_amount\", fieldtype: \"Currency\",\r\n\t\t\t\tin_list_view: 1, label: \"Closing Amount\",\r\n\t\t\t\toptions: \"company:company_currency\",\r\n                change: function () {\r\n\t\t\t\t\tdialog.fields_dict.closing_details.df.data.some(d => {\r\n\t\t\t\t\t\tif (d.idx == this.doc.idx) {\r\n\t\t\t\t\t\t\td.closing_amount = this.value;\r\n\t\t\t\t\t\t\tdialog.fields_dict.closing_details.grid.refresh();\r\n                            dialog.fields_dict.closing_details.grid.wrapper.find('.grid-add-row').hide();\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t];\r\n        const fetch_pos_close_payment_methods = () => {\r\n\t\t\tconst pos_profile = cur_frm.doc.pos_profile;\r\n\t\t\tif (!pos_profile) return;\r\n\t\t\tfrappe.db.get_doc(\"POS Profile\", pos_profile).then(({ payments }) => {\r\n\t\t\t\tdialog.fields_dict.closing_details.df.data = [];\r\n\t\t\t\tpayments.forEach(pay => {\r\n\t\t\t\t\t\tconst { mode_of_payment } = pay;\r\n\t\t\t\t\t\tfrappe.db.get_value('Mode of Payment', mode_of_payment, 'type').then(({ message }) => {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(String(message.type)=='Cash'){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tdialog.fields_dict.closing_details.df.data.push(\r\n\t\t\t\t\t\t\t\t\t{ mode_of_payment, closing_amount: '0' });\r\n\t\t\t\t\t\t\t\t\tdialog.fields_dict.closing_details.grid.refresh();\r\n                                    dialog.fields_dict.closing_details.grid.wrapper.find('.grid-add-row').hide();\r\n                                    \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\tdialog.fields_dict.closing_details.grid.refresh();\r\n                dialog.fields_dict.closing_details.grid.wrapper.find('.grid-add-row').hide();\r\n\t\t\t});\r\n\t\t}\r\n        const dialog = new frappe.ui.Dialog({\r\n\t\t\ttitle: __('Create POS Closing Entry'),\r\n\t\t\tstatic: true,\r\n\t\t\tfields: [\r\n\t\t\t\t\r\n\t\t\t\t{\r\n\t\t\t\t\tfieldname: \"closing_details\",\r\n\t\t\t\t\tfieldtype: \"Table\",\r\n\t\t\t\t\tlabel: \"Closing Details\",\r\n\t\t\t\t\tcannot_add_rows: false,\r\n\t\t\t\t\tin_place_edit: true,\r\n\t\t\t\t\treqd: 1,\r\n\t\t\t\t\tdata: [],\r\n\t\t\t\t\tfields: table_fields\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\tprimary_action: async function({ company, pos_profile, closing_details }) {\r\n\t\t\t\tif (!closing_details.length) {\r\n\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\tmessage: __(\"Please add Mode of payments and closing details.\"),\r\n\t\t\t\t\t\tindicator: 'red'\r\n\t\t\t\t\t})\r\n\t\t\t\t\treturn frappe.utils.play_sound(\"error\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// filter balance details for empty rows\r\n\t\t\t\tclosing_details = closing_details.filter(d => d.mode_of_payment);\r\n\t\t\t\t\r\n\t\t\t\tlet voucher = frappe.model.get_new_doc('POS Closing Entry');\r\n\t\t\t\tvoucher.pos_profile = me.frm.doc.pos_profile;\r\n\t\t\t\tvoucher.user = frappe.session.user;\r\n\t\t\t\tvoucher.company = me.frm.doc.company;\r\n\t\t\t\tvoucher.pos_opening_entry = me.pos_opening;\r\n\t\t\t\tvoucher.cash_closing_amont=closing_details[0].closing_amount\r\n\t\t\t\tvoucher.period_end_date = frappe.datetime.now_datetime();\r\n\t\t\t\tvoucher.posting_date = frappe.datetime.now_date();\r\n\t\t\t\t\r\n\t\t\t\tfrappe.set_route('Form', 'POS Closing Entry', voucher.name);\r\n\r\n\t\t\t\t// const method = \"erpnext.selling.page.point_of_sale.point_of_sale.create_closing_voucher\";\r\n\t\t\t\t// const res = await frappe.call({ method, args: { pos_profile, company, closing_details }, freeze:true });\r\n\t\t\t\t\r\n\t\t\t\tdialog.hide();\r\n\t\t\t\t\r\n\t\t\t},\r\n\t\t\tprimary_action_label: __('Submit')\r\n\t\t});\r\n\t\tfetch_pos_close_payment_methods();\r\n\t\tdialog.show();\r\n\t\tthis.show_header();\r\n    }\r\n   \r\n\tcreate_opening_voucher() {\r\n\t\tconst me = this;\r\n\t\tconst table_fields = [\r\n\t\t\t{\r\n\t\t\t\tfieldname: \"mode_of_payment\", fieldtype: \"Link\",\r\n\t\t\t\tin_list_view: 1, label: \"Mode of Payment\",\r\n\t\t\t\toptions: \"Mode of Payment\",\t\t\t\t\r\n\t\t\t\t filters: {\r\n\t\t\t\t\t\"type\":[ \"=\", 'Cash']\r\n\t\t\t\t},\r\n\t\t\t\treqd: 1,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tfieldname: \"opening_amount\", fieldtype: \"Currency\",\r\n\t\t\t\tin_list_view: 1, label: \"Opening Amount\",\r\n\t\t\t\toptions: \"company:company_currency\",\r\n\t\t\t\tchange: function () {\r\n\t\t\t\t\tdialog.fields_dict.balance_details.df.data.some(d => {\r\n\t\t\t\t\t\tif (d.idx == this.doc.idx) {\r\n\t\t\t\t\t\t\td.opening_amount = this.value;\r\n\t\t\t\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\r\n                            dialog.fields_dict.balance_details.grid.wrapper.find('.grid-add-row').hide();\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t];\r\n\t\tconst fetch_pos_payment_methods = () => {\r\n\t\t\tconst pos_profile = dialog.fields_dict.pos_profile.get_value();\r\n\t\t\tif (!pos_profile) return;\r\n\t\t\tfrappe.db.get_doc(\"POS Profile\", pos_profile).then(({ payments }) => {\r\n\t\t\t\tdialog.fields_dict.balance_details.df.data = [];\r\n\t\t\t\tpayments.forEach(pay => {\r\n\t\t\t\t\t\tconst { mode_of_payment } = pay;\r\n\t\t\t\t\t\tfrappe.db.get_value('Mode of Payment', mode_of_payment, 'type').then(({ message }) => {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(String(message.type)=='Cash'){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tdialog.fields_dict.balance_details.df.data.push(\r\n\t\t\t\t\t\t\t\t\t{ mode_of_payment, opening_amount: '0' });\r\n\t\t\t\t\t\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\r\n                                    dialog.fields_dict.balance_details.grid.wrapper.find('.grid-add-row').hide();\r\n                                    \r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\r\n                dialog.fields_dict.balance_details.grid.wrapper.find('.grid-add-row').hide();\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst dialog = new frappe.ui.Dialog({\r\n\t\t\ttitle: __('Create POS Opening Entry'),\r\n\t\t\tstatic: true,\r\n\t\t\tfields: [\r\n\t\t\t\t{\r\n\t\t\t\t\tfieldtype: 'Link', label: __('Company'), default: frappe.defaults.get_default('company'),\r\n\t\t\t\t\toptions: 'Company', fieldname: 'company', reqd: 1\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tfieldtype: 'Link', label: __('POS Profile'),\r\n\t\t\t\t\toptions: 'POS Profile', fieldname: 'pos_profile', reqd: 1,\r\n\t\t\t\t\tget_query: () => pos_profile_query,\r\n\t\t\t\t\tonchange: () => fetch_pos_payment_methods()\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tfieldname: \"balance_details\",\r\n\t\t\t\t\tfieldtype: \"Table\",\r\n\t\t\t\t\tlabel: \"Opening Balance Details\",\r\n\t\t\t\t\tcannot_add_rows: false,\r\n\t\t\t\t\tin_place_edit: true,\r\n\t\t\t\t\treqd: 1,\r\n\t\t\t\t\tdata: [],\r\n\t\t\t\t\tfields: table_fields\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\tprimary_action: async function({ company, pos_profile, balance_details }) {\r\n\t\t\t\tif (!balance_details.length) {\r\n\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\tmessage: __(\"Please add Mode of payments and opening balance details.\"),\r\n\t\t\t\t\t\tindicator: 'red'\r\n\t\t\t\t\t})\r\n\t\t\t\t\treturn frappe.utils.play_sound(\"error\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// filter balance details for empty rows\r\n\t\t\t\tbalance_details = balance_details.filter(d => d.mode_of_payment);\r\n\r\n\t\t\t\tconst method = \"erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher\";\r\n\t\t\t\tconst res = await frappe.call({ method, args: { pos_profile, company, balance_details }, freeze:true });\r\n\t\t\t\t!res.exc && me.prepare_app_defaults(res.message);\r\n\t\t\t\tdialog.hide();\r\n\t\t\t},\r\n\t\t\tprimary_action_label: __('Submit')\r\n\t\t});\r\n\t\tdialog.show();\r\n\t\tconst pos_profile_query = {\r\n\t\t\tquery: 'erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query',\r\n\t\t\tfilters: { company: dialog.fields_dict.company.get_value() }\r\n\t\t};\r\n\t}\r\n\r\n\tasync prepare_app_defaults(data) {\r\n\t\tthis.pos_opening = data.name;\r\n\t\tthis.company = data.company;\r\n\t\tthis.pos_profile = data.pos_profile;\r\n\t\tthis.pos_opening_time = data.period_start_date;\r\n\t\tthis.item_stock_map = {};\r\n\t\tthis.settings = {};\r\n\r\n\t\tfrappe.db.get_value('Stock Settings', undefined, 'allow_negative_stock').then(({ message }) => {\r\n\t\t\tthis.allow_negative_stock = flt(message.allow_negative_stock) || false;\r\n\t\t});\r\n\r\n\t\tfrappe.db.get_doc(\"POS Profile\", this.pos_profile).then((profile) => {\r\n\t\t\tObject.assign(this.settings, profile);\r\n\t\t\tthis.settings.customer_groups = profile.customer_groups.map(group => group.customer_group);\r\n\t\t\tthis.make_app();\r\n\t\t});\r\n\t}\r\n\r\n\tset_opening_entry_status() {\r\n\t\tthis.page.set_title_sub(\r\n\t\t\t`<span class=\"indicator orange\">\r\n\t\t\t\t<a class=\"text-muted\" href=\"#Form/POS%20Opening%20Entry/${this.pos_opening}\">\r\n\t\t\t\t\tOpened at ${moment(this.pos_opening_time).format(\"Do MMMM, h:mma\")}\r\n\t\t\t\t</a>\r\n\t\t\t</span>`);\r\n\t}\r\n\r\n\tmake_app() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.prepare_components();\r\n\t\tthis.prepare_menu();\r\n\t\tthis.make_new_invoice();\r\n        this.hide_header();\r\n\t\r\n        \r\n\t}\r\n\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<div class=\"point-of-sale-app\">\r\n            </div>`\r\n\t\t);\r\n       \r\n\t\tthis.$components_wrapper = this.wrapper.find('.point-of-sale-app');\r\n        $('.point-of-sale-app section').css('min-height','35rem')\t\r\n       \r\n\t}\r\n\r\n\tprepare_components() {\r\n\t\tthis.init_item_selector();\r\n\t\tthis.init_item_details();\r\n\t\tthis.init_item_cart();\r\n\t\tthis.init_payments();\r\n\t\tthis.init_recent_order_list();\r\n\t\tthis.init_order_summary();\r\n        this.init_combo_item_details();\r\n\t}\r\n\r\n\tprepare_menu() {\r\n\t\tthis.page.clear_menu();\r\n        this.page.add_menu_item(__(\"Home\"), this.open_home.bind(this), false, 'Ctrl+');\r\n\r\n\t\tthis.page.add_menu_item(__(\"Open Form View\"), this.open_form_view.bind(this), false, 'Ctrl+F');\r\n\r\n\t\tthis.page.add_menu_item(__(\"Toggle Recent Orders\"), this.toggle_recent_order.bind(this), false, 'Ctrl+O');\r\n\r\n\t\tthis.page.add_menu_item(__(\"Save as Draft\"), this.save_draft_invoice.bind(this), false, 'Ctrl+S');\r\n\r\n\t\tthis.page.add_menu_item(__('Close the POS'), this.close_pos.bind(this), false, 'Shift+Ctrl+C');\r\n        this.page.add_menu_item(__('Approve Discount'), this.validate_approver.bind(this), false, 'Shift+Ctrl+D');\r\n        this.page.add_menu_item(__('Issue RFID'), this.issue_rfid.bind(this), false, 'Ctrl+R');\r\n\t\r\n\t}\r\n\r\n    open_home(){\r\n        frappe.set_route('Form', 'Home');\r\n\t\tthis.show_header();\r\n    }\r\n\topen_form_view() {\r\n\t\tfrappe.model.sync(this.frm.doc);\r\n\t\tfrappe.set_route(\"Form\", this.frm.doc.doctype, this.frm.doc.name);\r\n\t}\r\n\r\n\ttoggle_recent_order() {\r\n\t\tconst show = this.recent_order_list.$component.is(':hidden');\r\n\t\tthis.toggle_recent_order_list(show);\r\n\t}\r\n\r\n\tsave_draft_invoice() {\r\n\t\t\r\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\r\n\r\n\t\tif (this.frm.doc.items.length == 0) {\r\n\t\t\tfrappe.show_alert({\r\n\t\t\t\tmessage: __(\"You must add atleast one item to save it as draft.\"),\r\n\t\t\t\tindicator:'red'\r\n\t\t\t});\r\n\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\treturn;\r\n\t\t}\r\n      \r\n\t\tthis.frm.save(undefined, undefined, undefined, () => {\r\n\t\t\tfrappe.show_alert({\r\n\t\t\t\tmessage: __(\"There was an error saving the document.\"),\r\n\t\t\t\tindicator: 'red'\r\n\t\t\t});\r\n\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t}).then(() => {\r\n\t\t\tfrappe.run_serially([\r\n\t\t\t\t() => frappe.dom.freeze(),\r\n\t\t\t\t() => this.make_new_invoice(),\t\t\t\t\r\n\t\t\t\t() => frappe.dom.unfreeze(),\r\n\t\t\t]);\r\n\t\t\tthis.update_POS()\r\n\t\t});\r\n\t}\r\n    issue_rfid(){\r\n        \r\n        let voucher = frappe.model.get_new_doc('Customer RFID');\r\n\t\tvoucher.pos_invoice = this.frm.doc.name;\t        \r\n        frappe.set_route('Form', 'Customer RFID', voucher.name);\r\n        this.show_header();\r\n\r\n    }\r\n\tclose_pos() {\r\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\r\n\r\n\t\t// let voucher = frappe.model.get_new_doc('POS Closing Entry');\r\n\t\t// voucher.pos_profile = this.frm.doc.pos_profile;\r\n\t\t// voucher.user = frappe.session.user;\r\n\t\t// voucher.company = this.frm.doc.company;\r\n\t\t// voucher.pos_opening_entry = this.pos_opening;\r\n\t\t// voucher.period_end_date = frappe.datetime.now_datetime();\r\n\t\t// voucher.posting_date = frappe.datetime.now_date();\r\n\t\t//frappe.set_route('Form', 'POS Closing Entry', voucher.name);\r\n        this.create_closing_voucher()\r\n\t}\r\n    async update_discount_approval(discount, remarks) {\r\n        // const frm = this.events.get_frm();\r\n        // frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', flt(discount));\r\n\t\t// frappe.model.set_value(frm.doc.doctype, frm.doc.name, 'discount_remark',String(remarks));\r\n        // this.discount_field.set_value(flt(cur_frm.doc.additional_discount_percentage));\r\n\t\t// this.disremark=cur_frm.doc.discount_remark\r\n        cur_pos.cart.update_discount(remarks,discount)\r\n\t\tcur_pos.cart.hide_discount_control(discount,remarks);\r\n        \r\n                       \r\n    }\r\n    validate_approver(){\r\n        const me = this;\r\n\t\tconst dialog = new frappe.ui.Dialog({\r\n            title: __('Approve Discount'),\r\n              fields: [\r\n                  {fieldtype: \"Section Break\"},\r\n                  {fieldtype: 'Data', label: __('User'), fieldname: 'appuser',reqd:1\r\n                    \t\t},\r\n                  {fieldtype: 'Password', label: __('Password'), fieldname: 'apppassword',reqd:1\r\n                       },\r\n                \r\n                ],\r\n                primary_action: async function({ appuser, apppassword}) {\r\n                    if (!appuser) {\r\n                        frappe.show_alert({\r\n                            message: __(\"Please enter user name & password.\"),\r\n                            indicator: 'red'\r\n                        })\r\n                        return frappe.utils.play_sound(\"error\");\r\n                    }\r\n                   \r\n                    const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.validate_user_permission\";\r\n\t\t\t\t    const res = await frappe.call({ method, args: { appuser, apppassword }, freeze:true });\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(res.message==1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tme.approve_discount(appuser);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tfrappe.show_alert({\r\n                            message: __(\"No Permission.\"),\r\n                            indicator: 'red'\r\n                        })\r\n\t\t\t\t\t}\r\n\t\t\t\t    \r\n                    \r\n                    dialog.hide();\r\n                },\r\n                primary_action_label: __('Login')\r\n\t\t        });\r\n    \r\n    dialog.show()\r\n    dialog.$wrapper.find('.modal-dialog').css(\"width\", \"400px\");\r\n    \r\n       \r\n    }\r\n    approve_discount(){\r\n        const me = this;\r\n\t\tconst dialog = new frappe.ui.Dialog({\r\n            title: __('Approve Discount'),\r\n              fields: [\r\n                  {fieldtype: \"Section Break\"},\r\n                  {fieldtype: 'Float', label: __('Discount'), default: cur_frm.doc.additional_discount_percentage,\r\n                    \t\t\t fieldname: 'discount'\r\n                    \t\t},\r\n                  {fieldtype: 'Data', label: __('Remarks'), default: cur_frm.doc.discount_remark,\r\n                            fieldname: 'remarks'\r\n                       },\r\n                \r\n                ],\r\n                primary_action: async function({ discount, remarks }) {\r\n                    \r\n                    me.update_discount_approval(discount, remarks);\r\n                    dialog.hide();\r\n                },\r\n                primary_action_label: __('Submit')\r\n\t\t        });\r\n    \r\n    dialog.show()\r\n    dialog.$wrapper.find('.modal-dialog').css(\"width\", \"400px\");\r\n    dialog.$wrapper.find('.modal-dialog').css(\"height\", \"300px\");\r\n       \r\n    }\r\n\tinit_item_selector() {\r\n\t\tthis.item_selector = new erpnext.PointOfSale.ItemSelector({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tpos_profile: this.pos_profile,\r\n\t\t\tsettings: this.settings,\r\n\t\t\tevents: {\r\n\t\t\t\titem_selected: args => this.on_cart_update(args),\r\n\t\t\t\tbundle_item_selected: args => this.on_bundle_cart_update(args),\r\n\r\n\t\t\t\tget_frm: () => this.frm || {}\r\n\t\t\t}\r\n\t\t})\r\n        // this.frm.add_custom_button(__('Get User Email Address'), function(){\r\n        //     frappe.msgprint(frm.doc.name);\r\n        // });\r\n\t}\r\n\r\n\tinit_item_cart() {\r\n\t\tthis.cart = new erpnext.PointOfSale.ItemCart({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tsettings: this.settings,\r\n\t\t\tevents: {\r\n\t\t\t\t//added by shiby\r\n                item_selected: args => this.on_cart_update(args),\r\n                //item_selected: args => this.on_cart_update_uom(args),\r\n\t\t\t\titem_selected_desc: args => this.on_cart_update_desc(args),\r\n                so_item_selected: args => this.on_cart_update_from_so(args),\r\n                //\r\n\t\t\t\tget_frm: () => this.frm,\r\n\r\n\t\t\t\tcart_item_clicked: (item_code, batch_no, uom,rate) => {\r\n\t\t\t\t\tconst search_field = batch_no ? 'batch_no' : 'item_code';\r\n\t\t\t\t\tconst search_value = batch_no || item_code;\r\n\t\t\t\t\tconst item_row = this.frm.doc.items.find(i => i[search_field] === search_value && i.uom === uom && i.rate ===parseFloat(rate));\r\n\t\t\t\t\tconsole.log(this.frm.doc.items,parseFloat(rate))\r\n                    if(!item_row.is_free_item) {\r\n\t\t\t\t\tthis.item_details.toggle_item_details_section(item_row);\r\n                    }\r\n                    \r\n\t\t\t\t},\r\n                cart_combo_item_clicked: (item_code, batch_no, uom,rate,args) => {\r\n\t\t\t\t\tconst search_field = batch_no ? 'batch_no' : 'item_code';\r\n\t\t\t\t\tconst search_value = batch_no || item_code;\r\n\t\t\t\t\tconst item_row = this.frm.doc.items.find(i => i[search_field] === search_value && i.uom === uom && i.rate ===parseFloat(rate));\r\n\t\t\t\t\tconsole.log(item_row,\"AAAAAAAAAAA\")\r\n                    if(item_row && !item_row.is_free_item) {\r\n                        cur_pos.combo_item_details.combo_items = [];\r\n\t\t            cur_pos.combo_item_details.combo_default_items = [];                    \r\n                    cur_pos.combo_item_details.total_packed_qty=item_row.qty;\r\n\t\t\t\t\tcur_frm.doc.seleceted_packed_items.forEach(item => {\r\n\t\t\t\t\t\tvar current_item={} \r\n                        if(item_code==item.parent_item){\r\n                            current_item.parent_item = item.parent_item\r\n\t\t\t\t\t\t    current_item.item_code = item.item_code\r\n\t\t\t\t\t\t    current_item.packed_quantity = item.packed_quantity\r\n\t\t\t\t\t\t    current_item.set_no = item.set_no\r\n\t\t\t\t\t\t    current_item.combo_qty = item.combo_qty\r\n\t\t\t\t\t\t    cur_pos.combo_item_details.combo_items.push(current_item)\r\n\r\n                        }\r\n                \t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t})\r\n                  \r\n\t\t\t\t\tthis.combo_item_details.toggle_combo_item_details_section(item_row);\r\n\r\n                    }\r\n                    else{\r\n                        this.on_cart_update(args)\r\n                    }\r\n                    \r\n\t\t\t\t},\r\n                \r\n\t\t\t\tnumpad_event: (value, action) => this.update_item_field(value, action),\r\n               \r\n                \r\n\t\t\t\tcheckout: () => this.payment.checkout(),\r\n\r\n\t\t\t\tedit_cart: () => this.payment.edit_cart(),\r\n\r\n\t\t\t\tcustomer_details_updated: (details) => {\r\n\t\t\t\t\tthis.customer_details = details;\r\n\t\t\t\t\t// will add/remove LP payment method\r\n\t\t\t\t\tthis.payment.render_loyalty_points_payment_mode();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\tinit_item_details() {\r\n\t\tthis.item_details = new erpnext.PointOfSale.ItemDetails({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tsettings: this.settings,\r\n\t\t\tevents: {\r\n\t\t\t\tget_frm: () => this.frm,\r\n\r\n\t\t\t\ttoggle_item_selector: (minimize) => {\r\n\t\t\t\t\tthis.item_selector.resize_selector(minimize);\r\n\t\t\t\t\tthis.cart.toggle_numpad(minimize);\r\n\t\t\t\t},\r\n\r\n\t\t\t\tform_updated: async (cdt, cdn, fieldname, value) => {\r\n\t\t\t\t\tconst item_row = frappe.model.get_doc(cdt, cdn);\r\n\t\t\t\t\tif (item_row && item_row[fieldname] != value) {\r\n                        \r\n\r\n\t\t\t\t\t\tconst { item_code, batch_no, uom } = this.item_details.current_item;\r\n\t\t\t\t\t\tconst event = {\r\n\t\t\t\t\t\t\tfield: fieldname,\r\n\t\t\t\t\t\t\tvalue,\r\n\t\t\t\t\t\t\titem: { item_code, batch_no, uom }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn this.on_cart_update(event)\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\titem_field_focused: (fieldname) => {\r\n\t\t\t\t\tthis.cart.toggle_numpad_field_edit(fieldname);\r\n\t\t\t\t},\r\n\t\t\t\tset_value_in_current_cart_item: (selector, value) => {\r\n\t\t\t\t\tthis.cart.update_selector_value_in_cart_item(selector, value, this.item_details.current_item);\r\n\t\t\t\t},\r\n\t\t\t\tclone_new_batch_item_in_frm: (batch_serial_map, current_item) => {\r\n\t\t\t\t\t// called if serial nos are 'auto_selected' and if those serial nos belongs to multiple batches\r\n\t\t\t\t\t// for each unique batch new item row is added in the form & cart\r\n\t\t\t\t\tObject.keys(batch_serial_map).forEach(batch => {\r\n\t\t\t\t\t\tconst { item_code, batch_no } = current_item;\r\n\t\t\t\t\t\tconst item_to_clone = this.frm.doc.items.find(i => i.item_code === item_code && i.batch_no === batch_no);\r\n\t\t\t\t\t\tconst new_row = this.frm.add_child(\"items\", { ...item_to_clone });\r\n                        \r\n\t\t\t\t\t\t// update new serialno and batch\r\n\t\t\t\t\t\tnew_row.batch_no = batch;\r\n\t\t\t\t\t\tnew_row.serial_no = batch_serial_map[batch].join(`\\n`);\r\n\t\t\t\t\t\tnew_row.qty = batch_serial_map[batch].length;\r\n\t\t\t\t\t\tthis.frm.doc.items.forEach(row => {\r\n\t\t\t\t\t\t\tif (item_code === row.item_code) {\r\n\t\t\t\t\t\t\t\tthis.update_cart_html(row);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t})\r\n\t\t\t\t},\r\n\t\t\t\tremove_item_from_cart: () => this.remove_item_from_cart(),\r\n\t\t\t\tget_item_stock_map: () => this.item_stock_map,\r\n\t\t\t\tclose_item_details: () => {\r\n                    \r\n\t\t\t\t\tthis.item_details.toggle_item_details_section(undefined);\r\n\t\t\t\t\tthis.cart.prev_action = undefined;\r\n\t\t\t\t\tthis.cart.toggle_item_highlight();\r\n\t\t\t\t},\r\n\t\t\t\tget_available_stock: (item_code, warehouse) => this.get_available_stock(item_code, warehouse)\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinit_combo_item_details() {\r\n\t\tthis.combo_item_details = new erpnext.PointOfSale.ComboItemDetails({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tsettings: this.settings,\r\n\t\t\tevents: {\r\n\t\t\t\titem_selected: args => this.on_cart_update(args),\r\n\t\t\t\tget_frm: () => this.frm,\r\n\t\t\t\ttoggle_combo_item_selector: (minimize) => {\r\n\t\t\t\t\tthis.item_selector.resize_selector(minimize);\r\n                    this.cart.toggle_checkout_btn(false);\r\n                    this.cart.$totals_section.find('.edit-cart-btn').css('display', 'none');\r\n\t\t\t\t\t//this.combo_item_details.toggle_combo_numpad(minimize);\r\n                    \r\n\t\t\t\t},\r\n\t\t\t\t\r\n\t\t\t\tremove_item_from_cart: () => this.remove_item_from_cart(),\r\n                combo_numpad_event: () => this.update_combo_item_field(),\r\n                \r\n\t\t\t\tclose_combo_item_details: () => {\t\t\t\t\t\r\n\t\t\t\t\tthis.combo_item_details.toggle_combo_item_details_section(undefined);\r\n\t\t\t\t\tthis.cart.prev_action = undefined;\r\n\t\t\t\t\tthis.cart.toggle_item_highlight();\r\n                    this.cart.toggle_checkout_btn(true);\r\n                   \r\n                    \r\n\t\t\t\t},\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinit_payments() {\r\n\t\tthis.payment = new erpnext.PointOfSale.Payment({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tevents: {\r\n\t\t\t\tget_frm: () => this.frm || {},\r\n                item_selected: args => this.on_cart_update(args),\r\n\t\t\t\tget_customer_details: () => this.customer_details || {},\r\n\r\n\t\t\t\ttoggle_other_sections: (show) => {\r\n\t\t\t\t\tif (show) {\r\n\t\t\t\t\t\tthis.item_details.$component.is(':visible') ? this.item_details.$component.css('display', 'none') : '';\r\n\t\t\t\t\t\tthis.item_selector.$component.css('display', 'none');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.item_selector.$component.css('display', 'flex');\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\tsubmit_invoice: () => {\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\tthis.update_Item();\r\n                    //console.log(this.frm,\"this.frm\")\r\n\t\t\t\t\t\tthis.frm.savesubmit()\r\n\t\t\t\t\t\t.then((r) => {\r\n\t\t\t\t\t\t\tthis.toggle_components(false);\r\n\t\t\t\t\t\t\tthis.order_summary.toggle_component(true);\r\n\t\t\t\t\t\t\tthis.order_summary.load_summary_of(this.frm.doc, true);\r\n                            frappe.show_alert({\r\n                                indicator: 'green',\r\n                                message: __('POS invoice {0} created succesfully', [r.doc.name])\r\n                            });\r\n\t\t\t\t\t\t\t//Added by shiby\r\n\t\t\t\t\t\t\t//this.create_event_booking();\r\n                    \t\tthis.update_POS();\r\n\t\t\t\t\t\t\t//this.update_POS_Item();\r\n\t\t\t\t\t\t\t//\r\n\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t// });\r\n\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\t\tindicator: 'red',\r\n\t\t\t\t\t\t\tmessage: __(error)\r\n\t\t\t\t\t\t});\r\n\t\t} finally {\r\n\t\t\t\r\n\t\t\t\r\n\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinit_recent_order_list() {\r\n\t\tthis.recent_order_list = new erpnext.PointOfSale.PastOrderList({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tevents: {\r\n\t\t\t\topen_invoice_data: (name) => {\r\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\r\n\t\t\t\t\t\tthis.order_summary.load_summary_of(doc);\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\treset_summary: () => this.order_summary.toggle_summary_placeholder(true)\r\n                ,\r\n\r\n\t\t\t\tget_frm: () => this.frm || {}\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\tinit_order_summary() {\r\n\t\tthis.order_summary = new erpnext.PointOfSale.PastOrderSummary({\r\n\t\t\twrapper: this.$components_wrapper,\r\n\t\t\tevents: {\r\n\t\t\t\tget_frm: () => this.frm,\r\n\r\n\t\t\t\tprocess_return: (name) => {\r\n                    \r\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\r\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\r\n\t\t\t\t\t\tfrappe.run_serially([\r\n\t\t\t\t\t\t\t() => this.make_return_invoice(doc),\r\n\t\t\t\t\t\t\t() => this.cart.load_invoice(),\r\n\t\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\r\n\t\t\t\t\t\t]);\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tedit_order: (name) => {\r\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\r\n\t\t\t\t\tfrappe.run_serially([\r\n\t\t\t\t\t\t() => this.frm.refresh(name),\r\n\t\t\t\t\t\t() => this.frm.call('reset_mode_of_payments'),\r\n\t\t\t\t\t\t() => this.cart.load_invoice(),\r\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\r\n\t\t\t\t\t]);\r\n\t\t\t\t},\r\n\t\t\t\tdelete_order: (name) => {\r\n\t\t\t\t\tfrappe.model.delete_doc(this.frm.doc.doctype, name, () => {\r\n\t\t\t\t\t\tthis.recent_order_list.refresh_list();\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tnew_order: () => {\r\n\t\t\t\t\tfrappe.run_serially([\r\n\t\t\t\t\t\t() => frappe.dom.freeze(),\r\n\t\t\t\t\t\t() => this.make_new_invoice(),\r\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true),\t\t\t\t\t\t\r\n\t\t\t\t\t\t() => frappe.dom.unfreeze(),\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\ttoggle_recent_order_list(show) {\r\n\t\tthis.toggle_components(!show);\r\n\t\tthis.recent_order_list.toggle_component(show);\r\n\t\tthis.order_summary.toggle_component(show);\r\n\t}\r\n\r\n\ttoggle_components(show) {\r\n\t\tthis.cart.toggle_component(show);\r\n\t\tthis.item_selector.toggle_component(show);\r\n\r\n\t\t// do not show item details or payment if recent order is toggled off\r\n\t\t!show ? (this.item_details.toggle_component(false) || this.payment.toggle_component(false)) : '';\r\n\t}\r\n\r\n\tmake_new_invoice() {\r\n\t\t\r\n\t\treturn frappe.run_serially([\r\n\t\t\t() => frappe.dom.freeze(),\r\n\t\t\t() => this.make_sales_invoice_frm(),\r\n\t\t\t() => this.set_pos_profile_data(),\r\n\t\t\t() => this.set_pos_profile_status(),\r\n\t\t\t() => this.cart.load_invoice(),\r\n\t\t\t() => frappe.dom.unfreeze()\r\n\t\t]);\r\n\t}\r\n\r\n\tmake_sales_invoice_frm() {\r\n\t\tconst doctype = 'POS Invoice';\r\n       \r\n\t\treturn new Promise(resolve => {\r\n\t\t\tif (this.frm) {\r\n\t\t\t\tthis.frm = this.get_new_frm(this.frm);\r\n                \r\n\t\t\t\tthis.frm.doc.items = [];\r\n\t\t\t\tthis.frm.doc.is_pos = 1\r\n\t\t\t\tresolve();\r\n\t\t\t} else {\r\n\t\t\t\tfrappe.model.with_doctype(doctype, () => {\r\n\t\t\t\t\tthis.frm = this.get_new_frm();\r\n\t\t\t\t\tthis.frm.doc.items = [];\r\n\t\t\t\t\tthis.frm.doc.is_pos = 1\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tget_new_frm(_frm) {\r\n\t\tconst doctype = 'POS Invoice';\r\n\t\tconst page = $('<div>');\r\n\t\tconst frm = _frm || new frappe.ui.form.Form(doctype, page, false);\r\n\t\tconst name = frappe.model.make_new_doc_and_get_name(doctype, true);\r\n\t\tfrm.refresh(name);\r\n\r\n\t\treturn frm;\r\n\t}\r\n\r\n\tasync make_return_invoice(doc) {\r\n\t\tfrappe.dom.freeze();\r\n\t\tthis.frm = this.get_new_frm(this.frm);\r\n\t\tthis.frm.doc.items = [];\r\n\t\tconst res = await frappe.call({\r\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return\",\r\n\t\t\targs: {\r\n\t\t\t\t'source_name': doc.name,\r\n\t\t\t\t'target_doc': this.frm.doc\r\n\t\t\t}\r\n\t\t});\r\n\t\tfrappe.model.sync(res.message);\r\n\t\tawait this.set_pos_profile_data();\r\n\t\tfrappe.dom.unfreeze();\r\n\t}\r\n\r\n\tset_pos_profile_data() {\r\n\t\tif (this.company && !this.frm.doc.company) this.frm.doc.company = this.company;\r\n\t\tif (this.pos_profile && !this.frm.doc.pos_profile) this.frm.doc.pos_profile = this.pos_profile;\r\n\t\tif (!this.frm.doc.company) return;\r\n\r\n\t\treturn this.frm.trigger(\"set_pos_data\");\r\n\t}\r\n\r\n\tset_pos_profile_status() {             \r\n\t\tthis.page.set_indicator(this.pos_profile, \"blue\");\r\n\t}\r\n    async on_cart_update_from_so(args) {\r\n       \r\n\t\tfrappe.dom.freeze();\r\n\t\tlet item_row = undefined;\r\n\t\ttry {\r\n\t\t\tlet { field, value, item } = args;\r\n\t\t\t\r\n\t\t\tconst { item_code, batch_no, serial_no, stock_uom,rate,conversion_factor,uom } = item;\r\n            \r\n\t\t\titem_row = this.get_item_from_frm(item_code, batch_no, uom);\r\n\t\t\tconst item_selected_from_selector = field === 'qty' && value === \"+1\"\r\n            \r\n\t\t\tif (item_row ) {\r\n\t\t\t\t\r\n\t\t\t\titem_selected_from_selector && (value = item_row.qty + flt(value))\r\n\t\t\t\t\r\n\t\t\t\tfield === 'qty' && (value = flt(value));\r\n\r\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\r\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || item_selected_from_selector) {\r\n\t\t\t\t\t\r\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\r\n\t\t\t\t\tthis.update_cart_html(item_row);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\t\t\t\tif (!this.frm.doc.customer) {\r\n\t\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\tmessage: __('You must select a customer before adding an item.'),\r\n\t\t\t\t\t\tindicator: 'orange'\r\n\t\t\t\t\t});\r\n\t\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (!item_code) return;\r\n\r\n\t\t\t\titem_selected_from_selector && (value = flt(value))\r\n\t\t\t\tconst args = { item_code, batch_no,uom,stock_uom,rate,conversion_factor, [field]: value };\r\n\r\n\t\t\t\tif (serial_no) {\r\n\t\t\t\t\tawait this.check_serial_no_availablilty(item_code, this.frm.doc.set_warehouse, serial_no);\r\n\t\t\t\t\targs['serial_no'] = serial_no;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (field === 'serial_no') args['qty'] = value.split(`\\n`).length || 0;\r\n               \r\n\t\t\t\titem_row = this.frm.add_child('items',args);   \r\n\r\n\t\t\t\tif (field === 'qty' && value !== 0 && !this.allow_negative_stock)\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, value, this.frm.doc.set_warehouse);\r\n                await this.trigger_new_item_events_so(item_row,rate,uom);\r\n\t\t\t\tthis.check_serial_batch_selection_needed(item_row) && this.edit_item_details_of(item_row);\r\n\t\t\t\t//this.update_cart_html(item_row);\r\n              \r\n                if(uom!=item_row.uom)\r\n                {\r\n\t\t\t\t\t\r\n                    var current_item={};\r\n                    const search_field = batch_no ? 'batch_no' : 'item_code';\r\n\t\t\t\t\tconst search_value = batch_no || item_code;\r\n\t\t\t\t\tconst item_rowedit = this.frm.doc.items.find(i => i[search_field] === search_value && i.uom === item_row.uom);\r\n\t\t\t\t\t\r\n                    current_item.item_code = item_code\r\n\t\t\t        current_item.batch_no = batch_no;\r\n\t\t\t        current_item.uom = uom\r\n                    current_item.sales_order = cur_pos.cart.location_so_field.value\r\n\t\t\t       \r\n                   \t \r\n                        cur_pos.item_details.current_item=current_item;\r\n                        \r\n                        //await cur_pos.cart.events.cart_item_clicked(item_code, batch_no, item_row.uom);\r\n                    // this.item_details.toggle_item_details_section(item_rowedit);\r\n                    // this.update_item_field(uom,'uom')\r\n                    // this.update_item_field(conversion_factor,'conversion_factor')\r\n\t\t\t        await frappe.model.set_value(item_row.doctype, item_row.name, 'stock_uom', uom);\r\n                    await frappe.model.set_value(item_row.doctype, item_row.name, 'sales_order', cur_pos.cart.location_so_field.value);\r\n                    await frappe.model.set_value(item_row.doctype, item_row.name, 'uom', uom);\r\n                    await frappe.model.set_value(item_row.doctype, item_row.name, 'conversion_factor', (conversion_factor));\r\n                    await frappe.model.set_value(item_row.doctype, item_row.name, 'rate', rate);\r\n                    // console.log(item_row.item_code,frappe.model.get_value(item_row.doctype, item_row.name, 'uom'),\r\n                    // frappe.model.get_value(item_row.doctype, item_row.name, 'rate'),\"testing\")\r\n                    \r\n                   cur_frm.refresh_field(\"items\")\r\n                  \r\n                    //console.log(String(uom),\"strinfguom\",conversion_factor);\r\n                    // cur_pos.item_details.set_uom_value(String(uom),conversion_factor)\r\n                    // cur_pos.item_details.events.close_item_details();\r\n                    // cur_pos.item_details.uom_control.set_value(uom);\r\n                    // cur_pos.item_details.uom_control.refresh();\r\n                    \r\n                    // cur_pos.item_details.conversion_factor_control.set_value((conversion_factor));\r\n                    // cur_pos.item_details.conversion_factor_control.refresh();\r\n                    // //cur_pos.item_details.events.close_item_details();\r\n                    var item_rownew = this.get_item_from_frm(item_code, batch_no, uom);\r\n                    // item_rownew.uom=uom;\r\n                    // item_rownew.conversion_factor=conversion_factor\r\n                    \r\n                   // console.log(\"lastcall\",item_rownew,item_rownew.rate,item_rownew.base_rate,item_rownew)\r\n                    \r\n                        this.update_cart_html(item_rownew)\r\n                    \r\n                    \r\n\t\t\t\t\r\n                }\r\n                else{\r\n                    this.update_cart_html(item_row);\r\n                }\r\n                \r\n                \r\n            }\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log(error);\r\n\t\t} finally {\r\n\t\t\tfrappe.dom.unfreeze();\r\n\t\t\treturn item_row;\r\n\t\t}\r\n\r\n    }\r\n\tasync on_bundle_cart_update(args) {\r\n\t\tfrappe.dom.freeze();\r\n\t\tlet item_row = undefined;\r\n\t\ttry {\r\n\t\t\tlet { field, value, item } = args;\r\n           \r\n\t\t\tconst { item_code, batch_no, serial_no, uom,rate } = item;\r\n            \r\n\t\t\titem_row = this.get_item_from_frm(item_code, batch_no, uom);\r\n\t\t\tconsole.log(rate,\"$$$$$$$$\")\r\n\t\t\tif(item_row){\r\n               \r\n\t\t\t\tthis.cart.events.cart_combo_item_clicked(item_code, batch_no, uom,rate,args);\r\n\t\t\t}\r\n\t\t\telse{\r\n                \r\n\t\t\t\tthis.on_cart_update(args)\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log(error);\r\n\t\t} finally {\r\n\t\t\tfrappe.dom.unfreeze();\r\n\t\t\treturn item_row;\r\n\t\t}\r\n\t}\r\n\tasync on_cart_update(args) {\r\n\t\t\r\n\t\tfrappe.dom.freeze();\r\n\t\tlet item_row = undefined;\r\n\t\ttry {\r\n\t\t\tlet { field, value, item } = args;\r\n\t\t\t//slot_name field added by shiby\r\n            \r\n\t\t\tconst { item_code, batch_no, serial_no, uom ,rate} = item;\r\n            \r\n\t\t\titem_row = this.get_item_from_frm(item_code, batch_no, uom);\r\n           \r\n\t\t\tconst item_selected_from_selector = field === 'qty' && value === \"+1\"\r\n           \r\n\r\n\t\t\tif (item_row && item_row.rate==rate ) {\r\n                console.log(item_row.rate,\"222222222222222\",rate,item_row.is_free_item)\r\n                if(!item_row.is_free_item){\r\n                    \r\n\t\t\t\titem_selected_from_selector && (value = item_row.qty + flt(value))\r\n\t\t\t\tfield === 'qty' && (value = flt(value));\r\n\t\t\t\t\r\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\r\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\r\n\t\t\t\t}\r\n             \r\n\t\t\t\tif(cur_pos.item_selector.bundle_item && cur_pos.item_selector.bundle_item!='' && cur_pos.item_selector.bundle_item!='null' && cur_pos.item_selector.bundle_item!='undefined' && cur_pos.item_selector.bundle_item!=0)  {\r\n\t\t\t\t\t\r\n\t\t\t\t\tcur_pos.combo_item_details.total_packed_qty=value\r\n\t\t\t\t\tthis.combo_item_details.current_item=item_row;\r\n                    this.item_details.current_item=item_row;\r\n                    cur_pos.combo_item_details.combo_items=[];\r\n\t\t\t\t\tthis.edit_combo_item_details_of(item_row)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t }\r\n                \r\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || item_selected_from_selector || this.is_current_combo_item_being_edited(item_row)) {\r\n                   \r\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\r\n                       \r\n                        this.update_cart_html(item_row);\r\n                   \r\n\t\t\t\t}\r\n            }\r\n\r\n\t\t\t} else {\r\n\t\t\t\tif (!this.frm.doc.customer) {\r\n\t\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\tmessage: __('You must select a customer before adding an item.'),\r\n\t\t\t\t\t\tindicator: 'orange'\r\n\t\t\t\t\t});\r\n\t\t\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (!item_code) return;\r\n                item_selected_from_selector && (value = flt(value))\r\n                \r\n\r\n\t\t\t\tconst args = { item_code, batch_no, [field]: value };\r\n                \r\n\t\t\t\tif (serial_no) {\r\n\t\t\t\t\tawait this.check_serial_no_availablilty(item_code, this.frm.doc.set_warehouse, serial_no);\r\n\t\t\t\t\targs['serial_no'] = serial_no;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (field === 'serial_no') args['qty'] = value.split(`\\n`).length || 0;\r\n\r\n\t\t\t\titem_row = this.frm.add_child('items', args);\r\n                \r\n\t\t\t\tif (field === 'qty' && value !== 0 && !this.allow_negative_stock)\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, value, this.frm.doc.set_warehouse);\r\n\r\n\t\t\t\tawait this.trigger_new_item_events(item_row);\r\n\r\n\t\t\t\tthis.check_serial_batch_selection_needed(item_row) && this.edit_item_details_of(item_row);\r\n             if(cur_pos.item_selector.bundle_item && cur_pos.item_selector.bundle_item!='' && cur_pos.item_selector.bundle_item!='null' &&  cur_pos.item_selector.bundle_item!='undefined' && cur_pos.item_selector.bundle_item!=0)  {\r\n\t\t\t\t//item_row.qty=0\r\n\t\t\t\tthis.combo_item_details.current_item=item_row;\r\n                this.item_details.current_item=item_row;\r\n\t\t\t\tcur_pos.combo_item_details.total_packed_qty=item_row.qty\r\n                cur_pos.combo_item_details.combo_items = [];\r\n\t\t        cur_pos.combo_item_details.combo_default_items = [];\r\n\t\t\t\tthis.edit_combo_item_details_of(item_row)\r\n             } \r\n\t\t\t \r\n\t\t\t\tthis.update_cart_html(item_row);\r\n\r\n\t\t\t \r\n             \r\n\t\t\t\t\r\n\t\t\t}\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log(error);\r\n\t\t} finally {\r\n\t\t\tfrappe.dom.unfreeze();\r\n\t\t\treturn item_row;\r\n\t\t}\r\n\t}\r\n\t//added by shiby\r\n\t\r\n\tasync on_cart_update_desc(args) {\r\n\t\t\r\n\t\tlet item_row = undefined;\r\n\t\ttry {\r\n\t\t\tlet { field, value, item } = args;\r\n\t\t\tconst { item_code, batch_no, serial_no, uom,rate } = item;\r\n\t\t\titem_row = this.get_item_from_frm(item_code, batch_no, uom);\r\n\t\t\t\r\n\t\t\tconst item_selected_from_selector = field === 'qty' && value === \"-1\"\r\n\t\t\r\n\t\t\tif (item_row) {\r\n                if(!item_row.is_free_item){\r\n\t\t\t\titem_selected_from_selector && (value = item_row.qty + flt(value))\r\n\r\n\t\t\t\tfield === 'qty' && (value = flt(value));\r\n\r\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\r\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || item_selected_from_selector) {\r\n\t\t\t\t\t\r\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\r\n\t\t\t\t\tthis.update_cart_html(item_row);\r\n\t\t\t\t}\r\n            }\r\n\r\n\t\t\t} \r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log(error);\r\n\t\t} finally {\r\n\t\t\tfrappe.dom.unfreeze();\r\n\t\t\treturn item_row;\r\n\t\t}\r\n\t}\r\n\tasync on_cart_update_uom(args) {\r\n\t\t\r\n\t\tlet item_row = undefined;\r\n\t\ttry {\r\n\t\t\tlet { field, value, item } = args;\r\n\t\t\tconst { item_code, batch_no, serial_no, uom } = item;\r\n\t\t\titem_row = this.get_item_from_frm(item_code, batch_no, uom);\r\n\t\t\t\r\n\t\t\tconst item_selected_from_selector = field === 'qty' && value === \"-1\"\r\n\t\t\t\r\n\t\t\tif (item_row) {\r\n\t\t\t\t\r\n\t\t\t\titem_selected_from_selector && (value = item_row.qty + flt(value))\r\n\r\n\t\t\t\tfield === 'uom' && (value = flt(value));\r\n\r\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\r\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\r\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || item_selected_from_selector) {\r\n\t\t\t\t\t\r\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\r\n\t\t\t\t\tthis.update_cart_html(item_row);\r\n\t\t\t\t}\r\n\r\n\t\t\t} \r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log(error);\r\n\t\t} finally {\r\n\t\t\tfrappe.dom.unfreeze();\r\n\t\t\treturn item_row;\r\n\t\t}\r\n\t}\r\n\tget_item_from_frm(item_code, batch_no, uom) {\r\n\t\tconst has_batch_no = batch_no;\r\n\t\treturn this.frm.doc.items.find(\r\n\t\t\ti => i.item_code === item_code\r\n\t\t\t\t&& (!has_batch_no || (has_batch_no && i.batch_no === batch_no))\r\n\t\t\t\t&& (i.uom === uom) && (i.is_free_item === 0)\r\n\t\t);\r\n\t}\r\n\tget_combo_item_from_frm(item_code, parent_item) {\r\n\t\t\r\n\t\treturn this.frm.doc.seleceted_packed_items.find(\r\n\t\t\ti => i.item_code === item_code && i.parent_item===parent_item\r\n\t\t\t\t\r\n\t\t);\r\n\t}\r\n\tedit_item_details_of(item_row) {\r\n\t\tthis.item_details.toggle_item_details_section(item_row);\r\n\t}\r\n\tedit_combo_item_details_of(item_row) {\r\n\t\t\r\n\t\tthis.combo_item_details.toggle_combo_item_details_section(item_row);\r\n\t}\r\n\tis_current_item_being_edited(item_row) {\r\n\t\t\r\n\t\tconst { item_code, batch_no } = this.item_details.current_item;\r\n\t\t\r\n     \t//console.log(this.item_details.current_item,item_row,batch_no,\"batchno\",item_row.batch_no,item_code,\"code\",item_row.item_code)\r\n\t\treturn item_code !== item_row.item_code || batch_no != item_row.batch_no ?  false : true;\r\n\t}\r\n\tis_current_combo_item_being_edited(item_row) {\r\n\t\t\r\n\t\tconst { item_code, batch_no } = this.combo_item_details.current_item;\r\n\t\t\r\n     \t//console.log(this.item_details.current_item,item_row,batch_no,\"batchno\",item_row.batch_no,item_code,\"code\",item_row.item_code)\r\n\t\treturn item_code !== item_row.item_code || batch_no != item_row.batch_no ?  false : true;\r\n\t}\r\n\tupdate_cart_html(item_row, remove_item) {\r\n\t\t\r\n\t\tthis.cart.update_item_html(item_row, remove_item);\r\n        // this.cart.update_item_html(item_row,remove_item,function(){\r\n        //     cur_pos.cart.check_minimum_sales_qty=false;\r\n        //         console.log($('.cart-item-wrapper .quantity input'),\"qtyobject\")\r\n        //         $('.cart-item-wrapper .quantity input').change();\r\n        //         cur_pos.cart.check_minimum_sales_qty=true;\r\n        // });\r\n\t\tthis.cart.update_totals_section(this.frm);\r\n       \r\n\t}\r\n\tupdate_cart_html_uom(item_row, nuom,convfactor) {\r\n\t\tthis.cart.update_item_html(item_row, remove_item);\r\n\t\tthis.cart.update_totals_section(this.frm);\r\n\t}\r\n\tcheck_serial_batch_selection_needed(item_row) {\r\n\t\t// right now item details is shown for every type of item.\r\n\t\t// if item details is not shown for every item then this fn will be needed\r\n\t\tconst serialized = item_row.has_serial_no;\r\n\t\tconst batched = item_row.has_batch_no;\r\n\t\tconst no_serial_selected = !item_row.serial_no;\r\n\t\tconst no_batch_selected = !item_row.batch_no;\r\n\r\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\r\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tasync trigger_new_item_events(item_row) {\r\n       \r\n        \r\n\t\tawait this.frm.script_manager.trigger('item_code', item_row.doctype, item_row.name);\r\n\t\tawait this.frm.script_manager.trigger('qty', item_row.doctype, item_row.name);\r\n\t\tconst  is_bundle = await frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_row.item_code} , \"name\");\r\n\t\t\r\n\t\t\tif(is_bundle.message.name)\r\n             {\r\n\t\t\t\t\r\n\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, 'bundle_item', 1);\r\n\t\t\t }\r\n\r\n        // await this.frm.script_manager.trigger('uom', item_row.doctype, item_row.name);\r\n        // await this.frm.script_manager.trigger('conversion_factor', item_row.doctype, item_row.name);\r\n        \r\n\t}\r\n    async trigger_new_item_events_so(item_row,rate,uom) {\r\n       \r\n        \r\n\t\tawait this.frm.script_manager.trigger('item_code', item_row.doctype, item_row.name);\r\n\t\tawait this.frm.script_manager.trigger('qty', item_row.doctype, item_row.name);        \r\n        await frappe.model.set_value(item_row.doctype, item_row.name, 'stock_uom', uom);\r\n        await frappe.model.set_value(item_row.doctype, item_row.name, 'uom', uom);       \r\n        await frappe.model.set_value(item_row.doctype, item_row.name, 'rate', rate);\r\n\t\tconst  is_bundle = await frappe.db.get_value(\"Product Bundle\", {\"new_item_code\":item_row.item_code} , \"name\");\r\n\t\t\tif(is_bundle.message.name)\r\n             {\r\n\t\t\t\t\r\n\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, 'bundle_item', 1);\r\n\t\t\t }\r\n\t\t\r\n        \r\n\t}\r\n\tasync check_stock_availability(item_row, qty_needed, warehouse) {\r\n\t\tconst available_qty = (await this.get_available_stock(item_row.item_code, warehouse)).message;\r\n\r\n\t\tfrappe.dom.unfreeze();\r\n\t\tconst bold_item_code = item_row.item_code.bold();\r\n\t\tconst bold_warehouse = warehouse.bold();\r\n\t\tconst bold_available_qty = available_qty.toString().bold()\r\n\t\tif (!(available_qty > 0)) {\r\n\t\t\tconst  res = await frappe.db.get_value(\"Item\",  item_row.item_code, \"is_stock_item\");\r\n\t\t\tif(res.message.is_stock_item==1)\r\n             {\r\n\t\t\tfrappe.model.clear_doc(item_row.doctype, item_row.name);\r\n\t\t\tfrappe.throw({\r\n\t\t\t\ttitle: __(\"Not Available\"),\r\n\t\t\t\tmessage: __('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\r\n\t\t\t})\r\n\t\t}\r\n\t\t} else if (available_qty < qty_needed) {\r\n\t\t\tfrappe.show_alert({\r\n\t\t\t\tmessage: __('Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2}.', [bold_item_code, bold_warehouse, bold_available_qty]),\r\n\t\t\t\tindicator: 'orange'\r\n\t\t\t});\r\n\t\t\tfrappe.utils.play_sound(\"error\");\r\n\t\t}\r\n\t\tfrappe.dom.freeze();\r\n\t}\r\n\r\n\tasync check_serial_no_availablilty(item_code, warehouse, serial_no) {\r\n\t\tconst method = \"erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos\";\r\n\t\tconst args = {filters: { item_code, warehouse }}\r\n\t\tconst res = await frappe.call({ method, args });\r\n\r\n\t\tif (res.message.includes(serial_no)) {\r\n\t\t\tfrappe.throw({\r\n\t\t\t\ttitle: __(\"Not Available\"),\r\n\t\t\t\tmessage: __('Serial No: {0} has already been transacted into another POS Invoice.', [serial_no.bold()])\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tget_available_stock(item_code, warehouse) {\r\n\t\tconst me = this;\r\n\t\treturn frappe.call({\r\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability\",\r\n\t\t\targs: {\r\n\t\t\t\t'item_code': item_code,\r\n\t\t\t\t'warehouse': warehouse,\r\n\t\t\t},\r\n\t\t\tcallback(res) {\r\n\t\t\t\tif (!me.item_stock_map[item_code])\r\n\t\t\t\t\tme.item_stock_map[item_code] = {}\r\n\t\t\t\tme.item_stock_map[item_code][warehouse] = res.message;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tupdate_item_field(value, field_or_action) {\r\n\t\tif (field_or_action === 'checkout') {\r\n\t\t\tthis.item_details.toggle_item_details_section(undefined);\r\n\t\t\t\r\n\t\t} else if (field_or_action === 'remove') {\r\n            console.log(\"remove_item_from_cartELSE\")\r\n\t\t\tthis.remove_item_from_cart();\r\n\t\t} else {\r\n\t\t\tconst field_control = this.item_details[`${field_or_action}_control`];\r\n\t\t\tif (!field_control) return;\r\n\t\t\tfield_control.set_focus();\r\n\t\t\tvalue != \"\" && field_control.set_value(value);\r\n\t\t}\r\n\t}\r\n    update_combo_item_field() {\r\n        \r\n\t\t \r\n\t\t this.remove_item_from_combo_cart();\r\n\t\t\r\n\t}\r\n    remove_item_from_combo_cart() {\r\n       \r\n\t\tconst { doctype, name, current_item } = this.combo_item_details;\r\n        let{combodoctype,comboname,combo_current_item}=''\r\n        frappe.model.set_value(doctype, name, 'qty', 0)\r\n\t\t\t.then(() => {\r\n               \r\n\t\t\t\tfrappe.model.clear_doc(doctype, name);\r\n\t\t\t\tthis.update_cart_html(current_item, true);\r\n\t\t\t\tthis.item_details.toggle_item_details_section(undefined);\r\n                cur_frm.doc.seleceted_packed_items.forEach(citem => {\r\n                    combodoctype='Selected Packed Items';\r\n                    comboname=citem.name; \r\n                    if(String(citem.parent_item)==String(current_item.item_code))  \r\n                    {\r\n                        frappe.model.set_value(combodoctype, comboname, 'packed_quantity', 0)\r\n                    }        \r\n                  \r\n                          \r\n                   \r\n                })\r\n\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t})\r\n\t\t\t.catch(e => console.log(e));\r\n        \r\n       \r\n\t}\r\n\tremove_item_from_cart() {\r\n       \r\n\t\tfrappe.dom.freeze();\r\n        \r\n\t\tconst { doctype, name, current_item } = this.item_details;\r\n      \r\n\t\tfrappe.model.set_value(doctype, name, 'qty', 0)\r\n\t\t\t.then(() => {\r\n               \r\n\t\t\t\tfrappe.model.clear_doc(doctype, name);\r\n\t\t\t\tthis.update_cart_html(current_item, true);\r\n\t\t\t\tthis.item_details.toggle_item_details_section(undefined);\r\n\t\t\t\tfrappe.dom.unfreeze();\r\n\t\t\t})\r\n\t\t\t.catch(e => console.log(e));\r\n\t}\r\n\tcreate_event_booking()\r\n    {\r\n\t\t\r\n        if(!cur_pos.cart.location_so_field.value && cur_pos.cart.location_event_field.value && cur_pos.cart.location_event_slot_field.value  ) \r\n        {\r\n\t\t\t//cur_frm.doc.posting_date.set_value(cur_pos.cart.location_visitdate.value)\r\n            const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.create_event_booking\";\r\n            frappe.call({\r\n                 method,  \r\n                 freeze:true,\r\n                 args:{pos_invoice:cur_frm.doc.name,\r\n\t\t\t\t\tevent:cur_pos.cart.location_event_field.value,\r\n\t\t\t\t\tposting_date:cur_frm.doc.posting_date,\r\n\t\t\t\t\tslot:cur_pos.cart.location_event_slot_field.value,\r\n\t\t\t\t\tbrand:cur_pos.cart.location_brand_field.value,\r\n\t\t\t\t\tcity:cur_pos.cart.location_city_field.value,\r\n\t\t\t\t\tbranch:cur_pos.cart.location_branch_field.value,\r\n\t\t\t\t\tdepartment:cur_pos.cart.location_department_field.value\r\n\t\t\t\t} \r\n                });\r\n                \r\n\r\n        }    \r\n        \r\n    }\r\n    update_Item()\r\n    {\r\n        // if(!cur_pos.cart.custom_field.value && cur_pos.cart.event_field.value ) \r\n        // {\r\n        //     const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_Item\";\r\n            \r\n        //         frappe.call({\r\n        //             method,  \r\n        //              freeze:true,\r\n        //              args:{event:cur_pos.cart.event_field.value} \r\n        //             });    \r\n\r\n        // }   \r\n\t\t// else{console.log\r\n\t\t\t\r\n\t\t\tcur_frm.doc.items.forEach(item => {\t\t\t\t\r\n                \r\n\t\t\t\t const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_Item\";\r\n            \r\n                frappe.call({\r\n                    method,  \r\n                     freeze:true,\r\n                     args:{event: item.item_code} \r\n                    });    \r\n\t\t\t})\r\n\r\n\t\t// } \r\n    }\r\n\tupdate_POS_Item()\r\n    {\r\n        if(!cur_pos.cart.location_so_field.value && cur_pos.cart.location_event_field.value   ) \r\n        {\r\n\t\t\t\r\n            const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_POS_Item\";\r\n            \r\n                frappe.call({\r\n                    method,  \r\n                     freeze:true,\r\n                     args:{pos_invoice:cur_frm.doc.name,\r\n\t\t\t\t\t\tevent:cur_pos.cart.location_event_field.value,\r\n\t\t\t\t\t\tslot:cur_pos.cart.location_event_slot_field.value} \r\n                    });    \r\n\r\n        } \r\n\t\t  \r\n    }\r\n\tupdate_POS()\r\n    {\r\n        if(!cur_pos.cart.location_so_field.value )\r\n\t\t\t//&& cur_pos.cart.location_event_field.value  ) \r\n        {\r\n\t\t\t\r\n            // const method = \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_POS\";\r\n            //     frappe.call({\r\n            //         method,  \r\n            //          freeze:true,\r\n\t\t\t// \t\t async:false,\r\n            //          args:{pos_invoice:cur_frm.doc.name,\r\n\t\t\t// \t\t\tbrand:cur_pos.cart.location_brand_field.value,\r\n\t\t\t// \t\t\tcity:cur_pos.cart.location_city_field.value,\r\n\t\t\t// \t\t\tbranch:cur_pos.cart.location_branch_field.value,\r\n            //             slot:cur_pos.cart.location_event_slot_field.value,\r\n            //             event:cur_pos.cart.location_event_field.value,\r\n\t\t\t// \t\t\tdepartment:cur_pos.cart.location_department_field.value} \r\n            //         });    \r\n\r\n        } \r\n\t\telse{\r\n\t\t\treturn frappe.call({\r\n\t\t\t\tasync:false,\r\n\t\t\t\tmethod: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.update_accounting_dimension\",\r\n\t\t\t\targs: {\r\n\t\t\t\t\t'sales_order': cur_pos.cart.location_so_field.value,\r\n\t\t\t\t\t'pos_invoice':cur_frm.doc.name\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\t  \r\n    }\r\n\t\r\n};\r\n\r\n","erpnext.PointOfSale.ComboItemDetails = class {\r\n\tconstructor({ wrapper, events, settings }) {\r\n\t\tthis.wrapper = wrapper;\r\n\t\tthis.events = events;\t\t\r\n\t\tthis.current_item = {};\r\n\t\tthis.init_component();\r\n\t\tthis.total_packed_qty=0;\r\n\t\tthis.combo_items = [];\r\n\t\tthis.set_items = [];\r\n\t\tthis.combo_default_items = [];\r\n\t\t\r\n\t}\r\n\r\n\tinit_component() {\r\n\t\tthis.prepare_dom();\r\n\t\tthis.combo_items = [];\r\n\t\tthis.combo_default_items = [];\r\n\t\tthis.set_items = [];\r\n\t\tthis.init_child_components();\r\n\t\tthis.bind_events();\r\n\t\tthis.toggle_component(false);\r\n        \r\n      //this.init_numpad_components() ;\r\n       \r\n        //this.load_combo_items_data();\r\n\t\t// this.attach_shortcuts();\r\n\t}\r\n\r\n\tprepare_dom() {\r\n\t\tthis.wrapper.append(\r\n\t\t\t`<section class=\"combo-item-details-container\" style=\"width: 600px; overflow-y: scroll;\" >            \r\n            </section>`\r\n\t\t)\r\n\t\tthis.$component = this.wrapper.find('.combo-item-details-container');       \r\n\t}\r\n\r\n\tinit_child_components() {\t\r\n\t\t\r\n\t\tthis.$component.html(\r\n\t\t\t`<div class=\"combo-item-details-header\">\r\n\t\t\t\t\r\n\t\t\t\t<div class=\"combo-close-btn\" style=\" text-align:right;\">\r\n\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\r\n\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t</div>\r\n\t\t\t\t\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"row col-md-12 total-qty\"  >\r\n\t\t\t\t<div class=\"  col-md-3 label text-center\" style=\"font-weight: bolder;\">Total Qty</div>\r\n\t\t\t\t<div class=\" col-md-5\">\r\n                <span class=\"input-group-append d-sm-inline-block\">\r\n            <button class=\"btn tot-btn\" data-dir=\"inc\" onclick=\"updatetotalQty(this)\" >\r\n             +\r\n            </button>\r\n            </span>\r\n\t\t\t\t<input class=\"form-control text-center combo-total-qty\" style=\"font-weight: bolder;width: 50px;display: inline; !important \" value=${this.total_packed_qty?this.total_packed_qty:0}   onclick=\"changetotqty(this)\">\r\n\t\t\t\t<span class=\"input-group-append d-sm-inline-block\">\r\n            <button class=\"btn tot-btn\" data-dir=\"dec\" onclick=\"updatetotalQty(this)\" \r\n            >\r\n                -\r\n            </button>\r\n            </span>\r\n                </div><div class=\"col-md-4 btn combo-item-rm-btn\"  style=\"color: red;font-weight: bold\">Remove from cart</div></div>\r\n\t\t\t\t\r\n\t\t\t\t<div class=\"col-md-12 combo-defalt-items-container\" style=\" align-self: flex-end;\r\n\t\t\t\tdisplay: grid;\r\n\t\t\t\t \">\r\n\t\t\t\t\r\n\t\t\t</div>\r\n\t\t\t<div class=\"col-md-12 combo-items-container\" style=\" align-self: flex-end;\r\n\t\t\tdisplay: grid;\r\n\t\t\t\">\r\n\t\t\t\t\r\n\t\t\t</div>\r\n            <div  class=\"col-md-12  row\" style=\"margin-left: 0px;\"> <div ></div>\r\n            <div class=\"col-md-12 btn combo-item-ok-btn\"   style=\"font-weight: bold;text-align: right;background-color: var(--blue-500);\r\n            color: rgb(255, 255, 255);\r\n            \">OK</div><div ></div></div>\r\n            <script>\r\n            function updatetotalQty(elmnt) {\r\n    \r\n                var btn = $(elmnt),\r\n                        input = btn.closest('.total-qty').find('input'),\r\n                        oldValue = input.val().trim(),\r\n                        newVal = 0;\r\n                    if (btn.attr('data-dir') == 'inc') {\r\n                        newVal = parseInt(oldValue) + 1;\r\n                    }\r\n                    else\r\n                    {\r\n                        if (oldValue >= 1) {\r\n                            newVal = parseInt(oldValue) - 1;\r\n                        }\r\n                    }\r\n                    input.val(newVal);\r\n            \r\n            }\r\n            </script>\r\n            `\r\n\t\t\r\n\t\t)\r\n\t\t\t\r\n\t\t\r\n\r\n        this.$items_container = this.$component.find('.combo-items-container');\r\n\t\tthis.$default_items_container = this.$component.find('.combo-defalt-items-container');\r\n        \r\n\t}\r\n    init_numpad_components(){\r\n        this.$component.append(`<div class=\"combo-numpad-section\"></div>`) \r\n        this.make_combo_numpad();\r\n    }\r\n   \r\n\ttoggle_combo_item_details_section(item) {\r\n       \r\n\t\tconst { item_code, batch_no, uom ,rate} = this.current_item;\r\n\t\tthis.total_packed_qty=cur_pos.combo_item_details.current_item.qty;\r\n\t\t\r\n\t\tconst item_code_is_same = item && item_code === item.item_code;\r\n\t\tconst batch_is_same = item && batch_no == item.batch_no;\r\n\t\tconst uom_is_same = item && uom === item.uom;\r\n\t\tthis.item_has_changed = !item ? false : item_code_is_same && batch_is_same && uom_is_same ? false : true;\r\n       if(item){\r\n\t\t\tthis.item_has_changed=true;\r\n\t\t\t//this.load_combo_items_data(item.item_code,item.qty);\r\n\t   }\r\n\t   else{\r\n\t\t\tthis.item_has_changed=false;\r\n\t   }\r\n\t   this.events.toggle_combo_item_selector(this.item_has_changed);\r\n\t\tthis.toggle_component(this.item_has_changed);\r\n\t\t\r\n\t\tif (this.item_has_changed) {\r\n           \r\n\t\t\tthis.doctype = item.doctype;\r\n\t\t\tthis.item_meta = frappe.get_meta(this.doctype);\r\n\t\t\tthis.name = item.name;\r\n\t\t\tthis.item_row = item;\r\n\t\t\tthis.currency = this.events.get_frm().doc.currency;\r\n\t\t\tthis.current_item = { item_code: item.item_code, batch_no: item.batch_no, uom: item.uom ,rate:item.rate};\r\n\t\t\tthis.load_combo_items_data(item.item_code,item.qty);\r\n\t\t}\r\n      \r\n\t}\r\n\ttoggle_component(show) {\r\n\t\tshow ? this.$component.css('display', 'block') : this.$component.css('display', 'none');\r\n        \r\n\t}\r\n\tcheck_set_total(){\r\n\t\tvar setno_wise_qty=[]\r\n\t\tvar setno=''\r\n\t\tthis.set_items.forEach(item => {\r\n\t\t\t\r\n\t\t\t\tvar check_item_set = cur_pos.combo_item_details.combo_items.filter(set => \r\n\t\t\t\t\t(parseInt(set.set_no) === parseInt(item.set_no)\r\n\t\t\t\t   ));\r\n\t\t\t\t \r\n\t\t\t\t   var settotal=0\r\n\t\t\t\t   if (check_item_set){\r\n\t\t\t\t\t\r\n\t\t\t\t   for (let rm = 0; rm < check_item_set.length; rm++) {\r\n\t\t\t\t\tsettotal=settotal+Math.abs(check_item_set[rm].packed_quantity)\r\n\t\t\t\t   }\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tvar current_item={} \r\n\t\t\t\tcurrent_item.set_no = item.set_no\r\n\t\t\t\tcurrent_item.set_total = settotal\r\n\t\t\t\tvar check_duplicate = setno_wise_qty.filter(d => \r\n\t\t\t\t\t(parseInt(d.set_no) === parseInt(item.set_no)\r\n\t\t\t\t   ));\r\n\t\t\t\t  \r\n\t\t\t\t   if(check_duplicate.length==0){\r\n\t\t\t\t\tsetno_wise_qty.push(current_item); \r\n\t\t\t\t   }\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t})\r\n\t\treturn setno_wise_qty\r\n\t}\r\n    bind_events() {\r\n\t\tconst me=this;\r\n\t\tthis.$component.on('click', '.combo-close-btn,.combo-item-ok-btn', () => {\r\n\t\t\tme.total_packed_qty=$('.combo-total-qty').val();\t\t\t\r\n\t\t\t\r\n            const { item_code, batch_no,serial_no,uom,rate } = me.current_item;\r\n\t\t\tlet item_row = undefined; var flag=1;\r\n\t\t\titem_row = cur_pos.get_item_from_frm(item_code, batch_no, uom);\r\n           \r\n           if(this.combo_default_items.length ==0 && this.set_items.length>0 && cur_pos.combo_item_details.combo_items.length==0)\r\n            {\r\n                frappe.throw('Select Set Item')\r\n            }\r\n\t\t\tvar setno_wise_qty=me.check_set_total()\r\n\t\t\t\tsetno_wise_qty.forEach(item => {\r\n\t\t\t\t\tif(item.set_total!=me.total_packed_qty){\r\n\t\t\t\t\t\tfrappe.throw('Total Set Quantity must be Total Cart Quantity')\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\r\n\t\t\t})\r\n            if(cur_pos.combo_item_details.combo_items.reduce((accumulator, current) => accumulator + current.x, 0)!=0 || this.combo_default_items.length>0 ){\r\n                \r\n                cur_pos.combo_item_details.combo_items.forEach(item => {\r\n               \r\n                var filtered = cur_pos.combo_item_details.combo_items.filter((a)=>{if(a.set_no==item.set_no){return a}});\r\n                let totqty =item.set_no!=0?  filtered.reduce(function (accumulator, items) {\r\n                    \r\n                    return accumulator + Math.abs(items.packed_quantity);\r\n                  }, 0):0;\r\n                 \r\n                if(parseInt(Math.abs(totqty))>parseInt(Math.abs(me.total_packed_qty)))\r\n                 {               \r\n                   \r\n                    frappe.throw('Set Quantity Exceeds Total Quantity')\r\n                  }\r\n                                    \r\n                  else{\r\n                    flag=1;\r\n                  }\r\n                  var check_item = cur_pos.combo_item_details.combo_items.filter(set => \r\n                    (parseInt(set.set_no) === parseInt(item.set_no)\r\n                   ));\r\n                 \r\n                   var settotal=0\r\n                   for (let rm = 0; rm < check_item.length; rm++) {\r\n                    settotal=settotal+Math.abs(check_item[rm].packed_quantity)\r\n                   }\r\n                 \r\n                   if( item.set_no!=0 && !cur_frm.doc.is_return && parseInt(Math.abs(settotal))<parseInt(Math.abs(me.total_packed_qty))){\r\n                    \r\n                    frappe.throw('Set quantity must be total quantity')\r\n                    \r\n                  }\r\n\r\n                })\r\n            if(flag==1){\r\n              me.update_selected_pack_item()\r\n              me.events.item_selected({ field: 'qty', value:flt(me.total_packed_qty) , item: { item_code, batch_no, serial_no, uom,rate }}).then(() => \r\n              {const event = {\r\n                field: \"qty\",\r\n                value:flt(me.total_packed_qty),\r\n                item: { item_code, batch_no, uom }\r\n            }\r\n             \r\n             setTimeout(() => {\r\n                \r\n                cur_pos.cart.make_no_items_placeholder();\r\n             cur_frm.doc.items.forEach(item => {\r\n\r\n                cur_pos.cart.update_item_html(item);\r\n            });\r\n            me.events.close_combo_item_details();\r\n            }, 900);\r\n            \r\n        })\r\n            \r\n              \r\n                \r\n            }\r\n            else{\r\n                frappe.throw('Set Quantity Exceeds Total Quantity'\r\n              )\r\n            }\r\n        }\r\n        else{\r\n            \r\n            me.events.item_selected({ field: 'qty', value:0 , item: { item_code, batch_no, serial_no, uom }}).then(() => \r\n            {const event = {\r\n              field: \"qty\",\r\n              value:0,\r\n              item: { item_code, batch_no, uom }\r\n          }\r\n           \r\n           setTimeout(() => {\r\n              \r\n            cur_pos.cart.make_no_items_placeholder();\r\n           cur_frm.doc.items.forEach(item => {\r\n\r\n              cur_pos.cart.update_item_html(item);\r\n          });\r\n          me.events.close_combo_item_details();\r\n          }, 900);\r\n          \r\n      })\r\n               \r\n\r\n        }\r\n        \r\n\t})\r\n    this.$component.on('click', '.combo-item-rm-btn', () => {\r\n       // \r\n        me.events.combo_numpad_event();\r\n\t\tme.events.close_combo_item_details();\r\n    })\r\n\t}\r\n\tupdate_selected_pack_item(){\r\n\t\t\r\n\t\tconst frm = this.events.get_frm();\r\n       \r\n\t\t\t\tif(cur_frm.doc.__islocal==1){\r\n\r\n\t\t\t\t}\r\n                    \r\n\t\t\t\t  this.combo_default_items.forEach(item => \r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar flag=0;\t\r\n\t\t\t\t\t\tcur_pos.combo_item_details.combo_items.forEach(comboitem => {\r\n                         \r\n\t\t\t\t\t\t\tif(item.item_code==comboitem.item_code && item.parent_item==comboitem.parent_item)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tflag=1;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t\t  if(flag==0){\r\n\t\t\t\t\tvar cur_item={};\r\n\t\t\t\t\t\r\n\t\t\t\t\tcur_item.item_code=item.item_code\r\n\t\t\t\t\tcur_item.parent_item=cur_pos.combo_item_details.current_item.item_code\r\n\t\t\t\t\tcur_item.packed_quantity=$('.combo-total-qty').val()\r\n\t\t\t\t\tcur_item.set_no=item.set_no\r\n\t\t\t\t\tcur_item.combo_qty=item.qty\r\n\t\t\t\t\tcur_item.default_item_in_pos=1\t\t\t\t\t\r\n\t\t\t\t\tcur_pos.combo_item_details.combo_items.push(cur_item)\r\n\r\n\t\t\t\t  }\r\n\t\t\t\t\t\t\r\n\t\t\t\t  })\r\n                 \r\n\t\t\t\tcur_pos.combo_item_details.combo_items.forEach(item => {\r\n\t\t\t\t\tvar flag=0;\t\r\n                   \r\n\t\t\t\t\tfrm.doc.seleceted_packed_items.forEach(citem => {\r\n                        \r\n\t\t\t\t\t\tif(item.item_code==citem.item_code && item.parent_item==citem.parent_item)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tflag=1;\r\n\t\t\t\t\t\t\t\tlet combo_item_row = undefined;\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcombo_item_row = cur_pos.get_combo_item_from_frm(citem.item_code,citem.parent_item);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tfrappe.model.set_value(combo_item_row.doctype, combo_item_row.name, 'packed_quantity', item.packed_quantity);\r\n\t\t\t\t\t\t\t\tcur_frm.refresh_field(\"seleceted_packed_items\")\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tif(flag==0){\r\n\t\t\t\t\r\n\t\t\t\t\t\tvar child = cur_frm.add_child(\"seleceted_packed_items\");\r\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"parent_item\", item.parent_item)\r\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"item_code\", item.item_code)\r\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"set_no\", item.set_no)\r\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"combo_qty\", item.combo_qty)\r\n\t\t\t\t\tfrappe.model.set_value(child.doctype, child.name, \"packed_quantity\", item.packed_quantity)\r\n                    frappe.model.set_value(child.doctype, child.name, \"default_item\", item.default_item_in_pos)\r\n\t\t\t\t\tcur_frm.refresh_field(\"seleceted_packed_items\")\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t})\r\n           if(cur_frm.doc.__islocal==1){\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n        \r\n       \r\n           \r\n\t}\r\n    async load_combo_items_data(item_code,qty) {\r\n\t\t$('.combo-total-qty').val(qty)\r\n\t\t\r\n\t\tthis.get_items(item_code).then(({message}) => {\r\n        \r\n            cur_pos.combo_item_details.combo_items.forEach(citem => {\r\n\t\t\t\tmessage.ditems.forEach(item => {\r\n\t\t\t\t\tif(item.item_code==citem.item_code){\r\n\t\t\t\t\t\titem.packed_quantity=citem.packed_quantity\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t})\r\n\r\n\t\t\t})\r\n\t\t\tcur_pos.combo_item_details.combo_items.forEach(citem => {                \r\n\t\t\t\tmessage.items.forEach(item => {\r\n\t\t\t\t\tif(item.item_code==citem.item_code){\r\n                       \r\n\t\t\t\t\t\titem.packed_quantity=citem.packed_quantity\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t})\r\n\r\n\t\t\t})\r\n\t\t\t\r\n\t\t\tthis.combo_default_items=message.ditems;\r\n\t\t\tthis.set_items=message.items\r\n\t\t\tthis.render_item_list(message.items,message.sets,qty,message.ditems);\r\n\t\t\t\r\n\t\t});\r\n\t}\r\n\r\n\tget_items(item) {\r\n\t\t//const doc = this.events.get_frm().doc;\t\t\r\n\t\t//let { item_group, pos_profile } = this;\r\n\r\n\t\tif(item){\r\n\r\n        \r\n            return frappe.call({\r\n                method: \"ecs_vim.doctype_triggers.point_of_sale.point_of_sale.get_combo_items\",\r\n                freeze: true,\r\n                args: { item },\r\n            });\r\n        }\r\n\r\n\t}\r\n\r\n\trender_item_list(items,sets,qty,ditems) {\r\n\t\t\r\n\t\tthis.$items_container.html(''); var set_html='';var set_dhtml=\"\";\r\n\t\tthis.$default_items_container.html('');\r\n\t\tset_dhtml=`<div class=\"combo-defautl-item-wrapper\" style=\"font-size: 12px;\r\n\t\tpadding: 0.3rem;\r\n\t\tbox-shadow: var(--shadow-base); position: relative; font-weight: bolder;background-color: rgba(7, 153, 163, 0.74); text-align: center;color:white;\" >Default Items\r\n\t\t<table class=\"table mt-3 cart-table\" style=\"margin:0px;margin-bottom:0px;margin-top: 0px!important;\">\r\n    \r\n\t\t<tbody><tr style=\"background-color:white!important;display: grid;\r\n        grid-template-columns: repeat(5, minmax(0px, 1fr));\">`\r\n\t\tditems.forEach(item => {\r\n\t\tset_dhtml+=\r\n\t\t`<td style=\"width: 40%;padding: 0.55rem;font-weight: normal;\"><div class=\"row col-md-12\">\r\n\t\t<div  class=\"ditem-detail\" data-item-code=\"${escape(item.item_code)}\" data-qty=\"${escape(item.qty)}\"\r\n\t\tdata-description=\"${escape(item.description)}\" data-set-no=\"${escape(item.set_no)}\"\r\n >\t\t<div><img class=\"h-full\" src=\"${item.item_image}\"  style=\"object-fit: cover;height: 40px;\"></div><div>${frappe.ellipsis(item.item_code, 18)}</div></div>\r\n\t\t\t\t</div></td>`\r\n\t\t})\r\n\t\tset_dhtml+=`</tr></tbody></table></div>`\r\n\t\tthis.$default_items_container.html(set_dhtml);\r\n\t\tsets.forEach(set => {\r\n\t\t\tset_html = this.get_combo_item_html(set,items,qty);\r\n\t\t\tthis.$items_container.append(set_html);\r\n\t\t})\r\n\t}\r\n\t\r\n    get_combo_item_html(set,items,qty) {\r\n\t\tvar totqty=0;\r\n\t\tvar sethtml= `<div class=\"combo-item-wrapper\" style=\"font-size: 12px;\r\n\t\tpadding: 0.3rem;\r\n\t\tbox-shadow: var(--shadow-base); position: relative; font-weight: bolder;background-color: rgba(7, 153, 163, 0.74); text-align: center;color:white;\">\r\n\tSet: ${set.set_no}\r\n\t<table class=\"table mt-3 cart-table\" style=\"margin:0px;margin-bottom:0px;margin-top: 0px!important;\">\r\n    \r\n    <tbody class=\"cart-items\" >`\r\n\titems.forEach(item => {\r\n\t\tif(set.set_no==item.set_no)\r\n\t\t{\r\n\t\t\t\r\n\t\t\tsethtml+=`<tr style=\"background-color:white!important;\"><td style=\"padding: 0.55rem;width: 10%;\"><div class=\"d-flex\"><div class=\"item-detail\" data-item-code=\"${escape(item.item_code)}\" data-qty=\"${escape(item.qty)}\"\r\n\t\t\t   data-description=\"${escape(item.description)}\" data-set-no=\"${escape(item.set_no)}\"\r\n\t\t\t    ><div><img class=\"h-full\" src=\"${item.item_image}\"  style=\"object-fit: cover;height: 40px;\"></div></div></div>\r\n\t\t\t   </td>\r\n\t\t\t   <td  style=\"width: 60%;\r\n\t\t\t   text-align: left;word-break: break-word;\"> <div>\r\n\t\t\t   ${item.item_code}</div></td>\r\n\t\t\t   <td class=\"text-right\" style=\"padding: 0.55rem;\"width: 30%;\" >\r\n<div class=\"d-flex\">\r\n\r\n<div class=\"input-group number-spinner mt-1 mb-4\" style=\"margin-bottom: 3.5px!important;\" >\r\n<span class=\"input-group-append d-sm-inline-block\">\r\n<button class=\"btn cart-btn\" data-dir=\"up\" style=\"padding:var(--padding-xs) var(--padding-sm);\" onclick=\"updateQty(this)\" data-item-code=\"${escape(item.item_code)}\" data-qty=\"${escape(item.qty)}\"\r\ndata-description=\"${escape(item.description)}\" data-set-no=\"${escape(item.set_no)}\">\r\n    +\r\n</button>\r\n</span>\r\n\r\n    <input class=\"form-control text-center cart-qty\" readonly onchange=\"updatetotal(this)\" value=${frappe.ellipsis(item.packed_quantity, 18)} data-item-code=${frappe.ellipsis(item.item_code, 18)} style=\"max-width: 70px;\">\r\n    <span class=\"input-group-prepend d-sm-inline-block\">\r\n    <button class=\"btn cart-btn\" data-dir=\"dwn\" style=\"padding:var(--padding-xs) var(--padding-sm);\" onclick=\"updateQty(this)\" data-item-code=\"${escape(item.item_code)}\" data-qty=\"${escape(item.qty)}\"\r\n    data-description=\"${escape(item.description)}\" data-set-no=\"${escape(item.set_no)}\">\r\n        â€“\r\n    </button>\r\n</span>\r\n   \r\n    </div>\r\n\r\n<div>\r\n    \r\n    </div>\r\n</div>\r\n\r\n</td></tr>`\r\ntotqty+=item.packed_quantity\r\n\t\t}\r\n\t})\r\n\t\r\n\tsethtml+=` </tbody>\r\n    \r\n\t<tfoot class=\"cart-tax-items\">\r\n\t\t<!-- Total at the end of the cart items -->\r\n<tr style=\"background-color: rgb(236, 238, 240)!important;\">\r\n\r\n<th  colspan=\"2\" class=\"text-right item-grand-total\" style=\"font-size: 12px; width:70%;\" >Total Set Qty\r\n</th>\r\n<th class=\"text-left item-grand-total totals\" style=\" width:30%\" >\r\n${totqty}\r\n</th>\r\n</tr>\r\n\t</tfoot>\r\n\r\n</table></div>\r\n<script>\r\nfunction updatetotal(elmnt) {\r\n\t\r\n\tvar btn = $(elmnt)\r\n\tvar tot=parseInt(btn.val().trim())+(isNaN($(elmnt).closest('table').find('tfoot th:eq(1)').text()) ? 0 : parseInt($(elmnt).closest('table').find('tfoot th:eq(1)').text()))\r\n\t$(elmnt).closest('table').find('tfoot th:eq(1)').text(tot)\r\n}\r\n\r\nfunction updateQty(elmnt) {\r\n\tvar tot=isNaN($(elmnt).closest('table').find('tfoot th:eq(1)').text()) ? 0 : parseInt($(elmnt).closest('table').find('tfoot th:eq(1)').text());\r\n\t\r\n\tvar btn = $(elmnt),\r\n\t\t\tinput = btn.closest('.number-spinner').find('input'),\r\n\t\t\toldValue = input.val().trim(),\r\n\t\t\tnewVal = 0;\r\n\t\r\n\t\tif (btn.attr('data-dir') == 'up') {\r\n\t\t\tnewVal = parseInt(oldValue) + 1;\r\n\t\t\t\r\n\t\t\tif(((isNaN(tot)?0:parseInt(tot))+1)>parseInt($('.combo-total-qty').val()))\r\n\t\t\t{\r\n\t\t\t\tnewVal=oldValue;\r\n\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\tindicator: 'red',\r\n\t\t\t\t\tmessage: \"Selected Quantity exceeded Total Quantity :\"+$('.combo-total-qty').val()\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\ttot=(isNaN(tot)?0:parseInt(tot))+1;\r\n\t\t\t\tvar flag=0;\t\t\r\n\t\t\t\tcur_pos.combo_item_details.combo_items.forEach(item => {\t\t\t\t\r\n\t\t\t\tif(item.item_code==decodeURI(btn.attr('data-item-code')))\r\n\t\t\t\t{\r\n\t\t\t\t\titem.packed_quantity=newVal;flag=1;\r\n\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tif(flag==0){\r\n\t\t\t\t\r\n\t\t\t\t\tvar cur_item={};\r\n\t\t\t\t\tvar item_code=String(btn.attr(\"data-item-code\"));\r\n\t\t\t\t\tcur_item.item_code=decodeURI(item_code)\r\n                    cur_item.parent_item=cur_pos.combo_item_details.current_item.item_code\r\n\t\t\t\t\tcur_item.packed_quantity=newVal\r\n\t\t\t\t\tcur_item.set_no=btn.attr(\"data-set-no\")\r\n\t\t\t\t\tcur_item.combo_qty=btn.attr(\"data-qty\")\r\n\t\t\t\t\tcur_item.default_item_in_pos=0\r\n\t\t\t\t\tcur_pos.combo_item_details.combo_items.push(cur_item)\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t} else {\r\n            if(parseInt($('.combo-total-qty').val())<0){\r\n                newVal = parseInt(oldValue) - 1;\r\n\t\t\t\ttot=(isNaN(tot)?0:parseInt(tot))-1;\r\n\t\t\t\tvar flag=0;\t\t\r\n\t\t\t\tcur_pos.combo_item_details.combo_items.forEach(item => {\t\t\t\t\r\n\t\t\t\tif(item.item_code==decodeURI(btn.attr('data-item-code')))\r\n\t\t\t\t{\r\n\t\t\t\t\titem.packed_quantity=newVal;flag=1;\r\n\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tif(flag==0){\r\n\t\t\t\t\r\n\t\t\t\t\tvar cur_item={};\r\n\t\t\t\t\tvar item_code=String(btn.attr(\"data-item-code\"));\r\n\t\t\t\t\tcur_item.item_code=decodeURI(item_code)\r\n\t\t\t\t\tcur_item.parent_item=cur_pos.combo_item_details.current_item.item_code\r\n\t\t\t\t\tcur_item.packed_quantity=newVal\r\n\t\t\t\t\tcur_item.set_no=btn.attr(\"data-set-no\")\r\n\t\t\t\t\tcur_item.combo_qty=btn.attr(\"data-qty\")\r\n\t\t\t\t\tcur_item.default_item_in_pos=0\r\n\t\t\t\t\tcur_pos.combo_item_details.combo_items.push(cur_item)\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n            }\r\n            else{\r\n                if(oldValue>=1){\r\n                    newVal = parseInt(oldValue) - 1;\r\n                    tot=(isNaN(tot)?0:parseInt(tot))-1;\r\n                    var flag=0;\t\t\r\n                    cur_pos.combo_item_details.combo_items.forEach(item => {\t\t\t\t\r\n                    if(item.item_code==decodeURI(btn.attr('data-item-code')))\r\n                    {\r\n                        item.packed_quantity=newVal;flag=1;\r\n                    }\r\n                    })\r\n                    if(flag==0){\r\n                    \r\n                        var cur_item={};\r\n                        var item_code=String(btn.attr(\"data-item-code\"));\r\n                        cur_item.item_code=decodeURI(item_code)\r\n                        cur_item.parent_item=cur_pos.combo_item_details.current_item.item_code\r\n                        cur_item.packed_quantity=newVal\r\n                        cur_item.set_no=btn.attr(\"data-set-no\")\r\n                        cur_item.combo_qty=btn.attr(\"data-qty\")\r\n                        cur_item.default_item_in_pos=0\r\n                        cur_pos.combo_item_details.combo_items.push(cur_item)\r\n                        \r\n                    }\r\n                }\r\n            }\r\n\t\t\t\r\n\r\n\t\t\t\r\n\t\t}\r\n\t\tinput.val(newVal);\r\n\t\t$(elmnt).closest('table').find('tfoot th:eq(1)').text(tot)\r\n\t\t\r\n\t\r\n  }\r\n  function changetotqty(elmnt) { \r\n\t\tcur_pos.combo_item_details.combo_items.forEach(item => {\t\t\t\t\r\n\t\t\tif(item.default_item_in_pos==1)\r\n\t\t\t{\r\n\t\t\t\titem.item_qty=$('.combo-total-qty').val();\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tif(item.item_qty>$('.combo-total-qty').val())\r\n\t\t\t\t{\r\n\t\t\t\t\t\r\n\t\t\t\t\tfrappe.show_alert({\r\n\t\t\t\t\t\tindicator: 'red',\r\n\t\t\t\t\t\tmessage: \"Selected Quantity exceeded Total Quantity :\"+$('.combo-total-qty').val()\r\n\t\t\t});\r\n\t\t\t$('.combo-total-qty').val(0)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t})\r\n\t\t\r\n\t}\r\n</script>`\r\n\r\n\r\n\r\n\t\t\r\n\treturn sethtml;\t\r\n\t}\r\n}\r\n\t\r\n\t\r\n  \r\n\r\n\r\n\r\n\t\r\n\t"],"names":["onScan","module","attachTo","oDomElement","oOptions","undefined","scannerDetectionData","Error","oDefaults","sScanned","iQty","onScanError","oDebug","onKeyProcess","sChar","oEvent","onKeyDetect","iKeyCode","onPaste","sPasted","keyCodeMapper","decodeKeyEvent","onScanButtonLongPress","scanButtonKeyCode","scanButtonLongPressTime","timeBeforeScanTest","avgTimeByChar","minLength","suffixKeyCodes","prefixKeyCodes","ignoreIfFocusOn","stopPropagation","preventDefault","captureEvents","reactToKeydown","reactToPaste","singleScanQty","this","_mergeOptions","options","vars","firstCharTime","lastCharTime","accumulatedString","testTimer","longPressTimeStart","longPressed","addEventListener","_handlePaste","_handleKeyUp","_handleKeyDown","detachFrom","removeEventListener","getOptions","setOptions","_reinitialize","iCode","_getNormalizedKeyNum","key","sDecoded","String","fromCharCode","shiftKey","toLowerCase","toUpperCase","simulate","mStringOrArray","Array","isArray","forEach","mKey","oEventProps","keyCode","parseInt","KeyboardEvent","document","dispatchEvent","_validateScanCode","oVars","_isFocusOnIgnoredElement","ignoreSelectors","oFocused","activeElement","i","length","matches","sScanCode","oScannerData","iSingleScanQty","iFirstCharTime","iLastCharTime","oScanError","message","call","CustomEvent","detail","scanCode","qty","scanDuration","prop","oExtended","Object","prototype","hasOwnProperty","e","which","bScanFinished","indexOf","stopImmediatePropagation","character","Date","now","clearTimeout","setTimeout","longPressTimer","sPasteString","event","clipboardData","window","getData","isScanInProgressFor","isAttachedTo","erpnext","PointOfSale","ItemSelector","[object Object]","ref","wrapper","events","pos_profile","hide_images","settings","auto_add_item","auto_add_item_to_cart","minimum_sales_quantity","maximum_sales_quantity","bundle_item","inti_component","prepare_dom","make_search_bar","load_items_data","bind_events","attach_shortcuts","get_item_group","append","$component","find","$items_container","css","padding","padding-left","padding-bottom","margin","width","align-self","search_item_group","font-size","max-height","item_group","const","res","frappe","db","get_value","lft","is_group","parent_item_group","name","price_list","selling_price_list","get_items","then","render_item_list","items","pagination","doc","get_frm","method","freeze","args","start","page_length","search_value","html","item","item_html","get_item_html","me","warehouse_reorder_level","indicator_color_","actual_qty","indicator_color","qty_to_display","Math","round","toFixed","background-color","escape","item_code","serial_no","batch_no","stock_uom","price_list_rate","item_image","get_abbr","item_name","ellipsis","format_currency","currency","grid-column","search_field","ui","form","make_control","df","label","__","fieldtype","placeholder","parent","render_input","item_group_field","onchange","value","filter_items","get_query","query","filters","$","$input","val","trigger","sScancode","is","set_focus","set_search_value","barcode_scanned","on","$item","unescape","attr","uom","rate","cur_pos","item_selector","console","log","bundle_item_selected","field","cur_frm","cart","update_item_html","item_selected","last_search","search_term","target","ctrl_label","utils","is_mac","keys","add_shortcut","shortcut","action","condition","description","ignore_inputs","page","cur_page","click","play_sound","show_alert","indicator","search_index","add_filtered_item_to_cart","barcode","minimize","item_sub_groups","show","display","r","item_groups","dropdown_html","get_sorted_item_groups","map","join","combo_item_details","throw","set_value","item_details","close_item_details","show_sub_group","get_item_sub_group","get_sorted_item_sub_groups","classname","$subgroup","list","filtered","filter","hero","item_sub_group_dict","each","data","rgt","sort","a","b","empty","hide","pageCount","ceil","size","container_list","first","addClass","showPage","row_idx","text","_row","eq","scroll_to","index","height","animate","scrollTop","page_idx","removeClass","hasClass","pre_idx","next_idx","page_link_len","text-decoration","border","color","transition","border-top-left-radius","border-bottom-left-radius","border-top-right-radius","border-bottom-right-radius","ItemCart","customer_info","location_info","so_info","non_sharable_slot","allowed_customer_groups","customer_groups","allow_rate_change","allow_discount_change","disremark","init_component","check_minimum_sales_qty","custom_change_call","old_val_set","init_child_components","set_css","sosearch_field","toggle_label","init_customer_selector","init_cart_components","init_sosearch","$customer_section","$location_fields_container","grid-template-columns","margin-top","-moz-column-gap","column-gap","row-gap","padding-right","make_customer_selector","frm","customer_field","$cart_container","make_cart_totals_section","make_cart_items_section","make_cart_numpad","$cart_header","$cart_items_wrapper","$abs_cart_container","$net_total_container","$grand_total_container","$cart_totals_section","make_no_items_placeholder","$totals_section","get_discount_icon","$add_discount_elem","justify-content","validate_approver","$numpad_section","number_pad","NumberPad","numpad_event","on_numpad_event","bind","cols","css_classes","fieldnames_map","Quantity","Discount","prepend","reset_customer_selector","toggle_customer_info","closest","toggle_item_highlight","item_is_selected","$cart_item","free_item","current_item","$btn","flt","is_return","new_item_code","cart_combo_item_clicked","cart_item_clicked","numpad_value","qtyvalue","item_selected_desc","get_cart_item","title","checkout","toggle_checkout_btn","edit_cart","can_edit_discount","discount_field","show_discount_control","get_so_detail","update_totals_section","pos_status","customer","res1","delivery_date","datetime","nowdate","model","doctype","load_invoice","brand","city","branch","department","location_so_field","location_visitdate_field","render_location_fields","get_positems","pos_details","rfid","async","callback","sales_order","pos_invoice","creation","c","postime","setHours","getHours","getTime","selected_item","let","btn","shortcut_key","scrub","fieldname","fieldnames","shortcut_label","split","to_title_case","replace","row","item_cart_visible","checkout_btn_invisible","item_is_highlighted","not","allowed_customer_group","customer_group","dom","script_manager","run_serially","fetch_customer_details","customer_details_updated","update_customer_section","unfreeze","fetch_location_details","select_event","resultlist","slotlist","is_new","entries","push","Promise","resolve","loyalty_program","silent","exc","loyalty_points","conversion_factor","item_list_data","sorder","allocated_amount","child","add_child","refresh_field","visit_date","slot","input_class","is_approved","hide_discount_control","additional_discount_percentage","remarks","discount","disc_perc","bold","remark","base_total","discount_approval_required","align-items","border-radius","font-weight","cursor","get_customer_image","email_id","mobile_no","image","render_discount","render_net_total","net_total","grand_total","cint","sys_defaults","disable_rounded_total","rounded_total","render_grand_total","taxes","t","render_taxes","total_taxes_and_charges","discount_remark","taxes_html","test","item_row","parent_item_row","is_free_item","remove_item","next","remove","no_items","get_item_from_frm","render_cart_item","no_of_cart_items","highlight_checkout_btn","update_empty_cart_section","removnuom","convfactore_item","item_rowp","item_data","$item_to_update","get_rate_discount_html","assign","amount","get_description_html","error","get_item_image_html","rate_cols","from","max_width","reduce","elm","set_dynamic_rate_header_width","scroll_to_item","offset","top","selector","show_checkout","toggle","$no_item_element","current_action","action_is_field_edit","includes","action_is_allowed","action_is_pressed_twice","prev_action","first_click_event","field_to_edit_changed","slice","highlight_numpad_btn","curr_action","curr_action_is_highlighted","curr_action_is_action","reset_numpad","padding-top","open","render_customer_fields","fetch_customer_transactions","$customer_form","dfs","read_only","handle_customer_field_change","current_value","current_customer","customer_mobile_no_field","input","readOnly","soquery","default","handle_location_field_change","so","__islocal","visitdate","docstatus","get_list","fields","limit","transaction_container","elapsed_time","moment","posting_date","posting_time","fromNow","invoice","posting_datetime","format","Paid","Draft","Return","Consolidated","status","toggle_component","tbl","seleceted_packed_items","packed_quantity","return_against","parent_item","set_no","itr","quantity","abs","combo_qty","refresh","location_event_slot_field","clear_doc","update_cart_html","catch","get_so_pos_items","coupon_code","update_discount_so","discount_amount","packed_list_data","so_item_selected","save_draft_invoice","dialog","Dialog","reqd","primary_action","appuser","apppassword","approve_discount","primary_action_label","$wrapper","update_discount_approval","ItemDetails","$item_name","$item_description","$item_price","$item_image","$form_container","$dicount_section","item_code_is_same","batch_is_same","uom_is_same","item_has_changed","toggle_item_selector","item_meta","get_meta","render_dom","render_discount_dom","render_form","validate_serial_batch_item","serialized","has_serial_no","batched","has_batch_no","no_serial_selected","no_batch_selected","remove_item_from_cart","substr","discount_percentage","fields_to_display","get_form_fields","style","idx","field_meta","form_updated","make_auto_serial_selection_btn","bind_custom_control_change_event","rate_control","get_doc","discount_percentage_control","serial_no_control","auto_update_batch_no","batch_no_control","warehouse","set_value_in_current_cart_item","uom_control","conversion_factor_control","field_control","newuom","convfac","uomvalu","change","itemcode","is_stock_item","selected_serial_nos","s","batch_serial_map","acc","batch_serial_nos","serial_nos_belongs_to_other_batch","qty_control","clone_new_batch_item_in_frm","bind_auto_serial_fetch_event","bind_fields_to_numpad_fields","last_field_focused","item_field_focused","expiry_date","numbers","warehouse_control","batch_nos","for_doctype","auto_fetched_serial_numbers","records_length","msgprint","a2","number","j","Payment","initialize_numpad","$payment_modes","$totals","$numpad","$invoice_fields_section","overflow-y","invoice_fields","$invoice_fields","df_events","paid_amount","applied_coupen","has_handlers","docname","update_coupen_section","on_numpad_clicked","button_value","selected_mode","get","focus","mode_clicked","scrollLeft","left","mode","auto_set_remaining_amount","contact","contact_mobile","request_button","request_for_payment_field","setup_listener_for_payments","customer_name","total_advance","income_account","company","get_field","grid","grid_rows","tbl_itm","payments","m","advance","submit_invoice","combo_items","combo_default_items","total_packed_qty","is_cash_shortcuts_invisible","attach_cash_shortcuts","formatted_currency","loyalty_amount","cdt","cdn","default_mop","locals","mode_of_payment","realtime","success","reload_doc","failure_message","remaining_amount","payment_is_visible","active_mode","mode_of_payments","mode_index","next_mode_index","next_mode_to_be_clicked","render_payment_mode_dom","make_invoice_fields_control","toggle_other_sections","render_payment_section","$remarks","p","payment_type","type","render_loyalty_points_payment_mode","shortcuts","get_cash_shortcuts","shortcuts_html","after","steps","digits","x","finalArr","nearest_x","get_nearest","get_customer_details","max_redeemable_amount","precision","children","redeem_loyalty_points","remaining","change_amount","PastOrderList","make_filter_section","$invoices_container","refresh_list","status_field","invoice_name","open_invoice_data","reset_summary","response","invoice_html","get_invoice_html","PastOrderSummary","sendinvoicesms","posinvoice","init_email_print_dialog","$summary_wrapper","$summary_container","$upper_section","$totals_container","$payment_container","$summary_btns","email_dialog","send_email","print_dialog","print_receipt","in_list","tax_amount_after_discount_amount","payment","process_return","edit_order","delete_order","show_summary_placeholder","new_order","fields_dict","customer_email","make_dialog","voucher","get_new_doc","set_route","show_header","print","pos_print_format","letter_head","language","boot","lang","recipients","get_values","print_format","subject","meta","sender_full_name","user","full_name","_lang","escape_html","visible_btns","class_name","last","posinvoice_name","getElementsByClassName","send_invoice_sms","static","toString","disabled","after_submission","toggle_summary_placeholder","attach_document_info","attach_items_info","attach_totals_info","attach_payments_info","condition_btns_map","get_condition_btn_map","add_summary_btns","upper_section_dom","get_upper_section_html","item_dom","payment_dom","get_payment_html","net_total_dom","get_net_total_html","taxes_dom","get_taxes_html","discount_dom","get_discount_html","grand_total_dom","get_grand_total_html","Controller","check_opening_entry","hide_header","session","fetch_opening_entry","prepare_app_defaults","create_opening_voucher","table_fields","in_list_view","closing_details","some","d","closing_amount","cannot_add_rows","in_place_edit","pos_opening_entry","pos_opening","cash_closing_amont","period_end_date","now_datetime","now_date","pay","balance_details","opening_amount","defaults","get_default","pos_profile_query","pos_opening_time","period_start_date","item_stock_map","allow_negative_stock","profile","group","make_app","set_title_sub","prepare_components","prepare_menu","make_new_invoice","$components_wrapper","init_item_selector","init_item_details","init_item_cart","init_payments","init_recent_order_list","init_order_summary","init_combo_item_details","clear_menu","add_menu_item","open_home","open_form_view","toggle_recent_order","close_pos","issue_rfid","sync","recent_order_list","toggle_recent_order_list","save","update_POS","create_closing_voucher","update_discount","on_cart_update","on_bundle_cart_update","on_cart_update_desc","on_cart_update_from_so","parseFloat","toggle_item_details_section","toggle_combo_item_details_section","update_item_field","details","customer_details","resize_selector","toggle_numpad","toggle_numpad_field_edit","update_selector_value_in_cart_item","batch","item_to_clone","new_row","get_item_stock_map","get_available_stock","ComboItemDetails","toggle_combo_item_selector","combo_numpad_event","update_combo_item_field","close_combo_item_details","update_Item","savesubmit","toggle_components","order_summary","load_summary_of","make_return_invoice","delete_doc","make_sales_invoice_frm","set_pos_profile_data","set_pos_profile_status","get_new_frm","is_pos","with_doctype","_frm","Form","make_new_doc_and_get_name","source_name","target_doc","set_indicator","item_selected_from_selector","qty_needed","check_stock_availability","set_warehouse","is_current_item_being_edited","check_serial_no_availablilty","trigger_new_item_events_so","check_serial_batch_selection_needed","edit_item_details_of","item_rownew","edit_combo_item_details_of","is_current_combo_item_being_edited","trigger_new_item_events","nuom","convfactor","available_qty","bold_item_code","bold_warehouse","bold_available_qty","field_or_action","remove_item_from_combo_cart","citem","combodoctype","comboname","location_event_field","location_brand_field","location_city_field","location_branch_field","location_department_field","set_items","$default_items_container","make_combo_numpad","load_combo_items_data","setno_wise_qty","check_item_set","set","settotal","rm","set_total","flag","check_set_total","accumulator","current","totqty","check_item","update_selected_pack_item","comboitem","cur_item","default_item_in_pos","combo_item_row","get_combo_item_from_frm","ditems","sets","set_html","set_dhtml","get_combo_item_html","sethtml"],"mappings":"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"}